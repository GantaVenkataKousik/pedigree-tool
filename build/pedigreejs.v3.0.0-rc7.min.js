var pedigreejs=function(e){"use strict";let t=25,n={};function a(e){try{if("array"===e.store_type)return!1;if("local"!==e.store_type&&"session"!==e.store_type&&void 0!==e.store_type)return!1;let t="test";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(e){return!1}}function r(e){return"PEDIGREE_"+e.btn_target+"_"}function i(e){return n[r(e)]}function l(e,t){return"local"===e.store_type?localStorage.getItem(t):sessionStorage.getItem(t)}function o(e,t,n){return"local"===e.store_type?localStorage.setItem(t,n):sessionStorage.setItem(t,n)}function s(e){let t=r(e),n="local"===e.store_type?localStorage:sessionStorage,a=[];for(let e=0;e<n.length;e++)0===n.key(e).indexOf(t)&&a.push(n.key(e));for(let e=0;e<a.length;e++)n.removeItem(a[e])}function d(e){let t;return t=a(e)?l(e,r(e)+"COUNT"):n[r(e)+"COUNT"],null!=t?t:0}function c(e,t){a(e)?o(e,r(e)+"COUNT",t):n[r(e)+"COUNT"]=t}function h(e){if(!e.dataset)return;let l=d(e);a(e)?o(e,r(e)+l,JSON.stringify(e.dataset)):(console.warn("Local storage not found/supported for this browser!",e.store_type),t=500,void 0===i(e)&&(n[r(e)]=[]),i(e).push(JSON.stringify(e.dataset))),l<t?l++:l=0,c(e,l)}function u(e){if(!a(e))return i(e)&&i(e).length>0?i(e).length:-1;for(let n=t;n>0;n--)if(null!==l(e,r(e)+(n-1)))return n;return-1}function p(e){let n=d(e)-1;return-1===n&&(n=t),a(e)?JSON.parse(l(e,r(e)+n)):i(e)?JSON.parse(i(e)[n]):void 0}function f(e,n){if(void 0===n&&(n=d(e)-2),n<0){let a=u(e);n=a<t?a-1:t-1}return c(e,n+1),a(e)?JSON.parse(l(e,r(e)+n)):JSON.parse(i(e)[n])}function m(e,n){return void 0===n&&(n=d(e)),n>=t&&(n=0),c(e,parseInt(n)+1),a(e)?JSON.parse(l(e,r(e)+n)):JSON.parse(i(e)[n])}function g(e){a(e)&&function(e){"local"===e.store_type?localStorage.clear():sessionStorage.clear()}(e),n={}}function _(e,t,n,i){if(a(e)){let a="local"===e.store_type?localStorage:sessionStorage;t?(o(e,r(e)+"_X",t),o(e,r(e)+"_Y",n)):(a.removeItem(r(e)+"_X"),a.removeItem(r(e)+"_Y"));let l=r(e)+"_ZOOM";i?o(e,l,i):a.removeItem(l)}}function y(e){if(!a(e)||null===localStorage.getItem(r(e)+"_X")&&null===sessionStorage.getItem(r(e)+"_X"))return[null,null];let t=[parseInt(l(e,r(e)+"_X")),parseInt(l(e,r(e)+"_Y"))];return null!==l(e,r(e)+"_ZOOM")&&t.push(parseFloat(l(e,r(e)+"_ZOOM"))),t}var b=Object.freeze({__proto__:null,clear:g,clear_pedigree_data:s,current:p,get_count:d,getposition:y,init_cache:h,last:function(e){if(a(e))for(let n=t;n>0;n--){let t=l(e,r(e)+(n-1));if(null!==t)return c(e,n),JSON.parse(t)}else{let t=i(e);if(t)return JSON.parse(t(t.length-1))}},next:m,nstore:u,previous:f,setposition:_});let x={};function v(){let e=navigator.userAgent;return e.indexOf("MSIE ")>-1||e.indexOf("Trident/")>-1}function w(){return navigator.userAgent.match(/Edge/g)}function z(e){return console.error(e),new Error(e)}function k(e){if(e.validate){if("function"==typeof e.validate)return e.DEBUG&&console.log("CALLING CONFIGURED VALIDATION FUNCTION"),e.validate.call(this,e);let t,n=[],a=[];for(let r=0;r<e.dataset.length;r++){if(!r.hidden&&(e.dataset[r].mother||e.dataset[r].father)){t=e.dataset[r].display_name,t||(t="unnamed"),t+=" (IndivID: "+e.dataset[r].name+")";let n=e.dataset[r].mother,a=e.dataset[r].father;if(!n||!a)throw z("Missing parent for "+t);let i=H(e.dataset,n),l=H(e.dataset,a);if(-1===i)throw z("The mother (IndivID: "+n+") of family member "+t+" is missing from the pedigree.");if(-1===l)throw z("The father (IndivID: "+a+") of family member "+t+" is missing from the pedigree.");if("F"!==e.dataset[i].sex)throw z("The mother of family member "+t+" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.");if("M"!==e.dataset[l].sex)throw z("The father of family member "+t+" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.")}if(!e.dataset[r].name)throw z(t+" has no IndivID.");if($.inArray(e.dataset[r].name,n)>-1)throw z("IndivID for family member "+t+" is not unique.");n.push(e.dataset[r].name),-1===$.inArray(e.dataset[r].famid,a)&&e.dataset[r].famid&&a.push(e.dataset[r].famid)}if(a.length>1)throw z("More than one family found: "+a.join(", ")+".");let r=D(e.dataset);r.length>0&&console.warn("individuals unconnected to pedigree ",r)}}function O(e){e[0].id&&e.sort((function(e,t){return e.id&&t.id?e.id>t.id?1:t.id>e.id?-1:0:0}));let t=["id","parent_node"],n=[];for(let a=0;a<e.length;a++){let r={};for(let n in e[a])-1===t.indexOf(n)&&(r[n]=e[a][n]);n.push(r)}return n}function A(e,t,n,a,r){try{n?$('<div id="msgDialog">'+t+"</div>").dialog({modal:!0,title:e,width:350,buttons:{Yes:function(){$(this).dialog("close"),n(a,r)},No:function(){$(this).dialog("close")}}}):$('<div id="msgDialog">'+t+"</div>").dialog({title:e,width:350,buttons:[{text:"OK",click:function(){$(this).dialog("close")}}]})}catch(i){!function(e,t,n,a,r){const i=document.getElementById("errModal"),l=i.querySelector(".modal-title"),o=i.querySelector(".modal-body");if(n)$("#errModal button.hidden").removeClass("hidden"),$('#errModal button:contains("OK")').on("click",(function(){n(a,r),$('#errModal button:contains("OK")').off("click")}));else{const e=$('#errModal button:contains("CANCEL")');e.hasClass("hidden")||e.addClass("hidden"),$('#errModal button:contains("OK")').off("click")}l.textContent=e,o.textContent=t,$("#errModal").modal("show")}(e,t,n,a,r)}}function E(e){let t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(let a=0;a<e;a++)t+=n.charAt(Math.floor(52*Math.random()));return t}function F(e,t,n,a,r){if("parent_node"in e?e.parent_node.push(t):e.parent_node=[t],e.mztwin||e.dztwins){let t=U(r.dataset,e);for(let e=0;e<t.length;e++){let r=K(a,t[e].name);r&&(r.id=n++)}}return n}function N(e,t){return e.sort((function(e,t){return e.mztwin&&t.mztwin&&e.mztwin===t.mztwin||e.dztwin&&t.dztwin&&e.dztwin===t.dztwin?0:e.mztwin||t.mztwin||e.dztwin||t.dztwin?1:0})),$.each(e,(function(e,n){void 0===n.id&&(n.id=t++)})),t}function I(e){return void 0!==$(e).attr("proband")&&!1!==$(e).attr("proband")}function S(e,t){for(let n=0;n<t.length;n++)-1===$.inArray(t[n],e)&&e.push(t[n])}function C(e,t,n){if(-1===$.inArray(t.name,e))return;S(e,M(n,t));let a=j(n,t);$.each(a,(function(t,a){-1===$.inArray(a.name,e)&&(e.push(a.name),S(e,M(n,a)))}))}function M(e,t){let n=[];for(let a=0;a<e.length;a++){let r=e[a];t.name===r.mother&&-1===$.inArray(r.father,n)?n.push(r.father):t.name===r.father&&-1===$.inArray(r.mother,n)&&n.push(r.mother)}return n}function D(e){let t=e[R(e)];if(!t){if(console.warn("No target defined"),0===e.length)throw new Error("empty pedigree data set");t=e[0]}let n=[t.name],a=!0,r=0;for(;a&&r<200;){r++;let i=n.length;$.each(e,(function(a,r){if(-1!==$.inArray(r.name,n)){let a=M(e,r),i=r.name===t.name||!r.noparents;for(let t=0;t<a.length;t++)K(e,a[t]).noparents||(i=!0);i&&(r.mother&&-1===$.inArray(r.mother,n)&&n.push(r.mother),r.father&&-1===$.inArray(r.father,n)&&n.push(r.father))}else!r.noparents&&(r.mother&&-1!==$.inArray(r.mother,n)||r.father&&-1!==$.inArray(r.father,n))&&n.push(r.name);C(n,r,e)})),a=i!==n.length}let i=$.map(e,(function(e,t){return e.name}));return $.map(i,(function(e,t){return-1===$.inArray(e,n)?e:null}))}function R(e){let t;return $.each(e,(function(e,n){if(I(n))return t=e,t})),t}function T(e,t,n){let a=[],r=[];return"F"===t.sex&&$.each(e,(function(e,i){t.name===i.mother&&(n&&n.name!==i.father||-1===$.inArray(i.name,r)&&(a.push(i),r.push(i.name)))})),a}function U(e,t){let n=P(e,t),a=t.mztwin?"mztwin":"dztwin";return $.map(n,(function(e,n){return e.name!==t.name&&e[a]===t[a]?e:null}))}function P(e,t,n){return void 0===t||!t.mother||t.noparents?[]:$.map(e,(function(e,a){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||n&&e.sex!==n?null:e}))}function L(e,t,n){return $.map(e,(function(e,a){return e.name===t.name||"noparents"in e||!e.mother||e.mother!==t.mother||e.father!==t.father||n&&e.sex!==n?null:e}))}function B(e,t){return $.map(e,(function(e,n){return e.name!==t.name&&"noparents"in e&&e.mother===t.mother&&e.father===t.father?e:null}))}function j(e,t,n){return $.map(e,(function(e,a){return"noparents"in e||e.mother!==t.name&&e.father!==t.name||n&&e.sex!==n?null:e}))}function G(e,t){let n=H(e,t),a=1;for(;n>=0&&("mother"in e[n]||e[n].top_level);)n=H(e,e[n].mother),a++;return a}function H(e,t){let n=-1;return $.each(e,(function(e,a){if(t===a.name)return n=e,n})),n}function q(e,t,n){return $.map(e,(function(e,a){return e.depth!==t||e.data.hidden||-1!==$.inArray(e.data.name,n)?null:e})).sort((function(e,t){return e.x-t.x}))}function Y(e,t){let n=[];return function t(a){a.data&&(a=a.data),"mother"in a&&"father"in a&&!("noparents"in a)&&(t(K(e,a.mother)),t(K(e,a.father))),n.push(a)}(t),n}function J(e){let t=[];return function e(n){n.children&&n.children.forEach(e),t.push(n)}(e),t}function X(e,t,n,a,r){for(let i=0;i<t.length;i++)if(a===t[i].depth&&-1===$.inArray(t[i].data.name,r)&&Math.abs(n-t[i].x)<1.15*e.symbol_size)return!0;return!1}function K(e,t){for(let n=0;n<e.length;n++){if(e[n].data&&t===e[n].data.name)return e[n];if(t===e[n].name)return e[n]}}function V(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function W(e){return{width:V()?window.innerWidth:e.width,height:V()?window.innerHeight:e.height}}var Z=Object.freeze({__proto__:null,adjust_coords:function(e,t,n){function a(r){if(r.children&&(r.children.forEach(a),void 0!==r.data.father)){let a=K(n,r.data.father.name),i=K(n,r.data.mother.name),l=(a.x+i.x)/2;if(X(e,t.descendants(),l,r.depth,[r.data.name]))(r.x<a.x&&r.x<i.x||r.x>a.x&&r.x>i.x)&&(r.x=l);else{r.x=l;let n=r.x-l;if(2===r.children.length&&(r.children[0].data.hidden||r.children[1].data.hidden)){if(!r.children[0].data.hidden||!r.children[1].data.hidden){let n=r.children[0].data.hidden?r.children[1]:r.children[0],a=r.children[0].data.hidden?r.children[0]:r.children[1];(n.x<a.x&&l<a.x||n.x>a.x&&l>a.x)&&!X(e,t.descendants(),l,n.depth,[n.data.name])&&(n.x=l)}}else if(1!==r.children.length||r.children[0].data.hidden){if(0!==n&&!function(e,t,n,a){let r=t.descendants(),i=$.map(r,(function(e,t){return e.data.name})),l=a.descendants();for(let a=0;a<r.length;a++){let o=r[a];if(t.data.name!==o.data.name){if(X(e,l,o.x-n,o.depth,i))return!0}}return!1}(e,r,n,t))if(1===r.children.length)r.children[0].x=l;else{let t=r.descendants();e.DEBUG&&console.log("ADJUSTING "+r.data.name+" NO. DESCENDANTS "+t.length+" diff="+n);for(let e=0;e<t.length;e++)r.data.name!==t[e].data.name&&(t[e].x-=n)}}else X(e,t.descendants(),l,r.children[0].depth,[r.children[0].data.name])||(r.children[0].x=l)}}}a(t),a(t)},ancestors:Y,buildTree:function e(t,n,a,r,i){void 0===n.children&&(n.children=T(t.dataset,n)),void 0===r&&(r=[],i=1);let l=J(a),o=[];return $.each(n.children,(function(e,n){$.each(t.dataset,(function(e,a){if((n.name===a.mother||n.name===a.father)&&void 0===n.id){let e=K(l,a.mother),n=K(l,a.father);e=void 0!==e?e:K(t.dataset,a.mother),n=void 0!==n?n:K(t.dataset,a.father),function(e,t,n){for(let a=0;a<e.length;a++)if(e[a].mother===t&&e[a].father===n)return!0;return!1}(o,e,n)||o.push({mother:e,father:n})}}))})),$.merge(r,o),$.each(o,(function(e,a){let r=a.mother,o=a.father;r.children=[];let s={name:E(4),hidden:!0,parent:null,father:o,mother:r,children:T(t.dataset,r,o)},d=H(t.dataset,r.name),c=H(t.dataset,o.name);"id"in o||"id"in r||(i=N(n.children,i));let h=function(e,t,n){let a=t,r=n;for(;"mother"in e[a]&&"mother"in e[r]&&!("noparents"in e[a])&&!("noparents"in e[r]);)a=H(e,e[a].mother),r=H(e,e[r].mother);return{midx:a,fidx:r}}(t.dataset,d,c);h.fidx<h.midx?(o.id=i++,s.id=i++,r.id=i++):(r.id=i++,s.id=i++,o.id=i++),i=F(r,s,i,l,t),i=F(o,s,i,l,t),n.children.push(s)})),i=N(n.children,i),$.each(n.children,(function(n,l){i=e(t,l,a,r,i)[1]})),[r,i]},capitaliseFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},consanguity:function(e,t,n){if(e.depth!==t.depth)return!0;let a=Y(n.dataset,e),r=Y(n.dataset,t),i=$.map(a,(function(e,t){return e.name})),l=$.map(r,(function(e,t){return e.name})),o=!1;return $.each(i,(function(e,t){if(-1!==$.inArray(t,l))return o=!0,!1})),o},copy_dataset:O,create_err:z,exists:function(e,t){return void 0!==K(p(e),t)},flatten:J,getAdoptedSiblings:B,getAllChildren:j,getAllSiblings:L,getChildren:T,getDepth:G,getFormattedDate:function(e){let t=new Date;return e?("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2):t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)},getIdxByName:H,getNodeByName:K,getNodesAtDepth:q,getProbandIndex:R,getSiblings:P,getTwins:U,get_partners:M,get_svg_dimensions:W,get_tree_dimensions:function(e){let t=W(e),n=0,a={};for(let t=0;t<e.dataset.length;t++){let r=G(e.dataset,e.dataset[t].name),i=j(e.dataset,e.dataset[t]),l=1+(i.length>0?.55+.25*i.length:0)+(e.dataset[t].father?.25:0);r in a?a[r]+=l:a[r]=l,a[r]>n&&(n=a[r])}let r=Object.keys(a).length*e.symbol_size*3.5;return{width:t.width-e.symbol_size>n*e.symbol_size*1.65?t.width-e.symbol_size:n*e.symbol_size*1.65,height:t.height-e.symbol_size>r?t.height-e.symbol_size:r}},isEdge:w,isIE:v,isProband:I,is_fullscreen:V,linkNodes:function(e,t){let n=[];for(let a=0;a<t.length;a++)n.push({mother:K(e,t[a].mother.name),father:K(e,t[a].father.name)});return n},makeid:E,messages:A,overlap:X,prefixInObj:function(e,t){let n=!1;return t&&$.each(t,(function(t,a){if(0===t.indexOf(e+"_")||t===e)return n=!0,n})),n},print_opts:function(e){let t;$("#pedigree_data").remove(),$("body").append("<div id='pedigree_data'></div>");for(let n=0;n<e.dataset.length;n++){let a="<div class='row'><strong class='col-md-1 text-right'>"+e.dataset[n].name+"</strong><div class='col-md-11'>";for(t in e.dataset[n])"name"!==t&&("parent"===t?a+="<span>"+t+":"+e.dataset[n][t].name+"; </span>":"children"===t?void 0!==e.dataset[n][t][0]&&(a+="<span>"+t+":"+e.dataset[n][t][0].name+"; </span>"):a+="<span>"+t+":"+e.dataset[n][t]+"; </span>");$("#pedigree_data").append(a+"</div></div>")}for(t in $("#pedigree_data").append("<br /><br />"),e)"dataset"!==t&&$("#pedigree_data").append("<span>"+t+":"+e[t]+"; </span>")},roots:x,setProband:function(e,t,n){$.each(e,(function(e,a){t===a.name?a.proband=n:delete a.proband}))},unconnected:D,urlParam:function(e){let t=new RegExp("[?&]"+e+"=([^&#]*)").exec(window.location.href);return null===t?null:t[1]||0},validate_age_yob:function(e,t,n){let a=(new Date).getFullYear(),r=parseInt(e)+parseInt(t);return("1"===n||"0"===n)&&(("1"===n||Math.abs(a-r)<=1)&&a>=r)},validate_pedigree:k});let Q;function ee(e,t){d3.select("#"+e.targetDiv).select("svg").transition().duration(50).call(Q.scaleBy,t)}function te(e){let t=function(e){let t=ne(e);return{wid:Math.abs(t.xmax-t.xmin),hgt:Math.abs(t.ymax-t.ymin)}}(e),n=d3.select("#"+e.targetDiv).select("svg"),a=function(e){return{w:e.node().clientWidth,h:e.node().clientHeight}}(n),r=1/Math.max(t.wid/a.w,t.hgt/a.h);r<e.zoomIn&&Q.scaleExtent([r,e.zoomOut]);let i=function(e){let t=ne(e);return{x:t.xmin+(t.xmax-t.xmin)/2,y:t.ymin+(t.ymax-t.ymin)/2}}(e);n.call(Q.translateTo,i.x-e.symbol_size,i.y-e.symbol_size),setTimeout((function(){n.transition().duration(700).call(Q.scaleTo,r)}),400)}function ne(e){let t=d3.select("#"+e.targetDiv).select(".diagram"),n=Number.MAX_VALUE,a=-1e6,r=Number.MAX_VALUE,i=-1e6,l=e.symbol_size;return t.selectAll("g").each((function(t,o){if(t.x&&"hidden_root"!==t.data.name&&!t.data.hidden){let o=function(e,t,n){let a=d3.select(t).node().getBBox(),r=a.width,i=a.height;if(0===r&&0===i)try{r=2*n,i=2*n;let a=d3.select(t).selectAll(".indi_details");for(let t=0;t<a._groups[0].length;t++){let l=ae(a._groups[0][t].firstChild.nodeValue,e.font_family,e.font_size);r=Math.max(l.w+n/2,r),i=Math.max(2*n+t*l.h,i)}}catch(e){console.error(e),r=2*n,i=2*n}return{w:r,h:i}}(e,this,l);t.x-l<n&&(n=t.x-l),t.x+o.w+l>a&&(a=t.x+o.w+l),t.y<r&&(r=t.y),t.y+o.h+l>i&&(i=t.y+o.h+l)}})),{xmin:n,xmax:a,ymin:r,ymax:i}}function ae(e,t,n){let a=$("<div></div>").text(e).css({position:"absolute",float:"left","white-space":"nowrap",visibility:"hidden",font:t||"Helvetica",fontSize:n||"1em"}).appendTo($("body")),r={w:a.width(),h:a.height()};return a.remove(),r}var re=Object.freeze({__proto__:null,btn_zoom:ee,get_bounds:ne,init_zoom:function(e,t){let n=e.symbol_size/2,a=2.5*-e.symbol_size;Q=d3.zoom().scaleExtent([e.zoomIn,e.zoomOut]).filter((function(t){return!((!e.zoomSrc||-1===e.zoomSrc.indexOf("wheel"))&&t.type&&"wheel"===t.type)&&("dblclick"!==t.type&&!t.button)})).on("zoom",(function(t){!function(e,t){t.DEBUG&&console.log("zoom",e.transform);let n=e.transform,a=n.k&&1!==n.k?n.k:void 0;_(t,n.x,n.y,a);let r=d3.select("#"+t.targetDiv).select(".diagram");r.attr("transform","translate("+n.x+","+n.y+")"+(a?" scale("+a+")":""))}(t,e)})),t.call(Q);let r=y(e),i=3===r.length?r[2]:1,l=null!==r[0]?r[0]/i:n*i,o=null!==r[1]?r[1]/i:a*i;var s=d3.zoomIdentity.scale(i).translate(l,o);t.call(Q.transform,s)},scale_to_fit:te});function ie(e){let t=$.extend({btn_target:"pedigree_history"},e),n=[{fa:"fa-file-image",title:"download PNG image"},{fa:"fa-undo",title:"undo"},{fa:"fa-redo",title:"redo"},{fa:"fa-refresh",title:"reset"}];n.push({fa:"fa-crosshairs",title:"scale-to-fit"}),t.zoomSrc&&t.zoomSrc.indexOf("button")>-1&&(1!==t.zoomOut&&n.push({fa:"fa-minus-circle",title:"zoom-out"}),1!==t.zoomIn&&n.push({fa:"fa-plus-circle",title:"zoom-in"})),n.push({fa:"fa-arrows-alt",title:"fullscreen"});let a="";for(let e=0;e<n.length;e++)a+="<span>",a+='<i class="fa fa-lg '+n[e].fa+' pe-2" aria-hidden="true" title="'+n[e].title+'"'+("fa-arrows-alt"===n[e].fa?'id="fullscreen" ':"")+"></i>",a+="</span>";$("#"+t.btn_target).append(a),function(e){$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",(function(t){let n=p(e);null!=n&&(e.dataset=n),$(document).trigger("rebuild",[e]),setTimeout((function(){te(e)}),500)})),$("#fullscreen").on("click",(function(t){if(V())document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let t=$("#"+e.targetDiv)[0];t.requestFullscreen?t.requestFullscreen():document.documentElement.mozRequestFullScreen?t.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):document.documentElement.msRequestFullscreen&&t.msRequestFullscreen()}}));let t=0;function n(){ee(e,1.05)}function a(){ee(e,.95)}$(".fa-plus-circle, .fa-minus-circle").on("mousedown",(function(){t=setInterval($(this).hasClass("fa-plus-circle")?n:a,50)})).on("mouseup mouseleave",(function(){clearInterval(t)})),$("#"+e.btn_target).on("click",(function(t){if(t.stopPropagation(),$(t.target).hasClass("disabled"))return!1;if($(t.target).hasClass("fa-undo"))e.dataset=f(e),$("#"+e.targetDiv).empty(),$(document).trigger("build",[e]);else if($(t.target).hasClass("fa-redo"))e.dataset=m(e),$("#"+e.targetDiv).empty(),$(document).trigger("build",[e]);else if($(t.target).hasClass("fa-refresh"))A("Pedigree Reset","This may result in loss of some data. Reset now?",le,e);else if($(t.target).hasClass("fa-crosshairs"))te(e);else if($(t.target).hasClass("fa-file-image"))return;$(document).trigger("fhChange",[e])}))}(t)}function le(e){let t;if(e.keep_proband_on_reset){let n=O(p(e));t=n[R(n)],t.name="ch1",t.mother="f21",t.father="m21",s(e)}else t={name:"ch1",sex:"F",mother:"f21",father:"m21",proband:!0,status:"0",display_name:"me"},g(e);delete e.dataset;let n=$("input[name='default_fam']:checked");n.length>0&&"extended2"===n.val()?e.dataset=[{name:"wZA",sex:"M",top_level:!0,status:"0",display_name:"paternal grandfather"},{name:"MAk",sex:"F",top_level:!0,status:"0",display_name:"paternal grandmother"},{name:"zwB",sex:"M",top_level:!0,status:"0",display_name:"maternal grandfather"},{name:"dOH",sex:"F",top_level:!0,status:"0",display_name:"maternal grandmother"},{name:"MKg",sex:"F",mother:"MAk",father:"wZA",status:"0",display_name:"paternal aunt"},{name:"xsm",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"paternal uncle"},{name:"m21",sex:"M",mother:"MAk",father:"wZA",status:"0",display_name:"father"},{name:"f21",sex:"F",mother:"dOH",father:"zwB",status:"0",display_name:"mother"},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},t,{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"},{name:"uuc",display_name:"maternal aunt",sex:"F",mother:"dOH",father:"zwB",status:"0"},{name:"xIw",display_name:"maternal uncle",sex:"M",mother:"dOH",father:"zwB",status:"0"}]:n.length>0&&"extended1"===n.val()?e.dataset=[{name:"m21",sex:"M",mother:null,father:null,status:"0",display_name:"father",noparents:!0},{name:"f21",sex:"F",mother:null,father:null,status:"0",display_name:"mother",noparents:!0},{name:"aOH",sex:"F",mother:"f21",father:"m21",status:"0",display_name:"sister"},{name:"Vha",sex:"M",mother:"f21",father:"m21",status:"0",display_name:"brother"},{name:"Spj",sex:"M",mother:"f21",father:"m21",noparents:!0,status:"0",display_name:"partner"},t,{name:"zhk",sex:"F",mother:"ch1",father:"Spj",status:"0",display_name:"daughter"},{name:"Knx",display_name:"son",sex:"M",mother:"ch1",father:"Spj",status:"0"}]:e.dataset=[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},t],$(document).trigger("rebuild",[e])}let oe={breast_cancer:"breast_cancer_diagnosis_age",breast_cancer2:"breast_cancer2_diagnosis_age",ovarian_cancer:"ovarian_cancer_diagnosis_age",prostate_cancer:"prostate_cancer_diagnosis_age",pancreatic_cancer:"pancreatic_cancer_diagnosis_age"},se=["brca1","brca2","palb2","atm","chek2","rad51d","rad51c","brip1"],de=["brca1","brca2","palb2","atm","chek2","bard1","rad51d","rad51c","brip1"],ce=["brca1","brca2","palb2","atm","chek2","bard1","rad51d","rad51c","brip1","hoxb13"],he=["er","pr","her2","ck14","ck56"],ue={};function pe(e){return 0!==$.trim($("#"+e).val()).length}let fe=function(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0};function me(){let e={};return pe("breast_prs_a")&&pe("breast_prs_z")&&(e.breast_cancer_prs={alpha:parseFloat($("#breast_prs_a").val()),zscore:parseFloat($("#breast_prs_z").val()),percent:parseFloat($("#breast_prs_percent").val())}),pe("ovarian_prs_a")&&pe("ovarian_prs_z")&&(e.ovarian_cancer_prs={alpha:parseFloat($("#ovarian_prs_a").val()),zscore:parseFloat($("#ovarian_prs_z").val()),percent:parseFloat($("#ovarian_prs_percent").val())}),pe("prostate_prs_a")&&pe("prostate_prs_z")&&(e.prostate_cancer_prs={alpha:parseFloat($("#prostate_prs_a").val()),zscore:parseFloat($("#prostate_prs_z").val()),percent:parseFloat($("#prostate_prs_percent").val())}),console.log(e),fe(e)?0:e}function ge(e){return 1===(e=parseInt(e))?se:2===e||3===e?de:ce}function _e(e){let t=e.trim().split("\n"),n=[],a=[];const r=/([0-9])/;let i=3,l=ge(i),o=[26,27,27,28];for(let e=0;e<t.length;e++){let s=t[e].trim();if(0===s.indexOf("##")){if(0===s.indexOf("##CanRisk")){const e=s.match(r);if(i=parseInt(e[1]),l=ge(i),console.log("CanRisk File Format version "+i),s.indexOf(";")>-1){let e=s.split(";");for(let t=1;t<e.length;t++){2===e[t].split("=").length&&a.push(e[t])}}}-1===s.indexOf("CanRisk")&&0!==s.indexOf("##FamID")&&a.push(s.replace("##",""));continue}let d=/\t/;s.indexOf("\t")<0&&(d=/\s+/,console.log("NOT TAB DELIM"));let c=$.map(s.split(d),(function(e,t){return e.trim()}));if(c.length>1){if(c.length!==o[i-1])throw console.error(s,c),new Error("Found number of columns "+c.length+"; expected "+o[i-1]+" for CanRisk version "+i);let t={famid:c[0],display_name:c[1],name:c[3],sex:c[6],status:c[8]};"1"===c[2]&&(t.proband=!0),"0"!==c[4]&&(t.father=c[4]),"0"!==c[5]&&(t.mother=c[5]),"0"!==c[7]&&(t.mztwin=c[7]),"0"!==c[9]&&(t.age=c[9]),"0"!==c[10]&&(t.yob=c[10]);let a=11;$.each(oe,(function(e,n){"0"!==c[a]&&(t[n]=c[a]),a++})),"0"!==c[a++]&&(t.ashkenazi=1);for(let n=0;n<l.length;n++){let r=c[a].split(":");"0"!==r[0]?"S"!==r[0]&&"T"!==r[0]||"P"!==r[1]&&"N"!==r[1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[0]+" "+r[1]):t[l[n]+"_gene_test"]={type:r[0],result:r[1]}:"P"!==r[1]&&"N"!==r[1]||(t[l[n]+"_gene_test"]={type:r[0],result:r[1]}),a++}let r=c[a].split(":");for(let n=0;n<r.length;n++)"0"!==r[n]&&("N"===r[n]||"P"===r[n]?t[he[n]+"_bc_pathology"]=r[n]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+he[n]+" "+r[n]));n.unshift(t)}}return n.sort((function(e,t){return void 0!==e.mztwin?e.mztwin.localeCompare(t.mztwin):0})),[a,n]}function ye(e){if(/^(birads|Volpara|Stratus)=/i.test(e))return"\n##"+e;return/^(1|2|3|4|a|b|c|d)$/i.test(e)?"\n##birads="+e:(console.error("Unrecognised mammographic density format :: "+e),"")}function be(e,t,n,a){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0,l="##CanRisk "+(Number.isInteger(r)?r+".0":r.toString());t||(t="XXXX"),n&&(l+=n),void 0===a&&(a=!0);let o=$.map(e,(function(e,t){return"exclude"in e&&e.exclude?e.name:null})),s=R(e),d="F";if(s&&(d=e[s].sex),"M"!==d){let e=xe("menarche_age"),t=xe("parity"),n=xe("age_of_first_live_birth"),a=xe("oral_contraception"),r=xe("mht"),i=xe("bmi"),o=xe("alcohol_intake"),s=xe("age_of_menopause"),d=xe("mammographic_density"),c=xe("height"),h=xe("Age_Tubal_ligation"),u=xe("endometriosis");void 0!==e&&(l+="\n##menarche="+e),void 0!==t&&(l+="\n##parity="+t),void 0!==n&&(l+="\n##first_live_birth="+n),void 0!==a&&(l+="\n##oc_use="+a),void 0!==r&&(l+="\n##mht_use="+r),void 0!==i&&(l+="\n##BMI="+i),void 0!==o&&(l+="\n##alcohol="+o),void 0!==s&&(l+="\n##menopause="+s),void 0!==d&&(l+=ye(d)),void 0!==c&&(l+="\n##height="+c),void 0!==h&&(l+="n"!==h&&"N"!==h?"\n##TL=Y":"\n##TL=N"),void 0!==u&&(l+="\n##endo="+u)}r>2&&void 0!==i&&(l+="\n##ethnicity="+i),l+="\n##FamID\tName\tTarget\tIndivID\tFathID\tMothID\tSex\tMZtwin\tDead\tAge\tYob\tBC1\tBC2\tOC\tPRO\tPAN\tAshkn";let c=ge(r);for(let e=0;e<c.length;e++)l+="\t"+c[e].toUpperCase();l+="\tER:PR:HER2:CK14:CK56";for(let n=0;n<e.length;n++){let r=e[n];if(-1!==$.inArray(r.name,o)){console.log("EXCLUDE: "+r.name);continue}l+="\n"+t+"\t",l+=a?n+"\t":(r.display_name?r.display_name:"NA")+"\t",l+=("proband"in r?"1":0)+"\t",l+=r.name+"\t",l+=("father"in r&&!("noparents"in r)&&-1===$.inArray(r.mother,o)?r.father:0)+"\t",l+=("mother"in r&&!("noparents"in r)&&-1===$.inArray(r.mother,o)?r.mother:0)+"\t",l+=r.sex+"\t",l+=("mztwin"in r?r.mztwin:0)+"\t",l+=("status"in r?r.status:0)+"\t",l+=("age"in r?r.age:0)+"\t",l+=("yob"in r?r.yob:0)+"\t";let i="";$.each(oe,(function(e,t){i+=t in r?(t in r?r[t]:"AU")+"\t":"0\t"})),l+=i,l+=("ashkenazi"in r?r.ashkenazi:0)+"\t";for(let e=0;e<c.length;e++)c[e]+"_gene_test"in r&&"-"!==r[c[e]+"_gene_test"].type&&"-"!==r[c[e]+"_gene_test"].result?(l+=r[c[e]+"_gene_test"].type+":",l+=r[c[e]+"_gene_test"].result+"\t"):l+="0:0\t";for(let e=0;e<he.length;e++)he[e]+"_bc_pathology"in r?(l+=r[he[e]+"_bc_pathology"],console.log("pathology "+r[he[e]+"_bc_pathology"]+" for "+r.display_name)):l+="0",e<he.length-1&&(l+=":")}return console.log(l,ue),l}function xe(e){let t=ve(e);if(t in ue)return ue[t]}function ve(e){return window.location.pathname.split("/").filter((function(e){return!!e})).pop()+"::"+e}var $e=Object.freeze({__proto__:null,cancers:oe,genetic_test1:se,genetic_test2:de,genetic_test4:ce,get_mdensity:ye,get_meta:function(){let e,t=function(){let e="";$("#A6_4_3_check").parent().hasClass("off")||(e+=";OVARY2=y");$("#A6_4_7_check").parent().hasClass("off")||(e+=";MAST2=y");return e}();try{e=me(),e.breast_cancer_prs&&0!==e.breast_cancer_prs.alpha&&0!==e.breast_cancer_prs.zscore&&(t+="\n##PRS_BC=alpha="+e.breast_cancer_prs.alpha+",zscore="+e.breast_cancer_prs.zscore),e.ovarian_cancer_prs&&0!==e.ovarian_cancer_prs.alpha&&0!==e.ovarian_cancer_prs.zscore&&(t+="\n##PRS_OC=alpha="+e.ovarian_cancer_prs.alpha+",zscore="+e.ovarian_cancer_prs.zscore),e.prostate_cancer_prs&&0!==e.prostate_cancer_prs.alpha&&0!==e.prostate_cancer_prs.zscore&&(t+="\n##PRS_PC=alpha="+e.prostate_cancer_prs.alpha+",zscore="+e.prostate_cancer_prs.zscore)}catch(t){console.warn("PRS",e)}return t},get_non_anon_pedigree:function(e,t){return be(e,void 0,t,!1,arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0)},get_pedigree:be,get_prs_values:me,get_risk_factor:xe,hasInput:pe,pathology_tests:he,readCanRisk:_e,remove_risk_factor:function(e){delete ue[ve(e)]},save_risk_factor:function(e,t){ue[ve(e)]=t},show_risk_factor_store:function(){console.log("RISK_FACTOR_STORE::"),$.each(ue,(function(e,t){console.log(e+" : "+t)}))},store_name:ve});function we(e){$("#load").change((function(t){!function(e,t){let n=e.target.files[0];if(n){let e=new FileReader;e.onload=function(e){Ce(e.target.result,t)},e.onerror=function(e){A("File Error","File could not be read! Code "+e.target.error.code)},e.readAsText(n)}else console.error("File could not be read!");$("#load")[0].value=""}(t,e)})),$("#save").click((function(t){!function(e){let t=JSON.stringify(p(e));Ie(e,t)}(e)})),$("#print").click((function(t){Ne(Ee(e))})),$("#svg_download").click((function(t){Fe(Ee(e))})),$("#png_download, .fa-file-image").click((function(t){ke(e,4,"image/png")}))}function ze(e,t){let n=["svg","g"];for(let a=0;a<e.childNodes.length;a++){let r=e.childNodes[a];if(-1===n.indexOf(r.tagName))try{let e=t.childNodes[a].currentStyle||window.getComputedStyle(t.childNodes[a]);if("undefined"===e||null===e)continue;for(let t=0;t<e.length;t++)(e[t].indexOf("text")>-1||e[t].indexOf("font")>-1)&&r.style.setProperty(e[t],e.getPropertyValue(e[t]))}catch(e){continue}else ze(r,t.childNodes[a])}}function ke(e,t,n){let a=Oe($("#"+e.targetDiv).find("svg"),"pedigree",{resolution:t,img_type:n});$.when.apply($,[a]).done((function(){let e=(t=arguments,n="pedigree",$.grep(t,(function(e){return e&&e.name===n}))[0]);var t,n;if(w()||v()){let t="<img src='"+e.img+"' alt='canvas image'/>";window.open().document.write(t)}else{let t=document.createElement("a");t.href=e.img,t.download="plot.png",t.target="_blank",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}))}function Oe(e,t,n){let a={iscanvg:!1,resolution:1,img_type:"image/png"};n||(n=a),$.each(a,(function(e,t){e in n||(n[e]=t)}));let r=e.get(0).cloneNode(!0);ze(r,e.get(0));let i=$.Deferred(),l=(new XMLSerializer).serializeToString(r),o="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(l))),s=document.createElement("canvas");s.width=e.width()*n.resolution,s.height=e.height()*n.resolution;let d=s.getContext("2d");d.fillStyle="white",d.fillRect(0,0,s.width,s.height);let c=document.createElement("img");return c.onload=function(){d.drawImage(c,0,0,s.width,s.height),console.log(t,n.img_type),i.resolve({name:t,resolution:n.resolution,img:s.toDataURL(n.img_type,1),w:s.width,h:s.height}),d.clearRect(0,0,s.width,s.height)},c.src=o,i.promise()}function Ae(e){let t=function(e,t){let n=[],a=0;t.lastIndex=0;let r=t.exec(e);for(;r;){if(a++,a>400)return console.error("getMatches: counter exceeded 800"),-1;n.push(r),t.lastIndex===r.index&&t.lastIndex++,r=t.exec(e)}return n}(e,/url\((&quot;|"|'){0,1}#(.*?)(&quot;|"|'){0,1}\)/g);return-1===t?"ERROR DISPLAYING PEDIGREE":($.each(t,(function(t,n){let a=n[1]?n[1]:"",r=n[2],i='id="'+r+'"',l="url\\("+a+"#"+r+a+"\\)",o=r+E(2);e=(e=e.replace(new RegExp(i,"g"),'id="'+o+'"')).replace(new RegExp(l,"g"),"url(#"+o+")")})),e)}function Ee(e){let t=p(e);null!=t&&(e.dataset=t);let n=$("<div></div>"),a=$("#"+e.targetDiv).find("svg").clone().appendTo(n),r=555,i=792,l=ne(e),o=Math.abs(l.xmax-l.xmin),s=Math.abs(l.ymax-l.ymin),d=1/Math.max(o/r,s/i),c=-(l.xmin-e.symbol_size)*d,h=-(l.ymin-e.symbol_size)*d;return a.attr("width",r),a.attr("height",s*d),a.find(".diagram").attr("transform","translate("+c+", "+h+") scale("+d+")"),n}function Fe(e){let t=document.createElement("a");t.href="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e.html()))),t.download="plot.svg",t.target="_blank",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function Ne(e,t){e.constructor!==Array&&(e=[e]);let n=screen.width,a=screen.height,r=["/static/css/canrisk.css","https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"],i=window.open("","PrintMap","width="+n+",height="+a),l="";for(let e=0;e<r.length;e++)l+='<link href="'+r[e]+'" rel="stylesheet" type="text/css" media="all">';l+="<style>body {font-size: "+$("body").css("font-size")+";}</style>";let o="";for(let n=0;n<e.length;n++)0===n&&t&&(o+=t),o+=$(e[n]).html(),n<e.length-1&&(o+='<div class="page-break"> </div>');i.document.write(l),i.document.write(o),i.document.close(),i.focus(),setTimeout((function(){i.print(),i.close()}),300)}function Ie(e,t,n,a){e.DEBUG&&console.log(t),n||(n="ped.txt"),a||(a="text/plain");let r=new Blob([t],{type:a});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,n);else{let e=document.createElement("a"),t=URL.createObjectURL(r);e.href=t,e.download=n,document.body.appendChild(e),e.click(),setTimeout((function(){document.body.removeChild(e),window.URL.revokeObjectURL(t)}),0)}}function Se(e){$.each(e.dataset,(function(e,t){if(!t.hidden&&"M"===t.sex&&!I(t)&&t[oe.breast_cancer2]){let e="Male family member ("+t.display_name+") with contralateral breast cancer found. Please note that as the risk models do not take this into account the second breast cancer is ignored.";console.error(e),delete t[oe.breast_cancer2],A("Warning",e)}}))}function Ce(e,t){let n;t.DEBUG&&console.log(e);try{if(0===e.indexOf("BOADICEA import pedigree file format 4.0"))t.dataset=Re(e,4),Se(t);else if(0===e.indexOf("BOADICEA import pedigree file format 2.0"))t.dataset=Re(e,2),Se(t);else if(0===e.indexOf("##")&&-1!==e.indexOf("CanRisk")){let a=De(e);n=a[0],t.dataset=a[1],Se(t)}else try{let n=JSON.parse(e),a=!0;for(let e=0;e<n.length;e++)n[e].top_level&&(a=!1);t.dataset=a?Te(n):n}catch(n){t.dataset=Me(e)}k(t)}catch(t){return console.error(t,e),void A("File Error",t.message?t.message:t)}t.DEBUG&&console.log(t.dataset);try{_(t),$(document).trigger("rebuild",[t]),console.log(n),$(document).trigger("riskfactorChange",[t,n]),$(document).trigger("fhChange",[t]);try{acc_FamHist_ticked(),acc_FamHist_Leave(),RESULT.FLAG_FAMILY_MODAL=!0}catch(e){}}catch(e){A("File Error",e.message?e.message:e)}}function Me(e){let t,n=e.trim().split("\n"),a=[];for(let e=0;e<n.length;e++){let r=$.map(n[e].trim().split(/\s+/),(function(e,t){return e.trim()}));if(r.length<5)throw new Error("unknown format");let i="1"===r[4]?"M":"2"===r[4]?"F":"U",l={famid:r[0],display_name:r[1],name:r[1],sex:i};if("0"!==r[2]&&(l.father=r[2]),"0"!==r[3]&&(l.mother=r[3]),void 0!==t&&t!==l.famid){console.error("multiple family IDs found only using famid = "+t);break}if("2"===r[5]&&(l.affected=2),r.length>6){l.alleles="";for(let e=6;e<r.length;e+=2)l.alleles+=r[e]+"/"+r[e+1]+";"}a.unshift(l),t=r[0]}return Te(a)}function De(e){let[t,n]=_e(e);try{return[t,Te(n)]}catch(e){return console.error(e),[t,n]}}function Re(e,t){let n=e.trim().split("\n"),a=[];for(let e=2;e<n.length;e++){let r=$.map(n[e].trim().split(/\s+/),(function(e,t){return e.trim()}));if(r.length>1){let n={famid:r[0],display_name:r[1],name:r[3],sex:r[6],status:r[8]};"1"===r[2]&&(n.proband=!0),"0"!==r[4]&&(n.father=r[4]),"0"!==r[5]&&(n.mother=r[5]),"0"!==r[7]&&(n.mztwin=r[7]),"0"!==r[9]&&(n.age=r[9]),"0"!==r[10]&&(n.yob=r[10]);let i=11;if($.each(oe,(function(e,t){"0"!==r[i]&&(n[t]=r[i]),i++})),4===t){"0"!==r[i++]&&(n.ashkenazi=1);for(let t=0;t<5;t++)i+=2,"0"!==r[i-2]&&("S"!==r[i-2]&&"T"!==r[i-2]||"P"!==r[i-1]&&"N"!==r[i-1]?console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[i-2]+" "+r[i-1]):n[se[t]+"_gene_test"]={type:r[i-2],result:r[i-1]})}else 2===t&&(i+=2,"0"!==r[i-2]&&("S"===r[i-2]||"T"===r[i-2]?"N"===r[i-1]?(n.brca1_gene_test={type:r[i-2],result:"N"},n.brca2_gene_test={type:r[i-2],result:"N"}):"1"===r[i-1]?(n.brca1_gene_test={type:r[i-2],result:"P"},n.brca2_gene_test={type:r[i-2],result:"N"}):"2"===r[i-1]?(n.brca1_gene_test={type:r[i-2],result:"N"},n.brca2_gene_test={type:r[i-2],result:"P"}):"3"===r[i-1]&&(n.brca1_gene_test={type:r[i-2],result:"P"},n.brca2_gene_test={type:r[i-2],result:"P"}):console.warn("UNRECOGNISED GENE TEST ON LINE "+(e+1)+": "+r[i-2]+" "+r[i-1])),"0"!==r[i++]&&(n.ashkenazi=1));for(let t=0;t<he.length;t++)"0"!==r[i]&&("N"===r[i]||"P"===r[i]?n[he[t]+"_bc_pathology"]=r[i]:console.warn("UNRECOGNISED PATHOLOGY ON LINE "+(e+1)+": "+he[t]+" "+r[i])),i++;a.unshift(n)}}try{return Te(a)}catch(e){return console.error(e),a}}function Te(e){for(let t=0;t<2;t++)for(let t=0;t<e.length;t++)Pe(e,e[t].name);!function(e){let t=!1,n=e.length;for(let a=0;a<n;a++){let n=T(e,e[a]),r=e[a].level;for(let a=0;a<n.length;a++)if(r-n[a].level>1){n[a].level=r-1;let i=M(e,n[a]);for(let t=0;t<i.length;t++){let n=K(e,i[t]);n.level=r-1;let a=K(e,n.mother),l=K(e,n.father);a&&(a.level=r),l&&(l.level=r)}t=!0}}}(e);let t=0;for(let n=0;n<e.length;n++)e[n].level&&e[n].level>t&&(t=e[n].level);for(let n=0;n<e.length;n++)if(1===G(e,e[n].name))if(e[n].level&&e[n].level===t)e[n].top_level=!0;else{e[n].noparents=!0;let t=Ue(e,e[n]);if(t>-1&&e[t].mother&&(e[n].mother=e[t].mother,e[n].father=e[t].father),!e[n].mother)for(let a=0;a<e.length;a++)if(e[n].level===e[a].level-1&&(t=Ue(e,e[a]),t>-1&&n!==t)){e[n].mother="F"===e[a].sex?e[a].name:e[t].name,e[n].father="M"===e[a].sex?e[a].name:e[t].name;break}}else delete e[n].top_level;return e}function Ue(e,t){for(let n=0;n<e.length;n++){let a=e[n];if(t.name===a.mother)return H(e,a.father);if(t.name===a.father)return H(e,a.mother)}return-1}function Pe(e,t){let n=H(e,t);Le(n,e[n].level?e[n].level:0,e)}function Le(e,t,n){let a=["mother","father"];t++;for(let r=0;r<a.length;r++){let i=H(n,n[e][a[r]]);if(i>=0){let a=n[H(n,n[e].mother)],r=n[H(n,n[e].father)];(!n[i].level||n[i].level<t)&&(a.level=t,r.level=t),a.level<r.level?a.level=r.level:r.level<a.level&&(r.level=a.level),Le(i,t,n)}}}var Be=Object.freeze({__proto__:null,addIO:we,copy_svg:function(e){let t=Ee(e),n=d3.select(t.get(0));return n.selectAll(".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection").remove(),n.selectAll("text").filter((function(){return 0===d3.select(this).text().length})).remove(),$(Ae(t.html()))},img_download:ke,load_data:Ce,print:Ne,readBoadiceaV4:Re,readCanRiskFile:De,readLinkage:Me,save_file:Ie,svg2img:Oe,svg_download:Fe});function je(e,t){let n=[1,2,3,4,5,6,7,8,9,"A"];for(let a=0;a<e.length;a++)if(e[a][t]){let r=n.indexOf(e[a][t]);r>-1&&n.splice(r,1)}if(n.length>0)return n[0]}function Ge(e,t){if(!t.mztwin&&!t.dztwin)return;let n=t.mztwin?"mztwin":"dztwin";for(let a=0;a<e.length;a++){let r=e[a];r[n]&&t[n]===r[n]&&r.name!==t.name&&("mztwin"===n&&(r.sex=t.sex),t.yob&&(r.yob=t.yob),!t.age||0!==t.status&&t.status||(r.age=t.age))}}let He,qe;function Ye(e,t){e.dataset=t,$(document).trigger("rebuild",[e])}function Je(e,t,n,a,r){r&&d3.selectAll(".line_drag_selection").attr("transform","translate("+r+")"),d3.selectAll(".line_drag_selection").attr("x1",e).attr("y1",t).attr("x2",n).attr("y2",a)}function Xe(e,t,n,a,r){if(console.log("Added sibling"),r&&-1===$.inArray(r,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+r);void 0===a&&(a=1);let i,l,o,s=j(e,t);if(0===s.length){let n=Ke(e,t,"F"===t.sex?"M":"F","F"===t.sex);n.noparents=!0,i=n.name,l=H(e,t.name)+1}else{let n=s[0];i=n.father===t.name?n.mother:n.father,l=H(e,n.name)}r&&(o=je(e,r));let d=[];for(let s=0;s<a;s++){let a={name:E(4),sex:n,mother:"F"===t.sex?t.name:i,father:"F"===t.sex?i:t.name};e.splice(l,0,a),r&&(a[r]=o),d.push(a)}return d}function Ke(e,t,n,a,r){if(console.log("Added sibling"),r&&-1===$.inArray(r,["mztwin","dztwin"]))return new Error("INVALID TWIN TYPE SET: "+r);let i={name:E(4),sex:n};t.top_level?i.top_level=!0:(i.mother=t.mother,i.father=t.father);let l=H(e,t.name);return r&&function(e,t,n,a){!t[a]&&(t[a]=je(e,a),!t[a])||(n[a]=t[a],t.yob&&(n.yob=t.yob),!t.age||"0"!==t.status&&t.status||(n.age=t.age))}(e,e[l],i,r),a?l>0&&l--:l++,e.splice(l,0,i),i}function Ve(e,t,n){let a,r,i,l,o=J(x[e.targetDiv]),s=K(o,n),d=s.data,c=s.depth,h=-101,u=j(t,d);if(u.length>0&&(i=u[0].mother===d.name?u[0].father:u[0].mother,h=K(o,i).data.id),1===c)for(a={name:E(4),sex:"F",top_level:!0},r={name:E(4),sex:"M",top_level:!0},t.splice(0,0,a),t.splice(0,0,r),l=0;l<t.length;l++)!t[l].top_level&&2!==G(t,t[l].name)||t[l].name===a.name||t[l].name===r.name||(delete t[l].top_level,t[l].noparents=!0,t[l].mother=a.name,t[l].father=r.name);else{let n=K(o,s.data.mother),i=K(o,s.data.father),c=L(t,d),u=1e4,p=s.data.id;for(l=0;l<c.length;l++){let e=K(o,c[l].name).data.id;e<u&&e>s.data.id&&(u=e),e<p&&(p=e)}let f,m=p>=s.data.id||h===p&&u<1e4;e.DEBUG&&console.log("lid="+p+" rid="+u+" nid="+s.data.id+" ADD_LHS="+m),f=!m&&i.data.id>n.data.id||m&&i.data.id<n.data.id?H(t,d.father):H(t,d.mother);let g=t[f];r=Ke(t,g,"M",m),a=Ke(t,g,"F",m);let _=H(t,r.name),y=H(t,a.name);if(_>y){let e=t[_];t[_]=t[y],t[y]=e}let b=B(t,d),x=s.data.id;for(l=0;l<b.length;l++){let n=K(o,b[l].name).data.id;if(e.DEBUG&&console.log("ORPHAN="+l+" "+b[l].name+" "+(x<n&&n<u)+" nid="+x+" oid="+n+" rid="+u),(m||x<n)&&n<u){let e=H(t,b[l].name);t[e].mother=a.name,t[e].father=r.name}}}2===c?(a.top_level=!0,r.top_level=!0):c>2&&(a.noparents=!0,r.noparents=!0);let p=H(t,d.name);if(t[p].mother=a.name,t[p].father=r.name,delete t[p].noparents,"parent_node"in d){let e=t[H(t,i)];"noparents"in e&&(e.mother=a.name,e.father=r.name)}}function We(e,t,n){console.log("Added sibling");let a=K(J(x[e.targetDiv]),n),r=Ke(t,a.data,"F"===a.data.sex?"M":"F","F"===a.data.sex);r.noparents=!0;let i={name:E(4),sex:"M"};i.mother="F"===a.data.sex?a.data.name:r.name,i.father="F"===a.data.sex?r.name:a.data.name;let l=H(t,a.data.name)+2;t.splice(l,0,i)}function Ze(e,t,n){let a,r,i=q(J(e),t.depth,n);for(let e=0;e<i.length;e++)i[e].x<t.x&&(a=i[e]),!r&&i[e].x>t.x&&(r=i[e]);return[a,r]}function Qe(e,t,n,a){let r,i,l,o=x[n.targetDiv],s=J(o),d=[];if(void 0===t.id){let e=K(s,t.name);void 0!==e&&(t=e.data)}if(t.parent_node)for(r=0;r<t.parent_node.length;r++){let n=t.parent_node[r],a=[K(e,n.mother.name),K(e,n.father.name)];for(i=0;i<a.length;i++)(a[i].name===t.name||void 0!==a[i].noparents||a[i].top_level)&&(e.splice(H(e,a[i].name),1),d.push(a[i]));let l=n.children,c=$.map(l,(function(e,t){return e.name}));for(i=0;i<l.length;i++){let t=K(e,l[i].name);if(t){t.noparents=!0;let n,a=M(e,t);if(a.length>0&&(n=K(e,a[0])),n&&n.mother!==t.mother)t.mother=n.mother,t.father=n.father;else if(n){let e=Ze(o,K(s,t.name),c);t.mother=e[0]?e[0].data.mother:e[1]?e[1].data.mother:null,t.father=e[0]?e[0].data.father:e[1]?e[1].data.father:null}else e.splice(H(e,t.name),1)}}}else e.splice(H(e,t.name),1);for(console.log(d),r=0;r<d.length;r++){let t=d[r],n=L(e,t);if(console.log("DEL",t.name,n),n.length<1){console.log("del sibs",t.name,n);let a=K(s,t.name).ancestors();for(i=0;i<a.length;i++)console.log(a[r]),a[i].data.mother&&(console.log("DELETE ",a[i].data.mother,a[i].data.father),e.splice(H(e,a[i].data.mother.name),1),e.splice(H(e,a[i].data.father.name),1))}}!function(e){let t=["mztwin","dztwin"];for(let n=0;n<e.length;n++)for(let a=0;a<t.length;a++){let r=t[a];if(e[n][r]){let t=0;for(let a=0;a<e.length;a++)e[a][r]===e[n][r]&&t++;t<2&&delete e[n][[r]]}}}(e);try{let t=$.extend({},n);t.dataset=O(e),k(t),l=D(e)}catch(e){throw A("Warning","Deletion of this pedigree member is disallowed."),e}return l.length>0&&0===D(n.dataset).length?(console.error("individuals unconnected to pedigree ",l),void A("Warning","Deleting this will split the pedigree. Continue?",a,n,e)):(a&&a(n,e),e)}var et=Object.freeze({__proto__:null,addWidgets:function(e,t){let n=parseInt($("body").css("font-size")),a=d3.select(".diagram");a.append("rect").attr("class","popup_selection").attr("rx",6).attr("ry",6).attr("transform","translate(-1000,-100)").style("opacity",0).attr("width",7.9*n).attr("height",2*n).style("stroke","darkgrey").attr("fill","white");let r=a.append("text").attr("font-family","FontAwesome").style("opacity",0).style("font-size","1.1em").attr("class","popup_selection fa-square persontype").attr("transform","translate(-1000,-100)").attr("x",n/3).attr("y",1.5*n).text(" ").append("svg:title").text("add male"),i=a.append("text").attr("font-family","FontAwesome").style("opacity",0).style("font-size","1.1em").attr("class","popup_selection fa-circle persontype").attr("transform","translate(-1000,-100)").attr("x",1.71*n).attr("y",1.5*n).text(" ").append("svg:title").text("add female");a.append("text").attr("font-family","FontAwesome").style("opacity",0).style("font-size","1.1em").attr("transform","translate(-1000,-100)").attr("x",.065*n).attr("y",.065*-n).attr("class","popup_selection fa-unspecified popup_selection_rotate45 persontype").text(" ").append("svg:title").text("add unspecified"),a.append("text").attr("font-family","FontAwesome").style("opacity",0).style("font-size","1.6em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-angle-up persontype dztwin").attr("x",4.62*n).attr("y",1.5*n).text(" ").append("svg:title").text("add dizygotic/fraternal twins"),a.append("text").attr("font-family","FontAwesome").style("opacity",0).style("font-size","1.6em").attr("transform","translate(-1000,-100)").attr("class","popup_selection fa-caret-up persontype mztwin").attr("x",6.4*n).attr("y",1.5*n).text(" ").append("svg:title").text("add monozygotic/identical twins");let l={};d3.selectAll(".persontype").on("click",(function(){let t,n,a=O(p(e)),r=d3.select(this).classed("mztwin"),i=d3.select(this).classed("dztwin");if(r||i?(n=l.node.datum().data.sex,t=r?"mztwin":"dztwin"):n=d3.select(this).classed("fa-square")?"M":d3.select(this).classed("fa-circle")?"F":"U","addsibling"===l.type)Ke(a,l.node.datum().data,n,!1,t);else{if("addchild"!==l.type)return;Xe(a,l.node.datum().data,t?"U":n,t?2:1,t)}e.dataset=a,$(document).trigger("rebuild",[e]),d3.selectAll(".popup_selection").style("opacity",0),l={}})).on("mouseover",(function(){l.node&&l.node.select("rect").style("opacity",.2),d3.selectAll(".popup_selection").style("opacity",1),"addsibling"===l.type?d3.select(this).classed("fa-square")?r.text("add brother"):i.text("add sister"):"addchild"===l.type&&(d3.select(this).classed("fa-square")?r.text("add son"):i.text("add daughter"))})),d3.selectAll(".popup_selection").on("mouseout",(function(){void 0!==l.node&&-1===h.indexOf(l.node.datum())&&l.node.select("rect").style("opacity",0),d3.selectAll(".popup_selection").style("opacity",0)})),function(e){function t(){He=qe,d3.selectAll(".line_drag_selection").attr("stroke","darkred")}function n(t){if(qe&&He.data.name!==qe.data.name&&He.data.sex!==qe.data.sex){let t={name:E(4),sex:"U",mother:"F"===He.data.sex?He.data.name:qe.data.name,father:"F"===He.data.sex?qe.data.name:He.data.name},n=O(e.dataset);e.dataset=n;let a=H(e.dataset,He.data.name)+1;e.dataset.splice(a,0,t),$(document).trigger("rebuild",[e])}Je(0,0,0,0),d3.selectAll(".line_drag_selection").attr("stroke","black"),He=void 0}function a(t){t.sourceEvent.stopPropagation();let n=t.dx,a=t.dy,r=parseFloat(d3.select(this).attr("x2"))+n,i=parseFloat(d3.select(this).attr("y2"))+a;Je(e.symbol_size-10,0,r,i)}d3.select(".diagram").append("line").attr("class","line_drag_selection").attr("stroke-width",6).style("stroke-dasharray","2, 1").attr("stroke","black").call(d3.drag().on("start",t).on("drag",a).on("end",n)).append("svg:title").text("drag to create consanguineous partners"),Je(0,0,0,0)}(e),t.filter((function(t){return!(t.data.hidden&&!e.DEBUG)})).append("rect").attr("class","indi_rect").attr("rx",6).attr("ry",6).attr("x",(function(t){return-.75*e.symbol_size})).attr("y",(function(t){return-e.symbol_size})).attr("width",1.5*e.symbol_size+"px").attr("height",2*e.symbol_size+"px").style("stroke","black").style("stroke-width",.7).style("opacity",0).attr("fill","lightgrey");let o=function(t){return d-.75*e.symbol_size},s=e.symbol_size-2,d=0,c={addchild:{text:"",title:"add child",fx:o,fy:s},addsibling:{text:"",title:"add sibling",fx:o,fy:s},addpartner:{text:"",title:"add partner",fx:o,fy:s},addparents:{text:"",title:"add parents",fx:-.75*e.symbol_size,fy:11-e.symbol_size},delete:{text:"X",title:"delete",fx:e.symbol_size/2-1,fy:12-e.symbol_size,styles:{"font-weight":"bold",fill:"darkred","font-family":"monospace"}}};e.edit&&(c.settings={text:"",title:"settings",fx:-n/2+2,fy:11-e.symbol_size});for(let n in c){let a=t.filter((function(t){return!(t.data.hidden&&!e.DEBUG||(void 0===t.data.mother||t.data.noparents)&&"addsibling"===n||void 0!==t.data.parent_node&&t.data.parent_node.length>1&&"addpartner"===n||void 0===t.data.parent_node&&"addchild"===n||void 0===t.data.noparents&&void 0===t.data.top_level&&"addparents"===n)})).append("text").attr("class",n).style("opacity",0).attr("font-family","FontAwesome").attr("xx",(function(e){return e.x})).attr("yy",(function(e){return e.y})).attr("x",c[n].fx).attr("y",c[n].fy).attr("font-size","0.85em").text(c[n].text);if("styles"in c[n])for(let e in c[n].styles)a.attr(e,c[n].styles[e]);a.append("svg:title").text(c[n].title),d+=17}d3.selectAll(".addsibling, .addchild").on("mouseover",(function(){let e=d3.select(this).attr("class");d3.selectAll(".popup_selection").style("opacity",1),l={node:d3.select(this.parentNode),type:e};let t=parseInt(d3.select(this).attr("xx"))+parseInt(d3.select(this).attr("x")),a=parseInt(d3.select(this).attr("yy"))+parseInt(d3.select(this).attr("y"));d3.selectAll(".popup_selection").attr("transform","translate("+t+","+(a+2)+")"),d3.selectAll(".popup_selection_rotate45").attr("transform","translate("+(t+3*n)+","+(a+1.2*n)+") rotate(45)")})),d3.selectAll(".addchild, .addpartner, .addparents, .delete, .settings").on("click",(function(t){t.stopPropagation();let n,a=d3.select(this).attr("class"),r=d3.select(this.parentNode).datum();e.DEBUG&&console.log(a),"settings"===a?"function"==typeof e.edit?e.edit(e,r):function(e){$("#node_properties").dialog({autoOpen:!1,title:e.data.display_name,width:$(window).width()>400?450:$(window).width()-30,modal:!0,buttons:{Save:function(){$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});let t="<table id='person_details' class='table'>";t+="<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value='"+(e.data.name||"")+"'></td></tr>",t+="<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value='"+(e.data.display_name||"")+"'></td></tr>",t+="<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value='"+(e.data.age||"")+"'></td></tr>",t+="<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value='"+(e.data.yob||"")+"'></td></tr>",t+='<tr><td colspan="2" id="id_sex"><label class="radio-inline"><input type="radio" name="sex" value="M" '+("M"===e.data.sex?"checked":"")+'> Male</label><label class="radio-inline"><input type="radio" name="sex" value="F" '+("F"===e.data.sex?"checked":"")+'> Female</label><label class="radio-inline"><input type="radio" name="sex" value="U" '+("U"===e.data.sex?"checked":"")+"> Unknown</label></td></tr>",t+='<tr><td colspan="2" id="id_status"><label class="radio-inline"><input type="radio" name="status" value="0" '+("0"==e.data.status?"checked":"")+'> Alive</label><label class="radio-inline"><input type="radio" name="status" value="1" '+("1"==e.data.status?"checked":"")+"> Deceased</label></td></tr>",t+='<tr><td colspan="2" id="id_pregnant"><label class="checkbox-inline"><input type="checkbox" id="pregnant_checkbox" '+(e.data.pregnant?"checked":"")+"> Pregnant</label></td></tr>";let n=["adopted_in","adopted_out","miscarriage","stillbirth","termination"];t+='<tr><td colspan="2"><strong>Reproduction:</strong></td></tr>';for(let a of n)t+='<tr><td colspan="2"><label class="checkbox-inline"><input type="checkbox" id="id_'+a+'" '+(e.data[a]?"checked":"")+"> "+a.replace("_"," ").replace(/^\w/,(e=>e.toUpperCase()))+"</label></td></tr>";t+='<tr><td colspan="2"><strong>Age of Diagnosis:</strong></td></tr>';for(let n in e.data.diseases){t+="<tr><td style='text-align:right'>"+n+"</td><td><input class='form-control' type='number' name='"+n+"_diagnosis_age' value='"+(e.data[n+"_diagnosis_age"]||"")+"'></td></tr>"}$("#node_properties").html(t),$("#node_properties").dialog("open")}(e):"delete"===a?(n=O(p(e)),Qe(n,r.data,e,Ye)):"addparents"===a?(n=O(p(e)),e.dataset=n,Ve(e,n,r.data.name),$(document).trigger("rebuild",[e])):"addpartner"===a&&(n=O(p(e)),We(e,n,r.data.name),e.dataset=n,$(document).trigger("rebuild",[e])),$(document).trigger("fhChange",[e])}));let h=[];t.filter((function(e){return!e.data.hidden})).on("click",(function(t,n){t.ctrlKey?-1===h.indexOf(n)?h.push(n):h.splice(h.indexOf(n),1):h=[n],"nodeclick"in e&&(e.nodeclick(n.data),d3.selectAll(".indi_rect").style("opacity",0),d3.selectAll(".indi_rect").filter((function(e){return-1!==h.indexOf(e)})).style("opacity",.5))})).on("mouseover",(function(t,n){t.stopPropagation(),qe=n,He?He.data.name!==qe.data.name&&He.data.sex!==qe.data.sex&&d3.select(this).select("rect").style("opacity",.2):(d3.select(this).select("rect").style("opacity",.2),d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",1),d3.select(this).selectAll(".indi_details").style("opacity",0),Je(e.symbol_size-10,0,e.symbol_size-2,0,n.x+","+(n.y+2)))})).on("mouseout",(function(t){if(He)return;d3.select(this).selectAll(".addchild, .addsibling, .addpartner, .addparents, .delete, .settings").style("opacity",0),-1===h.indexOf(t)&&d3.select(this).select("rect").style("opacity",0),d3.select(this).selectAll(".indi_details").style("opacity",1);let n=d3.pointer(t)[0],a=d3.pointer(t)[1];a<.8*e.symbol_size&&d3.selectAll(".popup_selection").style("opacity",0),He||(Math.abs(a)>.25*e.symbol_size||Math.abs(a)<-.25*e.symbol_size||n<.2*e.symbol_size)&&Je(0,0,0,0)}))},addchild:Xe,addparents:Ve,addpartner:We,addsibling:Ke,delete_node_dataset:Qe});function tt(e){let t=$.extend({targetDiv:"pedigree_edit",dataset:[{name:"m21",display_name:"father",sex:"M",top_level:!0},{name:"f21",display_name:"mother",sex:"F",top_level:!0},{name:"ch1",display_name:"me",sex:"F",mother:"f21",father:"m21",proband:!0}],width:500,height:800,symbol_size:35,zoomSrc:["wheel","button"],zoomIn:1,zoomOut:1,dragNode:!0,showWidgets:!0,diseases:[{type:"breast_cancer",pattern:"dots"},{type:"ovarian_cancer",pattern:"stripes"},{type:"pancreatic_cancer",pattern:"dots"},{type:"prostate_cancer",pattern:"crosshatch"}],labels:["stillbirth",["age","yob"],"alleles",["brca1_gene_test","brca2_gene_test","palb2_gene_test","chek2_gene_test","atm_gene_test"],["rad51d_gene_test","rad51c_gene_test","brip1_gene_test","hoxb13_gene_test"],["er_bc_pathology","pr_bc_pathology","her2_bc_pathology","ck14_bc_pathology","ck56_bc_pathology"]],keep_proband_on_reset:!1,font_size:".75em",font_family:"Helvetica",font_weight:700,background:"#FAFAFA",node_background:"#fdfdfd",validate:!0,DEBUG:!1},e);$(`#${t.targetDiv}`).append('<svg width="0" height="0">\n\t<defs>\n\t\t<pattern id="dots" patternUnits="userSpaceOnUse" width="10" height="10">\n\t\t\t<circle cx="2" cy="2" r="2" fill="black" />\n\t\t</pattern>\n\t\t<pattern id="stripes" patternUnits="userSpaceOnUse" width="4" height="4">\n\t\t\t<rect width="2" height="4" fill="black"></rect>\n\t\t</pattern>\n\t\t<pattern id="crosshatch" patternUnits="userSpaceOnUse" width="10" height="10">\n\t\t\t<path d="M0,0 L10,10 M10,0 L0,10" stroke="black" stroke-width="1" />\n\t\t</pattern>\n\t</defs></svg>');for(let e=0;e<t.dataset.length;e++){let n=t.dataset[e],a=$("<div></div>").addClass("person-box").css({width:t.symbol_size+"px",height:t.symbol_size+"px",backgroundColor:t.node_background,border:"1px solid #000"});for(let e of t.diseases)n[e.type]&&a.css("background",`url(#${e.pattern})`);$(`#${t.targetDiv}`).append(a)}0===$("#fullscreen").length&&(ie(t),we(t))}function nt(e){$("#"+e.targetDiv).empty(),h(e);try{tt(e)}catch(e){throw console.error(e),e}try{templates.update(e)}catch(e){}}$(document).on("rebuild",(function(e,t){nt(t)})),$(document).on("build",(function(e,t){tt(t)}));var at=Object.freeze({__proto__:null,check_ptr_link_clashes:function(e,t){let n,a,r=J(x[e.targetDiv]);if("name"in t){if(!("mother"in(t=K(r,t.name)).data))return null;n=K(r,t.data.mother),a=K(r,t.data.father)}else n=t.mother,a=t.father;let i=n.x<a.x?n.x:a.x,l=n.x<a.x?a.x:n.x,o=n.y,s=$.map(r,(function(e,t){return!e.data.hidden&&e.data.name!==n.data.name&&e.data.name!==a.data.name&&e.y===o&&e.x>i&&e.x<l?e.x:null}));return s.length>0?s:null},rebuild:nt});function rt(e){$("#age_yob_lock").removeClass("fa-lock fa-unlock-alt"),"1"===e?$("#age_yob_lock").addClass("fa-unlock-alt"):$("#age_yob_lock").addClass("fa-lock"),$("#id_age_"+e).removeClass("hidden"),$("#id_age_"+("1"===e?"0":"1")).addClass("hidden")}function it(e){$("#orig_ashk").is(":checked")?$.each(e,(function(e,t){t.proband&&(t.ashkenazi=1)})):$.each(e,(function(e,t){delete t.ashkenazi}))}function lt(){$("#id_approx").is(":checked")?($("[id$='_diagnosis_age_0']").each((function(e){if(""!==$(this).val()){let e=this.name.substring(0,this.name.length-2);$("#id_"+e+"_1").val(st($(this).val())).prop("selected",!0)}})),$("[id$='_diagnosis_age_0']").hide(),$("[id$='_diagnosis_age_1']").show()):($("[id$='_diagnosis_age_1']").each((function(e){if(""!==$(this).val()){let e=this.name.substring(0,this.name.length-2);$("#id_"+e+"_0").val($(this).val())}})),$("[id$='_diagnosis_age_0']").show(),$("[id$='_diagnosis_age_1']").hide())}function ot(e){$("#cancer .row").show(),"M"===e.sex?(delete e.ovarian_cancer_diagnosis_age,$("[id^='id_ovarian_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!0)):"F"===e.sex&&(delete e.prostate_cancer_diagnosis_age,$("[id^='id_prostate_cancer_diagnosis_age']").closest(".row").hide(),$("[id^='id_breast_cancer2_diagnosis_age']").prop("disabled",!1))}function st(e){let t=10*Math.round((e-1)/10);return e<t?t-5:t+5}$(document).on("fhChange",(function(e,t){try{let e=$("#id_name").val();void 0===K(p(t),e)?$("form > fieldset").prop("disabled",!0):$("form > fieldset").prop("disabled",!1)}catch(e){console.warn(e)}}));var dt=Object.freeze({__proto__:null,nodeclick:function(e){$("form > fieldset").prop("disabled",!1),$("#person_details").find("input[type=text], input[type=number]").val(""),$("#person_details select").val("").prop("selected",!0),"M"===e.sex||"F"===e.sex?$('input[name=sex][value="'+e.sex+'"]').prop("checked",!0):$("input[name=sex]").prop("checked",!1),ot(e),"status"in e||(e.status=0),$('input[name=status][value="'+e.status+'"]').prop("checked",!0),rt(e.status),"proband"in e?($("#id_proband").prop("checked",e.proband),$("#id_proband").prop("disabled",!0)):($("#id_proband").prop("checked",!1),$("#id_proband").prop("disabled",!("yob"in e))),"exclude"in e?$("#id_exclude").prop("checked",e.exclude):$("#id_exclude").prop("checked",!1),"yob"in e?$("#id_yob_0").val(e.yob):$("#id_yob_0").val("-"),$('select[name$="_bc_pathology"]').val("-"),$('select[name*="_gene_test"]').val("-"),$("input[id^='id_sex_']").prop("disabled",!(!e.parent_node||"U"===e.sex)),$("select[id$='_bc_pathology']").prop("disabled","M"===e.sex||"F"===e.sex&&!("breast_cancer_diagnosis_age"in e)),$("#id_approx").prop("checked",!!e.approx_diagnosis_age),lt();for(let t in e)"proband"!==t&&"sex"!==t&&($("#id_"+t).length?-1!==t.indexOf("_gene_test")&&null!==e[t]&&"object"==typeof e[t]?($("#id_"+t).val(e[t].type),$("#id_"+t+"_result").val(e[t].result)):$("#id_"+t).val(e[t]):-1!==t.indexOf("_diagnosis_age")&&($("#id_approx").is(":checked")?$("#id_"+t+"_1").val(st(e[t])).prop("selected",!0):$("#id_"+t+"_0").val(e[t])));try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}},save:function(e){let t=p(e),n=$("#id_name").val(),a=O(t),r=K(a,n);if(!r)return void console.warn("person not found when saving details");$("#"+e.targetDiv).empty();let i=$("#id_yob_0").val();i&&""!==i?r.yob=i:delete r.yob;let l=$("#id_status").find("input[type='radio']:checked");l.length>0&&(r.status=l.val());let o=["miscarriage","adopted_in","adopted_out","termination","stillbirth"];for(let e=0;e<o.length;e++){let t=o[e],n=$("#id_"+t);n.length>0&&(console.log(n.is(":checked")),n.is(":checked")?r[t]=!0:delete r[t])}let s=$("#id_sex").find("input[type='radio']:checked");s.length>0&&(r.sex=s.val(),ot(r)),it(a),$("#id_approx").is(":checked")?r.approx_diagnosis_age=!0:delete r.approx_diagnosis_age,$("#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible").each((function(){let e=this.name.indexOf("_diagnosis_age")>-1?this.name.substring(0,this.name.length-2):this.name;if($(this).val()){let t=$(this).val();e.indexOf("_diagnosis_age")>-1&&$("#id_approx").is(":checked")&&(t=st(t)),r[e]=t}else delete r[e]})),$('#person_details input[type="checkbox"][name$="cancer"],input[type="checkbox"][name$="cancer2"]').each((function(){this.checked?r[$(this).attr("name")]=!0:delete r[$(this).attr("name")]})),$('#person_details select[name$="_bc_pathology"]').each((function(){"-"!==$(this).val()?r[$(this).attr("name")]=$(this).val():delete r[$(this).attr("name")]})),$('#person_details select[name$="_gene_test"]').each((function(){if("-"!==$(this).val()){let e=$('select[name="'+$(this).attr("name")+'_result"]');r[$(this).attr("name")]={type:$(this).val(),result:$(e).val()}}else delete r[$(this).attr("name")]}));let d=$('#person_details select[name="hoxb13_gene_test_result"]').val();void 0!==d&&"-"!==d?r.hoxb13_gene_test={type:"T",result:d}:delete r.hoxb13_gene_test;try{$("#person_details").find("form").valid()}catch(e){console.warn("valid() not found")}Ge(a,r),e.dataset=a,$(document).trigger("rebuild",[e])},save_ashkn:function(e){let t=O(p(e));it(t),e.dataset=t,$(document).trigger("rebuild",[e])},updateStatus:rt,update_diagnosis_age_widget:lt});function ct(e,t,n,a){let r=O(p(e)),i=K(r,t);if(i){if($.isArray(n)||(n=[n]),a)for(let e=0;e<n.length;e++){let t=n[e];if(t in i&&1===n.length){if(i[t]===a)return;try{if(JSON.stringify(i[t])===JSON.stringify(a))return}catch(e){}}i[t]=a}else{let e=!1;for(let t=0;t<n.length;t++){let a=n[t];a in i&&(delete i[a],e=!0)}if(!e)return}Ge(r,i),e.dataset=r,nt(e)}else console.warn("No person defined")}var ht=Object.freeze({__proto__:null,delete_node_by_name:function(e,t){let n=O(p(e)),a=K(p(e),t);a?Qe(n,a,e,(function(e,t){e.dataset=t,nt(e)})):console.warn("No node defined")},node_attr:ct,proband_add_child:function(e,t,n,a,r){let i=O(p(e)),l=i[R(i)];if(!l)return void console.warn("No proband defined");let o=Xe(i,l,t,1)[0];return o.age=n,o.yob=a,void 0!==r&&(o.breastfeeding=r),e.dataset=i,nt(e),o.name},proband_attr:function(e,t,n){ct(e,e.dataset[R(e.dataset)].name,t,n)}});return e.pedigreejs=at,e.pedigreejs__extras=ht,e.pedigreejs_canrisk_file=$e,e.pedigreejs_form=dt,e.pedigreejs_io=Be,e.pedigreejs_pedcache=b,e.pedigreejs_utils=Z,e.pedigreejs_widgets=et,e.pedigreejs_zooming=re,e}({});
//# sourceMappingURL=pedigreejs.v3.0.0-rc7.min.js.map
