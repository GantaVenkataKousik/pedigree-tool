{"version":3,"file":"pedigreejs.v3.0.0-rc7.min.js","sources":["../es/pedcache.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/widgets.js","../es/pedigree.js","../es/popup_form.js","../es/extras.js"],"sourcesContent":["/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n//store a history of pedigree\r\n\r\nlet max_limit = 25;\r\nlet dict_cache = {};\r\n\r\n// test if browser storage is supported\r\nfunction has_browser_storage(opts) {\r\n\ttry {\r\n\t\tif(opts.store_type === 'array')\r\n\t\t\treturn false;\r\n\r\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\r\n\t\t\treturn false;\r\n\r\n\t\tlet mod = 'test';\r\n\t\tlocalStorage.setItem(mod, mod);\r\n\t\tlocalStorage.removeItem(mod);\r\n\t\treturn true;\r\n\t} catch(e) {\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nfunction get_prefix(opts) {\r\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\r\n}\r\n\r\n// use dict_cache to store cache as an array\r\nfunction get_arr(opts) {\r\n\treturn dict_cache[get_prefix(opts)];\r\n}\r\n\r\nfunction get_browser_store(opts, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.getItem(item);\r\n\telse\r\n\t\treturn sessionStorage.getItem(item);\r\n}\r\n\r\nfunction set_browser_store(opts, name, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.setItem(name, item);\r\n\telse\r\n\t\treturn sessionStorage.setItem(name, item);\r\n}\r\n\r\n// clear all storage items\r\nfunction clear_browser_store(opts) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.clear();\r\n\telse\r\n\t\treturn sessionStorage.clear();\r\n}\r\n\r\n// remove all storage items with keys that have the pedigree history prefix\r\nexport function clear_pedigree_data(opts) {\r\n\tlet prefix = get_prefix(opts);\r\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\tlet items = [];\r\n\tfor(let i = 0; i < store.length; i++){\r\n\t\tif(store.key(i).indexOf(prefix) === 0)\r\n\t\t\titems.push(store.key(i));\r\n\t}\r\n\tfor(let i = 0; i < items.length; i++)\r\n\t\tstore.removeItem(items[i]);\r\n}\r\n\r\nexport function get_count(opts) {\r\n\tlet count;\r\n\tif (has_browser_storage(opts))\r\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\r\n\telse\r\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\r\n\tif(count !== null && count !== undefined)\r\n\t\treturn count;\r\n\treturn 0;\r\n}\r\n\r\nfunction set_count(opts, count) {\r\n\tif (has_browser_storage(opts))\r\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\r\n\telse\r\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\r\n}\r\n\r\nexport function init_cache(opts) {\r\n\tif(!opts.dataset)\r\n\t\treturn;\r\n\tlet count = get_count(opts);\r\n\tif (has_browser_storage(opts)) {   // local storage\r\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\r\n\t} else {   // TODO :: array cache\r\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\r\n\t\tmax_limit = 500;\r\n\t\tif(get_arr(opts) === undefined)\r\n\t\t\tdict_cache[get_prefix(opts)] = [];\r\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\r\n\t}\r\n\tif(count < max_limit)\r\n\t\tcount++;\r\n\telse\r\n\t\tcount = 0;\r\n\tset_count(opts, count);\r\n}\r\n\r\nexport function nstore(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\r\n\t\t\t\treturn i;\r\n\t\t}\r\n\t} else {\r\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\nexport function current(opts) {\r\n\tlet current = get_count(opts)-1;\r\n\tif(current === -1)\r\n\t\tcurrent = max_limit;\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\r\n\telse if(get_arr(opts))\r\n\t\treturn JSON.parse(get_arr(opts)[current]);\r\n}\r\n\r\nexport function last(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\r\n\t\t\tif(it !== null) {\r\n\t\t\t\tset_count(opts, i);\r\n\t\t\t\treturn JSON.parse(it);\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet arr = get_arr(opts);\r\n\t\tif(arr)\r\n\t\t\treturn JSON.parse(arr(arr.length-1));\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\nexport function previous(opts, previous) {\r\n\tif(previous === undefined)\r\n\t\tprevious = get_count(opts) - 2;\r\n\r\n\tif(previous < 0) {\r\n\t\tlet nst = nstore(opts);\r\n\t\tif(nst < max_limit)\r\n\t\t\tprevious = nst - 1;\r\n\t\telse\r\n\t\t\tprevious = max_limit - 1;\r\n\t}\r\n\tset_count(opts, previous + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[previous]);\r\n}\r\n\r\nexport function next(opts, next) {\r\n\tif(next === undefined)\r\n\t\tnext = get_count(opts);\r\n\tif(next >= max_limit)\r\n\t\tnext = 0;\r\n\r\n\tset_count(opts, parseInt(next) + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[next]);\r\n}\r\n\r\nexport function clear(opts) {\r\n\tif(has_browser_storage(opts))\r\n\t\tclear_browser_store(opts);\r\n\tdict_cache = {};\r\n}\r\n\r\n// zoom - store translation coords\r\nexport function setposition(opts, x, y, zoom) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\t\tif(x) {\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\r\n\t\t} else {\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\r\n\t\t}\r\n\r\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\r\n\t\tif(zoom)\r\n\t\t\tset_browser_store(opts, zoomName, zoom);\r\n\t\telse\r\n\t\t\tstore.removeItem(zoomName);\r\n\t} else {\r\n\t\t//TODO\r\n\t}\r\n}\r\n\r\nexport function getposition(opts) {\r\n\tif(!has_browser_storage(opts) ||\r\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\r\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\r\n\t\treturn [null, null];\r\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\r\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\r\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\r\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\r\n\treturn pos;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Pedigree Tree Utils\r\nimport * as pedcache from './pedcache.js';\r\n\r\n\r\nexport let roots = {};\r\n\r\nexport function isIE() {\r\n\tlet ua = navigator.userAgent;\r\n\treturn ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\r\n}\r\n\r\nexport function isEdge() {\r\n\treturn navigator.userAgent.match(/Edge/g);\r\n}\r\n\r\nexport function create_err(err) {\r\n\tconsole.error(err);\r\n\treturn new Error(err);\r\n}\r\n\r\n// validate pedigree data\r\nexport function validate_pedigree(opts) {\r\n\tif (opts.validate) {\r\n\t\tif (typeof opts.validate == 'function') {\r\n\t\t\tif (opts.DEBUG)\r\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\r\n\t\t\treturn opts.validate.call(this, opts);\r\n\t\t}\r\n\r\n\t\t// check consistency of parents sex\r\n\t\tlet uniquenames = [];\r\n\t\tlet famids = [];\r\n\t\tlet display_name;\r\n\t\tfor (let p = 0; p < opts.dataset.length; p++) {\r\n\t\t\tif (!p.hidden) {\r\n\t\t\t\tif (opts.dataset[p].mother || opts.dataset[p].father) {\r\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\r\n\t\t\t\t\tif (!display_name)\r\n\t\t\t\t\t\tdisplay_name = 'unnamed';\r\n\t\t\t\t\tdisplay_name += ' (IndivID: ' + opts.dataset[p].name + ')';\r\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\r\n\t\t\t\t\tlet father = opts.dataset[p].father;\r\n\t\t\t\t\tif (!mother || !father) {\r\n\t\t\t\t\t\tthrow create_err('Missing parent for ' + display_name);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\r\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\r\n\t\t\t\t\tif (midx === -1)\r\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: ' + mother + ') of family member ' +\r\n\t\t\t\t\t\t\tdisplay_name + ' is missing from the pedigree.');\r\n\t\t\t\t\tif (fidx === -1)\r\n\t\t\t\t\t\tthrow create_err('The father (IndivID: ' + father + ') of family member ' +\r\n\t\t\t\t\t\t\tdisplay_name + ' is missing from the pedigree.');\r\n\t\t\t\t\tif (opts.dataset[midx].sex !== \"F\")\r\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \" + display_name +\r\n\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\r\n\t\t\t\t\tif (opts.dataset[fidx].sex !== \"M\")\r\n\t\t\t\t\t\tthrow create_err(\"The father of family member \" + display_name +\r\n\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\tif (!opts.dataset[p].name)\r\n\t\t\t\tthrow create_err(display_name + ' has no IndivID.');\r\n\t\t\tif ($.inArray(opts.dataset[p].name, uniquenames) > -1)\r\n\t\t\t\tthrow create_err('IndivID for family member ' + display_name + ' is not unique.');\r\n\t\t\tuniquenames.push(opts.dataset[p].name);\r\n\r\n\t\t\tif ($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\r\n\t\t\t\tfamids.push(opts.dataset[p].famid);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (famids.length > 1) {\r\n\t\t\tthrow create_err('More than one family found: ' + famids.join(\", \") + '.');\r\n\t\t}\r\n\t\t// warn if there is a break in the pedigree\r\n\t\tlet uc = unconnected(opts.dataset);\r\n\t\tif (uc.length > 0)\r\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\r\n\t}\r\n}\r\n\r\nexport function copy_dataset(dataset) {\r\n\tif (dataset[0].id) { // sort by id\r\n\t\tdataset.sort(function (a, b) { return (!a.id || !b.id ? 0 : (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0)); });\r\n\t}\r\n\r\n\tlet disallowed = [\"id\", \"parent_node\"];\r\n\tlet newdataset = [];\r\n\tfor (let i = 0; i < dataset.length; i++) {\r\n\t\tlet obj = {};\r\n\t\tfor (let key in dataset[i]) {\r\n\t\t\tif (disallowed.indexOf(key) === -1)\r\n\t\t\t\tobj[key] = dataset[i][key];\r\n\t\t}\r\n\t\tnewdataset.push(obj);\r\n\t}\r\n\treturn newdataset;\r\n}\r\n\r\n// check if the object contains a key with a given prefix\r\nexport function prefixInObj(prefix, obj) {\r\n\tlet found = false;\r\n\tif (obj)\r\n\t\t$.each(obj, function (k, _n) {\r\n\t\t\tif (k.indexOf(prefix + \"_\") === 0 || k === prefix) {\r\n\t\t\t\tfound = true;\r\n\t\t\t\treturn found;\r\n\t\t\t}\r\n\t\t});\r\n\treturn found;\r\n}\r\n\r\n/**\r\n *  Get formatted time or data & time\r\n */\r\nexport function getFormattedDate(time) {\r\n\tlet d = new Date();\r\n\tif (time)\r\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n\telse\r\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n}\r\n\r\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\r\n\tconst errModalEl = document.getElementById('errModal');\r\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\r\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\r\n\tif (onConfirm) {\r\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').on(\"click\", function () {\r\n\t\t\tonConfirm(opts, dataset);\r\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t\t});\r\n\t} else {\r\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\r\n\t\tif (!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t}\r\n\r\n\tmodalTitle.textContent = title;\r\n\tmodalBodyInput.textContent = msg;\r\n\t$(\"#errModal\").modal(\"show\");\r\n}\r\n\r\n/**\r\n * Show message or confirmation dialog.\r\n * @param title\t - dialog window title\r\n * @param msg\t   - message to diasplay\r\n * @param onConfirm - function to call in a confirmation dialog\r\n * @param opts\t  - pedigreejs options\r\n * @param dataset\t- pedigree dataset\r\n */\r\nexport function messages(title, msg, onConfirm, opts, dataset) {\r\n\ttry {\r\n\t\tif (onConfirm) {\r\n\t\t\t$('<div id=\"msgDialog\">' + msg + '</div>').dialog({\r\n\t\t\t\tmodal: true,\r\n\t\t\t\ttitle: title,\r\n\t\t\t\twidth: 350,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\t\"Yes\": function () {\r\n\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t\tonConfirm(opts, dataset);\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"No\": function () {\r\n\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t$('<div id=\"msgDialog\">' + msg + '</div>').dialog({\r\n\t\t\t\ttitle: title,\r\n\t\t\t\twidth: 350,\r\n\t\t\t\tbuttons: [{\r\n\t\t\t\t\ttext: \"OK\",\r\n\t\t\t\t\tclick: function () { $(this).dialog(\"close\"); }\r\n\t\t\t\t}]\r\n\t\t\t});\r\n\t\t}\r\n\t} catch (err) {\r\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\r\n\t}\r\n}\r\n\r\n/**\r\n * Validate age and yob is consistent with current year. The sum of age and\r\n * yob should not be greater than or equal to current year. If alive the\r\n * absolute difference between the sum of age and year of birth and the\r\n * current year should be <= 1.\r\n * @param age\t- age in years.\r\n * @param yob\t- year of birth.\r\n * @param status - 0 = alive, 1 = dead.\r\n * @return true if age and yob are consistent with current year otherwise false.\r\n */\r\nexport function validate_age_yob(age, yob, status) {\r\n\tlet year = new Date().getFullYear();\r\n\tlet sum = parseInt(age) + parseInt(yob);\r\n\t// check status is an expected string\r\n\tif (status !== \"1\" && status !== \"0\")\r\n\t\treturn false\r\n\r\n\tif (status === \"1\") {   // deceased\r\n\t\treturn year >= sum;\r\n\t}\r\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\r\n}\r\n\r\nexport function capitaliseFirstLetter(string) {\r\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n\r\nexport function makeid(len) {\r\n\tlet text = \"\";\r\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\r\n\tfor (let i = 0; i < len; i++)\r\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\r\n\treturn text;\r\n}\r\n\r\nexport function buildTree(opts, person, root, partnerLinks, id) {\r\n\tif (typeof person.children === typeof undefined)\r\n\t\tperson.children = getChildren(opts.dataset, person);\r\n\r\n\tif (typeof partnerLinks === typeof undefined) {\r\n\t\tpartnerLinks = [];\r\n\t\tid = 1;\r\n\t}\r\n\r\n\tlet nodes = flatten(root);\r\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\r\n\tlet partners = [];\r\n\t$.each(person.children, function (_i, child) {\r\n\t\t$.each(opts.dataset, function (_j, p) {\r\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\r\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\r\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\r\n\t\t\t\tm = (m !== undefined ? m : getNodeByName(opts.dataset, p.mother));\r\n\t\t\t\tf = (f !== undefined ? f : getNodeByName(opts.dataset, p.father));\r\n\t\t\t\tif (!contains_parent(partners, m, f))\r\n\t\t\t\t\tpartners.push({ 'mother': m, 'father': f });\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\t$.merge(partnerLinks, partners);\r\n\r\n\t$.each(partners, function (_i, ptr) {\r\n\t\tlet mother = ptr.mother;\r\n\t\tlet father = ptr.father;\r\n\t\tmother.children = [];\r\n\t\tlet parent = {\r\n\t\t\tname: makeid(4),\r\n\t\t\thidden: true,\r\n\t\t\tparent: null,\r\n\t\t\tfather: father,\r\n\t\t\tmother: mother,\r\n\t\t\tchildren: getChildren(opts.dataset, mother, father)\r\n\t\t};\r\n\r\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\r\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\r\n\t\tif (!('id' in father) && !('id' in mother))\r\n\t\t\tid = setChildrenId(person.children, id);\r\n\r\n\t\t// look at grandparents index\r\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\r\n\t\tif (gp.fidx < gp.midx) {\r\n\t\t\tfather.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tmother.id = id++;\r\n\t\t} else {\r\n\t\t\tmother.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tfather.id = id++;\r\n\t\t}\r\n\t\tid = updateParent(mother, parent, id, nodes, opts);\r\n\t\tid = updateParent(father, parent, id, nodes, opts);\r\n\t\tperson.children.push(parent);\r\n\t});\r\n\tid = setChildrenId(person.children, id);\r\n\r\n\t$.each(person.children, function (_i, p) {\r\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\r\n\t});\r\n\treturn [partnerLinks, id];\r\n}\r\n\r\n\r\n// update parent node and sort twins\r\nfunction updateParent(p, parent, id, nodes, opts) {\r\n\t// add to parent node\r\n\tif ('parent_node' in p)\r\n\t\tp.parent_node.push(parent);\r\n\telse\r\n\t\tp.parent_node = [parent];\r\n\r\n\t// check twins lie next to each other\r\n\tif (p.mztwin || p.dztwins) {\r\n\t\tlet twins = getTwins(opts.dataset, p);\r\n\t\tfor (let i = 0; i < twins.length; i++) {\r\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\r\n\t\t\tif (twin)\r\n\t\t\t\ttwin.id = id++;\r\n\t\t}\r\n\t}\r\n\treturn id;\r\n}\r\n\r\nfunction setChildrenId(children, id) {\r\n\t// sort twins to lie next to each other\r\n\tchildren.sort(function (a, b) {\r\n\t\tif (a.mztwin && b.mztwin && a.mztwin === b.mztwin)\r\n\t\t\treturn 0;\r\n\t\telse if (a.dztwin && b.dztwin && a.dztwin === b.dztwin)\r\n\t\t\treturn 0;\r\n\t\telse if (a.mztwin || b.mztwin || a.dztwin || b.dztwin)\r\n\t\t\treturn 1;\r\n\t\treturn 0;\r\n\t});\r\n\r\n\t$.each(children, function (_i, p) {\r\n\t\tif (p.id === undefined) p.id = id++;\r\n\t});\r\n\treturn id;\r\n}\r\n\r\nexport function isProband(obj) {\r\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\r\n}\r\n\r\nexport function setProband(dataset, name, is_proband) {\r\n\t$.each(dataset, function (_i, p) {\r\n\t\tif (name === p.name)\r\n\t\t\tp.proband = is_proband;\r\n\t\telse\r\n\t\t\tdelete p.proband;\r\n\t});\r\n}\r\n\r\n//combine arrays ignoring duplicates\r\nfunction combineArrays(arr1, arr2) {\r\n\tfor (let i = 0; i < arr2.length; i++)\r\n\t\tif ($.inArray(arr2[i], arr1) === -1) arr1.push(arr2[i]);\r\n}\r\n\r\nfunction include_children(connected, p, dataset) {\r\n\tif ($.inArray(p.name, connected) === -1)\r\n\t\treturn;\r\n\tcombineArrays(connected, get_partners(dataset, p));\r\n\tlet children = getAllChildren(dataset, p);\r\n\t$.each(children, function (_child_idx, child) {\r\n\t\tif ($.inArray(child.name, connected) === -1) {\r\n\t\t\tconnected.push(child.name);\r\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\r\n\t\t}\r\n\t});\r\n}\r\n\r\n//get the partners for a given node\r\nexport function get_partners(dataset, anode) {\r\n\tlet ptrs = [];\r\n\tfor (let i = 0; i < dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif (anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.father);\r\n\t\telse if (anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.mother);\r\n\t}\r\n\treturn ptrs;\r\n}\r\n\r\n//return a list of individuals that aren't connected to the target\r\nexport function unconnected(dataset) {\r\n\tlet target = dataset[getProbandIndex(dataset)];\r\n\tif (!target) {\r\n\t\tconsole.warn(\"No target defined\");\r\n\t\tif (dataset.length === 0) {\r\n\t\t\tthrow new Error(\"empty pedigree data set\");\r\n\t\t}\r\n\t\ttarget = dataset[0];\r\n\t}\r\n\tlet connected = [target.name];\r\n\tlet change = true;\r\n\tlet ii = 0;\r\n\twhile (change && ii < 200) {\r\n\t\tii++;\r\n\t\tlet nconnect = connected.length;\r\n\t\t$.each(dataset, function (_idx, p) {\r\n\t\t\tif ($.inArray(p.name, connected) !== -1) {\r\n\t\t\t\t// check if this person or a partner has a parent\r\n\t\t\t\tlet ptrs = get_partners(dataset, p);\r\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\r\n\t\t\t\tfor (let i = 0; i < ptrs.length; i++) {\r\n\t\t\t\t\tif (!getNodeByName(dataset, ptrs[i]).noparents)\r\n\t\t\t\t\t\thas_parent = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (has_parent) {\r\n\t\t\t\t\tif (p.mother && $.inArray(p.mother, connected) === -1)\r\n\t\t\t\t\t\tconnected.push(p.mother);\r\n\t\t\t\t\tif (p.father && $.inArray(p.father, connected) === -1)\r\n\t\t\t\t\t\tconnected.push(p.father);\r\n\t\t\t\t}\r\n\t\t\t} else if (!p.noparents &&\r\n\t\t\t\t((p.mother && $.inArray(p.mother, connected) !== -1) ||\r\n\t\t\t\t\t(p.father && $.inArray(p.father, connected) !== -1))) {\r\n\t\t\t\tconnected.push(p.name);\r\n\t\t\t}\r\n\t\t\t// include any children\r\n\t\t\tinclude_children(connected, p, dataset);\r\n\t\t});\r\n\t\tchange = (nconnect !== connected.length);\r\n\t}\r\n\tlet names = $.map(dataset, function (val, _i) { return val.name; });\r\n\treturn $.map(names, function (name, _i) { return $.inArray(name, connected) === -1 ? name : null; });\r\n}\r\n\r\nexport function getProbandIndex(dataset) {\r\n\tlet proband;\r\n\t$.each(dataset, function (i, val) {\r\n\t\tif (isProband(val)) {\r\n\t\t\tproband = i;\r\n\t\t\treturn proband;\r\n\t\t}\r\n\t});\r\n\treturn proband;\r\n}\r\n\r\nexport function getChildren(dataset, mother, father) {\r\n\tlet children = [];\r\n\tlet names = [];\r\n\tif (mother.sex === 'F')\r\n\t\t$.each(dataset, function (_i, p) {\r\n\t\t\tif (mother.name === p.mother)\r\n\t\t\t\tif (!father || father.name === p.father) {\r\n\t\t\t\t\tif ($.inArray(p.name, names) === -1) {\r\n\t\t\t\t\t\tchildren.push(p);\r\n\t\t\t\t\t\tnames.push(p.name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t});\r\n\treturn children;\r\n}\r\n\r\nfunction contains_parent(arr, m, f) {\r\n\tfor (let i = 0; i < arr.length; i++)\r\n\t\tif (arr[i].mother === m && arr[i].father === f)\r\n\t\t\treturn true;\r\n\treturn false;\r\n}\r\n\r\n// get the mono/di-zygotic twin(s)\r\nexport function getTwins(dataset, person) {\r\n\tlet sibs = getSiblings(dataset, person);\r\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\r\n\treturn $.map(sibs, function (p, _i) {\r\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\r\n\t});\r\n}\r\n\r\n// get the siblings - sex is an optional parameter\r\n// for only returning brothers or sisters\r\nexport function getSiblings(dataset, person, sex) {\r\n\tif (person === undefined || !person.mother || person.noparents)\r\n\t\treturn [];\r\n\r\n\treturn $.map(dataset, function (p, _i) {\r\n\t\treturn p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t(p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t(!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the siblings + adopted siblings - sex is an optional parameter\r\n// for only returning brothers or sisters\r\nexport function getAllSiblings(dataset, person, sex) {\r\n\treturn $.map(dataset, function (p, _i) {\r\n\t\treturn p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t(p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t(!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the adopted siblings of a given individual\r\nexport function getAdoptedSiblings(dataset, person) {\r\n\treturn $.map(dataset, function (p, _i) {\r\n\t\treturn p.name !== person.name && 'noparents' in p &&\r\n\t\t\t(p.mother === person.mother && p.father === person.father) ? p : null;\r\n\t});\r\n}\r\n\r\nexport function getAllChildren(dataset, person, sex) {\r\n\treturn $.map(dataset, function (p, _i) {\r\n\t\treturn !('noparents' in p) &&\r\n\t\t\t(p.mother === person.name || p.father === person.name) &&\r\n\t\t\t(!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the depth of the given person from the root\r\nexport function getDepth(dataset, name) {\r\n\tlet idx = getIdxByName(dataset, name);\r\n\tlet depth = 1;\r\n\r\n\twhile (idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)) {\r\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\r\n\t\tdepth++;\r\n\t}\r\n\treturn depth;\r\n}\r\n\r\n// given an array of people get an index for a given person\r\nexport function getIdxByName(arr, name) {\r\n\tlet idx = -1;\r\n\t$.each(arr, function (i, p) {\r\n\t\tif (name === p.name) {\r\n\t\t\tidx = i;\r\n\t\t\treturn idx;\r\n\t\t}\r\n\t});\r\n\treturn idx;\r\n}\r\n\r\n// get the nodes at a given depth sorted by their x position\r\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\r\n\treturn $.map(fnodes, function (p, _i) {\r\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\r\n\t}).sort(function (a, b) { return a.x - b.x; });\r\n}\r\n\r\n// convert the partner names into corresponding tree nodes\r\nexport function linkNodes(flattenNodes, partners) {\r\n\tlet links = [];\r\n\tfor (let i = 0; i < partners.length; i++)\r\n\t\tlinks.push({\r\n\t\t\t'mother': getNodeByName(flattenNodes, partners[i].mother.name),\r\n\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)\r\n\t\t});\r\n\treturn links;\r\n}\r\n\r\n// get ancestors of a node\r\nexport function ancestors(dataset, node) {\r\n\tlet ancestors = [];\r\n\tfunction recurse(node) {\r\n\t\tif (node.data) node = node.data;\r\n\t\tif ('mother' in node && 'father' in node && !('noparents' in node)) {\r\n\t\t\trecurse(getNodeByName(dataset, node.mother));\r\n\t\t\trecurse(getNodeByName(dataset, node.father));\r\n\t\t}\r\n\t\tancestors.push(node);\r\n\t}\r\n\trecurse(node);\r\n\treturn ancestors;\r\n}\r\n\r\n// test if two nodes are consanguinous partners\r\nexport function consanguity(node1, node2, opts) {\r\n\tif (node1.depth !== node2.depth) // parents at different depths\r\n\t\treturn true;\r\n\tlet ancestors1 = ancestors(opts.dataset, node1);\r\n\tlet ancestors2 = ancestors(opts.dataset, node2);\r\n\tlet names1 = $.map(ancestors1, function (ancestor, _i) { return ancestor.name; });\r\n\tlet names2 = $.map(ancestors2, function (ancestor, _i) { return ancestor.name; });\r\n\tlet consanguity = false;\r\n\t$.each(names1, function (_index, name) {\r\n\t\tif ($.inArray(name, names2) !== -1) {\r\n\t\t\tconsanguity = true;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t});\r\n\treturn consanguity;\r\n}\r\n\r\n// return a flattened representation of the tree\r\nexport function flatten(root) {\r\n\tlet flat = [];\r\n\tfunction recurse(node) {\r\n\t\tif (node.children)\r\n\t\t\tnode.children.forEach(recurse);\r\n\t\tflat.push(node);\r\n\t}\r\n\trecurse(root);\r\n\treturn flat;\r\n}\r\n\r\n// Adjust D3 layout positioning.\r\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\r\n// from links - e.g. where there is a single child plus a hidden child\r\nexport function adjust_coords(opts, root, flattenNodes) {\r\n\tfunction recurse(node) {\r\n\t\tif (node.children) {\r\n\t\t\tnode.children.forEach(recurse);\r\n\r\n\t\t\tif (node.data.father !== undefined) { \t// hidden nodes\r\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\r\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\r\n\t\t\t\tlet xmid = (father.x + mother.x) / 2;\r\n\t\t\t\tif (!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\r\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\r\n\t\t\t\t\tlet diff = node.x - xmid;\r\n\t\t\t\t\tif (node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\r\n\t\t\t\t\t\tif (!(node.children[0].data.hidden && node.children[1].data.hidden)) {\r\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\r\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\r\n\t\t\t\t\t\t\tif (((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\r\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])) {\r\n\t\t\t\t\t\t\t\tchild1.x = xmid;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (node.children.length === 1 && !node.children[0].data.hidden) {\r\n\t\t\t\t\t\tif (!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\r\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (diff !== 0 && !nodesOverlap(opts, node, diff, root)) {\r\n\t\t\t\t\t\t\tif (node.children.length === 1) {\r\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\r\n\t\t\t\t\t\t\t\tif (opts.DEBUG)\r\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING ' + node.data.name + ' NO. DESCENDANTS ' + descendants.length + ' diff=' + diff);\r\n\t\t\t\t\t\t\t\tfor (let i = 0; i < descendants.length; i++) {\r\n\t\t\t\t\t\t\t\t\tif (node.data.name !== descendants[i].data.name)\r\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if ((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)) {\r\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\trecurse(root);\r\n\trecurse(root);\r\n}\r\n\r\n// test if moving siblings by diff overlaps with other nodes\r\nfunction nodesOverlap(opts, node, diff, root) {\r\n\tlet descendants = node.descendants();\r\n\tlet descendantsNames = $.map(descendants, function (descendant, _i) { return descendant.data.name; });\r\n\tlet nodes = root.descendants();\r\n\tfor (let i = 0; i < descendants.length; i++) {\r\n\t\tlet descendant = descendants[i];\r\n\t\tif (node.data.name !== descendant.data.name) {\r\n\t\t\tlet xnew = descendant.x - diff;\r\n\t\t\tif (overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// test if x position overlaps a node at the same depth\r\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\r\n\tfor (let n = 0; n < nodes.length; n++) {\r\n\t\tif (depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1) {\r\n\t\t\tif (Math.abs(xnew - nodes[n].x) < (opts.symbol_size * 1.15))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// given a persons name return the corresponding d3 tree node\r\nexport function getNodeByName(nodes, name) {\r\n\tfor (let i = 0; i < nodes.length; i++) {\r\n\t\tif (nodes[i].data && name === nodes[i].data.name)\r\n\t\t\treturn nodes[i];\r\n\t\telse if (name === nodes[i].name)\r\n\t\t\treturn nodes[i];\r\n\t}\r\n}\r\n\r\n// given the name of a url param get the value\r\nexport function urlParam(name) {\r\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\r\n\tif (results === null)\r\n\t\treturn null;\r\n\telse\r\n\t\treturn results[1] || 0;\r\n}\r\n\r\n// get grandparents index\r\nfunction get_grandparents_idx(dataset, midx, fidx) {\r\n\tlet gmidx = midx;\r\n\tlet gfidx = fidx;\r\n\twhile ('mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\r\n\t\t!('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])) {\r\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\r\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\r\n\t}\r\n\treturn { 'midx': gmidx, 'fidx': gfidx };\r\n}\r\n\r\n// check by name if the individual exists\r\nexport function exists(opts, name) {\r\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\r\n}\r\n\r\n// print options and dataset\r\nexport function print_opts(opts) {\r\n\t$(\"#pedigree_data\").remove();\r\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\");\r\n\tlet key;\r\n\tfor (let i = 0; i < opts.dataset.length; i++) {\r\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\" + opts.dataset[i].name + \"</strong><div class='col-md-11'>\";\r\n\t\tfor (key in opts.dataset[i]) {\r\n\t\t\tif (key === 'name') continue;\r\n\t\t\tif (key === 'parent')\r\n\t\t\t\tperson += \"<span>\" + key + \":\" + opts.dataset[i][key].name + \"; </span>\";\r\n\t\t\telse if (key === 'children') {\r\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\r\n\t\t\t\t\tperson += \"<span>\" + key + \":\" + opts.dataset[i][key][0].name + \"; </span>\";\r\n\t\t\t} else\r\n\t\t\t\tperson += \"<span>\" + key + \":\" + opts.dataset[i][key] + \"; </span>\";\r\n\t\t}\r\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\r\n\r\n\t}\r\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\r\n\tfor (key in opts) {\r\n\t\tif (key === 'dataset') continue;\r\n\t\t$(\"#pedigree_data\").append(\"<span>\" + key + \":\" + opts[key] + \"; </span>\");\r\n\t}\r\n}\r\n\r\nexport function is_fullscreen() {\r\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\r\n}\r\n\r\n\r\nexport function get_svg_dimensions(opts) {\r\n\treturn {\r\n\t\t'width': (is_fullscreen() ? window.innerWidth : opts.width),\r\n\t\t'height': (is_fullscreen() ? window.innerHeight : opts.height)\r\n\t};\r\n}\r\n\r\nexport function get_tree_dimensions(opts) {\r\n\t// / get score at each depth used to adjust node separation\r\n\tlet svg_dimensions = get_svg_dimensions(opts);\r\n\tlet maxscore = 0;\r\n\tlet generation = {};\r\n\tfor (let i = 0; i < opts.dataset.length; i++) {\r\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\r\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\r\n\r\n\t\t// score based on no. of children and if parent defined\r\n\t\tlet score = 1 + (children.length > 0 ? 0.55 + (children.length * 0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\r\n\t\tif (depth in generation)\r\n\t\t\tgeneration[depth] += score;\r\n\t\telse\r\n\t\t\tgeneration[depth] = score;\r\n\r\n\t\tif (generation[depth] > maxscore)\r\n\t\t\tmaxscore = generation[depth];\r\n\t}\r\n\r\n\tlet max_depth = Object.keys(generation).length * opts.symbol_size * 3.5;\r\n\tlet tree_width = (svg_dimensions.width - opts.symbol_size > maxscore * opts.symbol_size * 1.65 ?\r\n\t\tsvg_dimensions.width - opts.symbol_size : maxscore * opts.symbol_size * 1.65);\r\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\r\n\t\tsvg_dimensions.height - opts.symbol_size : max_depth);\r\n\treturn { 'width': tree_width, 'height': tree_height };\r\n}\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {getposition, setposition} from './pedcache.js';\r\n\r\nlet zm;\r\n\r\n// initialise zoom and drag\r\nexport function init_zoom(opts, svg) {\r\n\t// offsets\r\n\tlet xi = opts.symbol_size/2;\r\n\tlet yi = -opts.symbol_size*2.5;\r\n\r\n\tzm = d3.zoom()\r\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\r\n\t  .filter(function(e) {\r\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\r\n\t\t\t\tif(e.type && e.type === 'wheel') return false\r\n\t\t\t}\r\n\t\t\t// ignore dblclick & secondary mouse buttons\r\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\r\n\t  .on('zoom', function(e) { zooming(e, opts); });\r\n\tsvg.call(zm);\r\n\r\n\t// set initial position & scale\r\n\tlet xyk = getposition(opts);\t\t// cached position\r\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\r\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\r\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\r\n\r\n\tvar transform = d3.zoomIdentity\r\n      .scale(k)\r\n      .translate(x, y);\r\n    svg.call(zm.transform, transform);\r\n}\r\n\r\n// scale size the pedigree\r\nexport function btn_zoom(opts, scale) {\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\r\n}\r\n\r\nexport function scale_to_fit(opts) {\r\n\tlet d = get_dimensions(opts);\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tlet size = get_svg_size(svg);\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\r\n\r\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\r\n\r\n\tlet ped = get_pedigree_center(opts);\r\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\r\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\r\n}\r\n\r\nfunction zooming(e, opts) {\r\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\r\n\tlet t = e.transform;\r\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\r\n\tsetposition(opts, t.x, t.y, k);\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\r\n}\r\n\r\nfunction get_pedigree_center(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\r\n}\r\n\r\n// find width/height of pedigree graphic\r\nfunction get_dimensions(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\r\n}\r\n\r\n/**\r\n * Get the min/max boundary of the diagram\r\n */\r\nexport function get_bounds(opts) {\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tlet xmin = Number.MAX_VALUE;\r\n\tlet xmax = -1000000;\r\n\tlet ymin = Number.MAX_VALUE;\r\n\tlet ymax = -1000000;\r\n\tlet sym = opts.symbol_size;\r\n\tped.selectAll('g').each(function(d, _i) {\r\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\r\n\t\t\tlet n = getNodeSize(opts, this, sym);\r\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\r\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\r\n\t\t\tif(d.y < ymin) ymin = d.y;\r\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\r\n\t\t}\r\n\t});\r\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\r\n}\r\n\r\n/**\r\n * Get the size of an individual's graphical representation\r\n */\r\nfunction getNodeSize(opts, g_elm, sym) {\r\n\tlet node = d3.select(g_elm).node();\r\n\tlet dg = node.getBBox();\r\n\tlet w = dg.width;\r\n\tlet h = dg.height;\r\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\r\n\t\ttry {\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\r\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\r\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\r\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\r\n\t\r\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\r\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\r\n\t\t\t}\r\n\t\t} catch(err) {\r\n\t\t\tconsole.error(err);\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t}\r\n\t}\r\n\treturn {w:w, h:h};\r\n}\r\n\r\n/**\r\n * Calculate width and height of text\r\n */\r\nfunction getTextSize(txt, font, fontSize) {\r\n\t  let o = $('<div></div>')\r\n\t            .text(txt)\r\n\t            .css(\r\n\t\t\t\t\t{'position': 'absolute',\r\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\r\n\t\t\t\t\t 'font': font || 'Helvetica',\r\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\r\n\t            .appendTo($('body'));\r\n\t  let s = {w: o.width(), h:o.height()};\r\n\t  o.remove();\r\n\t  return s;\r\n}\r\n\r\nfunction get_svg_size(svg) {\r\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// undo, redo, reset buttons\r\nimport * as pedcache from './pedcache.js';\r\nimport {btn_zoom, scale_to_fit} from './zoom.js';\r\nimport {copy_dataset, getProbandIndex, is_fullscreen, messages} from './utils.js';\r\n\r\nexport function addButtons(options) {\r\n\tlet opts = $.extend({\r\n        // defaults\r\n\t\tbtn_target: 'pedigree_history'\r\n    }, options );\r\n\r\n\tlet btns = [{\"fa\": \"fa-file-image\", \"title\": \"download PNG image\"},\r\n\t\t\t\t{\"fa\": \"fa-undo\", \"title\": \"undo\"},\r\n\t\t\t\t{\"fa\": \"fa-redo\", \"title\": \"redo\"},\r\n\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"reset\"}];\r\n\r\n\tbtns.push({\"fa\": \"fa-crosshairs\", \"title\": \"scale-to-fit\"});\r\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\r\n\t\tif(opts.zoomOut !== 1)\r\n\t\t\tbtns.push({\"fa\": \"fa-minus-circle\", \"title\": \"zoom-out\"});\r\n\t\tif(opts.zoomIn !== 1)\r\n\t\t\tbtns.push({\"fa\": \"fa-plus-circle\", \"title\": \"zoom-in\"});\r\n\t}\r\n\tbtns.push({\"fa\": \"fa-arrows-alt\", \"title\": \"fullscreen\"});\r\n\r\n\tlet lis = \"\";\r\n\tfor(let i=0; i<btns.length; i++) {\r\n\t\tlis += '<span>';\r\n\t\tlis += '<i class=\"fa fa-lg ' + btns[i].fa + ' pe-2\" aria-hidden=\"true\" title=\"'+ btns[i].title + '\"' +\r\n\t\t(btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\r\n\t\t'></i>';\r\n\r\n\t\tlis += '</span>';\r\n\t}\r\n\t$( \"#\"+opts.btn_target ).append(lis);\r\n\taddPbuttonEvents(opts);\r\n}\r\n\r\nfunction addPbuttonEvents(opts) {\r\n\t// fullscreen\r\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\t\topts.dataset = local_dataset;\r\n\t\t}\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\tsetTimeout(function(){ scale_to_fit(opts); }, 500);\r\n    });\r\n\r\n\t$('#fullscreen').on('click', function(_e) {\r\n\t\t// toggle fullscreen\r\n\t\tif (!is_fullscreen()) {\r\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\r\n\t\t\tif (target.requestFullscreen) {\r\n                target.requestFullscreen();\r\n            } else if (document.documentElement.mozRequestFullScreen) {\r\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\r\n            } else if (document.documentElement.webkitRequestFullscreen) {\r\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\r\n            } else if (document.documentElement.msRequestFullscreen) {\r\n                target.msRequestFullscreen(); // IE\r\n            }\r\n\t\t} else {\r\n            if (document.exitFullscreen) {\r\n                document.exitFullscreen();\r\n            } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen();\r\n            } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen();\r\n            } else if (document.webkitExitFullscreen) {\r\n                document.webkitExitFullscreen();\r\n            }\r\n\t\t}\r\n\t});\r\n\r\n\t// press and hold to zoom in/out\r\n\tlet timeoutId = 0;\r\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\r\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\r\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\r\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\r\n\t}).on('mouseup mouseleave', function() {\r\n\t    clearInterval(timeoutId);\r\n\t});\r\n\r\n\t// undo/redo/reset\r\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\r\n\t\te.stopPropagation();\r\n\t\tif($(e.target).hasClass(\"disabled\"))\r\n\t\t\treturn false;\r\n\r\n\t\tif($(e.target).hasClass('fa-undo')) {\r\n\t\t\topts.dataset = pedcache.previous(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\r\n\t\t\topts.dataset = pedcache.next(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\r\n\t\t\tmessages(\"Pedigree Reset\",\r\n\t\t\t         \"This may result in loss of some data. Reset now?\",\r\n\t\t\t         reset, opts);\r\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\r\n\t\t\tscale_to_fit(opts);\r\n\t\t} else if ($(e.target).hasClass('fa-file-image')) {\r\n\t\t\treturn;\r\n\t\t} \r\n\r\n\t\t// trigger fhChange event\r\n\t\t$(document).trigger('fhChange', [opts]);\r\n\t});\r\n}\r\n\r\n// reset pedigree and clear the history\r\nfunction reset(opts) {\r\n\tlet proband;\r\n\tif(opts.keep_proband_on_reset) {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tlet newdataset =  copy_dataset(local_dataset);\r\n\t\tproband = newdataset[getProbandIndex(newdataset)];\r\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\r\n\t\tproband.name = \"ch1\";\r\n\t\tproband.mother = \"f21\";\r\n\t\tproband.father = \"m21\";\r\n\t\t// clear pedigree data but keep proband data and risk factors\r\n\t\tpedcache.clear_pedigree_data(opts)\r\n\t} else {\r\n\t\tproband = {\r\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"me\"\r\n\t\t};\r\n\t\tpedcache.clear(opts); // clear all storage data\r\n\t}\r\n\r\n\tdelete opts.dataset;\r\n\r\n\tlet selected = $(\"input[name='default_fam']:checked\");\r\n\tif(selected.length > 0 && selected.val() === 'extended2') {    // secondary relatives\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandfather\"},\r\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"paternal grandmother\"},\r\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandfather\"},\r\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\",\"display_name\":\"maternal grandmother\"},\r\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal aunt\"},\r\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"paternal uncle\"},\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\",\"display_name\":\"father\"},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\",\"display_name\":\"mother\"},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\r\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\r\n\t\t\tproband,\r\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\r\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"uuc\",\"display_name\":\"maternal aunt\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"xIw\",\"display_name\":\"maternal uncle\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\r\n\t} else if(selected.length > 0 && selected.val() === 'extended1') {    // primary relatives\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"father\",\"noparents\":true},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"display_name\":\"mother\",\"noparents\":true},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"sister\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\",\"display_name\":\"brother\"},\r\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\",\"display_name\":\"partner\"},\r\n\t\t\tproband,\r\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\",\"display_name\":\"daughter\"},\r\n\t\t\t{\"name\":\"Knx\",\"display_name\":\"son\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\r\n\t} else {\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\r\n\t\t\t{\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\r\n\t\t\tproband];\r\n\t}\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function updateButtons(opts) {\r\n\tlet current = pedcache.get_count(opts);\r\n\tlet nstore = pedcache.nstore(opts);\r\n\tlet id = \"#\"+opts.btn_target;\r\n\tif(nstore <= current)\r\n\t\t$(id+\" .fa-redo\").addClass('disabled');\r\n\telse\r\n\t\t$(id+\" .fa-redo\").removeClass('disabled');\r\n\r\n\tif(current > 1)\r\n\t\t$(id+\" .fa-undo\").removeClass('disabled');\r\n\telse\r\n\t\t$(id+\" .fa-undo\").addClass('disabled');\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport * as pedigree_util from './utils.js';\r\n\r\n// cancers, genetic & pathology tests\r\nexport let cancers = {\r\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\r\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\r\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\r\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\r\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\r\n\t};\r\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\r\n\r\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\r\n\r\n// risk factor to storage\r\nlet RISK_FACTOR_STORE = {};\r\n\r\n// get surgical ops and PRS for canrisk header\r\nexport function get_meta() {\r\n\tlet meta = get_surgical_ops();\r\n\tlet prs;\r\n\ttry {\r\n\t\tprs = get_prs_values();\r\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\r\n\t\t}\r\n\t} catch(err) { console.warn(\"PRS\", prs); }\r\n\treturn meta;\r\n}\r\n\r\n// return a non-anonimised pedigree format\r\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\r\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\r\n}\r\n\r\n//check if input has a value\r\nexport function hasInput(id) {\r\n\treturn $.trim($('#'+id).val()).length !== 0;\r\n}\r\n\r\n//return true if the object is empty\r\nlet isEmpty = function(myObj) {\r\n\tfor(let key in myObj) {\r\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\n\r\n//get breast and ovarian PRS values\r\nexport function get_prs_values() {\r\n\tlet prs = {};\r\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\r\n\t\tprs['breast_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\r\n\t\tprs['ovarian_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\r\n\t\tprs['prostate_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tconsole.log(prs);\r\n\treturn (isEmpty(prs) ? 0 : prs);\r\n}\r\n\r\nfunction get_surgical_ops() {\r\n\tlet meta = \"\";\r\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";OVARY2=y\";\r\n\t}\r\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";MAST2=y\";\r\n\t}\r\n\treturn meta;\r\n}\r\n\r\n/**\r\n * Get genetic test genes based on CanRisk version\r\n */\r\nfunction getGeneticTest(version) {\r\n\tversion = parseInt(version);\r\n\tif(version === 1)\r\n\t\treturn genetic_test1;\r\n\telse if(version === 2)\r\n\t\treturn genetic_test2;\r\n\telse if(version === 3)\r\n\t\treturn genetic_test2;\r\n\treturn genetic_test4;\r\n}\r\n\r\nexport function readCanRisk(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet hdr = [];  // collect risk factor header lines\r\n\tconst regexp = /([0-9])/;\r\n\tlet version = 3;\r\n\tlet gt = getGeneticTest(version);\r\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\r\n\t// assumes two line header\r\n\tfor(let i = 0;i < lines.length;i++){\r\n\t\tlet ln = lines[i].trim();\r\n\t\tif(ln.indexOf(\"##\") === 0) {\r\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\r\n\t\t\t\tconst match = ln.match(regexp);\r\n\t\t\t\tversion = parseInt(match[1]);\r\n\t\t\t\tgt = getGeneticTest(version);\r\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\r\n\r\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\r\n\t\t\t\t\tlet ops = ln.split(\";\");\r\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\r\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\r\n\t\t\t\t\t\tif(opdata.length === 2) {\r\n\t\t\t\t\t\t\thdr.push(ops[j]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\r\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tlet delim = /\\t/;\r\n\t\tif(ln.indexOf('\\t') < 0) {\r\n\t\t\tdelim = /\\s+/;\r\n\t\t\tconsole.log(\"NOT TAB DELIM\");\r\n\t\t}\r\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\r\n\r\n\t\tif(attr.length > 1) {\r\n\t\t\tif(attr.length !== ncol[version-1]) {\r\n\t\t\t\tconsole.error(ln, attr);\r\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\r\n\t\t\t}\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name':\tattr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif(attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\r\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\r\n\t\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\r\n\t\t\t\tif(gene_test[0] !== '0') {\r\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tlet path_test = attr[idx].split(\":\");\r\n\t\t\tfor(let j=0; j<path_test.length; j++) {\r\n\t\t\t\tif(path_test[j] !== '0') {\r\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tped.unshift(indi);\r\n\t\t}\r\n\t}\r\n\r\n\t// group mztwins\r\n\tped.sort(function(a, b) {\r\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\r\n\t});\r\n\r\n\treturn [hdr, ped];\r\n}\r\n\r\n/**\r\n * Get the mammographic density formatted CanRisk data file line\r\n */\r\nexport function get_mdensity(mdensity) {\r\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\r\n\tif(regexp.test(mdensity))\r\n\t\treturn \"\\n##\"+mdensity;\r\n\t\t\r\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\r\n\tif(birads.test(mdensity))\r\n\t\treturn \"\\n##birads=\"+mdensity;\r\n\r\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\r\n\treturn \"\"\r\n}\r\n\r\n/**\r\n * Get CanRisk formated pedigree.\r\n */\r\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\r\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\r\n\tlet msg = \"##CanRisk \" + v;\r\n\tif(!famid) {\r\n\t\tfamid = \"XXXX\";\r\n\t}\r\n\tif(meta) {\r\n\t\tmsg += meta;\r\n\t}\r\n\tif(typeof isanon === 'undefined') {\r\n\t\tisanon = true;\r\n\t}\r\n\t// array of individuals excluded from the calculation\r\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\r\n\r\n\t// female risk factors\r\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\r\n\tlet sex = 'F';\r\n\tif(probandIdx) {\r\n\t\tsex = dataset[probandIdx].sex;\r\n\t}\r\n\r\n\tif(sex !== 'M') {\r\n\t\tlet menarche    = get_risk_factor('menarche_age');\r\n\t\tlet parity      = get_risk_factor('parity');\r\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\r\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\r\n\t\tlet mht_use     = get_risk_factor('mht');\r\n\t\tlet bmi         = get_risk_factor('bmi');\r\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\r\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\r\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\r\n\t\tlet hgt         = get_risk_factor('height');\r\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\r\n\t\tlet endo        = get_risk_factor('endometriosis');\r\n\r\n\t\tif(menarche !== undefined)\r\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\r\n\t\tif(parity !== undefined)\r\n\t\t\tmsg += \"\\n##parity=\"+parity;\r\n\t\tif(first_birth !== undefined)\r\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\r\n\t\tif(oc_use !== undefined)\r\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\r\n\t\tif(mht_use !== undefined)\r\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\r\n\t\tif(bmi !== undefined)\r\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\r\n\t\tif(alcohol !== undefined)\r\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\r\n\t\tif(menopause !== undefined)\r\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\r\n\t\tif(mdensity !== undefined)\r\n\t\t\tmsg += get_mdensity(mdensity);\r\n\t\tif(hgt !== undefined)\r\n\t\t\tmsg += \"\\n##height=\"+hgt;\r\n\t\tif(tl !== undefined)\r\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\r\n\t\t\t\tmsg += \"\\n##TL=Y\";\r\n\t\t\telse\r\n\t\t\t\tmsg += \"\\n##TL=N\";\r\n\r\n\t\tif(endo !== undefined)\r\n\t\t\tmsg += \"\\n##endo=\"+endo;\r\n\t}\r\n\t\r\n\tif(version > 2 && ethnicity !== undefined) {\r\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\r\n\t}\r\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\r\n\r\n\tlet gt = getGeneticTest(version);\r\n\tfor(let i=0; i<gt.length; i++) {\r\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\r\n\t}\r\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\r\n\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet p = dataset[i];\r\n\t\tif($.inArray(p.name, excl) !== -1) {\r\n\t\t\tconsole.log('EXCLUDE: '+p.name);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\r\n\t\tif(isanon)\r\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\r\n\t\telse\r\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\r\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\r\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\r\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += p.sex+'\\t';\r\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\r\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\r\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\r\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\r\n\r\n\t\tlet cmsg = \"\";\r\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\tif(diagnosis_age in p)\r\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\r\n\t\t\telse\r\n\t\t\t\tcmsg += '0\\t';\r\n\t\t});\r\n\t\tmsg+=cmsg;\r\n\r\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\r\n\r\n\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\tif(gt[j]+'_gene_test' in p &&\r\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\r\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\r\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\r\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\r\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0';\r\n\t\t\t}\r\n\t\t\tif(j<(pathology_tests.length-1))\r\n\t\t\t\tmsg += \":\";\r\n\t\t}\r\n\t}\r\n\tconsole.log(msg, RISK_FACTOR_STORE);\r\n\treturn msg;\r\n}\r\n\r\nexport function show_risk_factor_store() {\r\n\tconsole.log(\"RISK_FACTOR_STORE::\");\r\n\t$.each(RISK_FACTOR_STORE, function(name, val){\r\n\t\tconsole.log(name + \" : \" + val);\r\n\t});\r\n}\r\n\r\nexport function save_risk_factor(risk_factor_name, val) {\r\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\r\n}\r\n\r\nexport function get_risk_factor(risk_factor_name) {\r\n\tlet key = store_name(risk_factor_name);\r\n\tif(key in RISK_FACTOR_STORE) {\r\n\t\treturn RISK_FACTOR_STORE[key];\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\n// remove risk factor from storage\r\nexport function remove_risk_factor(risk_factor_name) {\r\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\r\n}\r\n\r\n// prefix risk factor name with the app/page name\r\nexport function store_name(risk_factor_name) {\r\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\r\n\t       '::' + risk_factor_name;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree I/O\r\nimport * as utils from './utils.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport { readCanRisk, cancers, genetic_test1, pathology_tests } from './canrisk_file.js';\r\nimport { get_bounds } from './zoom.js';\r\n\r\n\r\nexport function addIO(opts) {\r\n\t$('#load').change(function (e) {\r\n\t\tload(e, opts);\r\n\t});\r\n\r\n\t$('#save').click(function (_e) {\r\n\t\tsave(opts);\r\n\t});\r\n\r\n\t$('#print').click(function (_e) {\r\n\t\tprint(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#svg_download').click(function (_e) {\r\n\t\tsvg_download(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#png_download, .fa-file-image').click(function (_e) {\r\n\t\tlet resolution = 4;\r\n\t\timg_download(opts, resolution, \"image/png\");\r\n\t});\r\n}\r\n\r\n/**\r\n * Get object from array by the name attribute.\r\n */\r\nfunction getByName(arr, name) {\r\n\treturn $.grep(arr, function (o) { return o && o.name === name; })[0];\r\n}\r\n\r\n/**\r\n * Provide font style to svg\r\n */\r\nfunction copyStylesInline(destinationNode, sourceNode) {\r\n\tlet containerElements = [\"svg\", \"g\"];\r\n\tfor (let cd = 0; cd < destinationNode.childNodes.length; cd++) {\r\n\t\tlet child = destinationNode.childNodes[cd];\r\n\t\tif (containerElements.indexOf(child.tagName) !== -1) {\r\n\t\t\tcopyStylesInline(child, sourceNode.childNodes[cd]);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tlet style = sourceNode.childNodes[cd].currentStyle || window.getComputedStyle(sourceNode.childNodes[cd]);\r\n\t\t\tif (style === \"undefined\" || style === null) continue;\r\n\r\n\t\t\tfor (let st = 0; st < style.length; st++) {\r\n\t\t\t\tif (style[st].indexOf(\"text\") > -1 || style[st].indexOf(\"font\") > -1) child.style.setProperty(style[st], style.getPropertyValue(style[st]));\r\n\t\t\t}\r\n\t\t} catch (err) { continue; }\r\n\t}\r\n}\r\n\r\n/**\r\n * Export pedigree as image, e.g. PNG\r\n */\r\nexport function img_download(opts, resolution, img_type) {\r\n\tlet deferred = svg2img($('#' + opts.targetDiv).find('svg'), \"pedigree\", { resolution: resolution, img_type: img_type });\r\n\t$.when.apply($, [deferred]).done(function () {\r\n\t\tlet obj = getByName(arguments, \"pedigree\");\r\n\t\tif (utils.isEdge() || utils.isIE()) {\r\n\t\t\tlet html = \"<img src='\" + obj.img + \"' alt='canvas image'/>\";\r\n\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\r\n\t\t\tnewTab.document.write(html);\r\n\t\t} else {\r\n\t\t\tlet a = document.createElement('a');\r\n\t\t\ta.href = obj.img;\r\n\t\t\ta.download = 'plot.png';\r\n\t\t\ta.target = '_blank';\r\n\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/**\r\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\r\n */\r\nexport function svg2img(svg, deferred_name, options) {\r\n\tlet defaults = { iscanvg: false, resolution: 1, img_type: \"image/png\" };\r\n\tif (!options) options = defaults;\r\n\t$.each(defaults, function (key, value) {\r\n\t\tif (!(key in options)) { options[key] = value; }\r\n\t});\r\n\r\n\tlet copy = svg.get(0).cloneNode(true);\r\n\tcopyStylesInline(copy, svg.get(0));\r\n\tlet deferred = $.Deferred();\r\n\tlet svgStr = (new XMLSerializer()).serializeToString(copy);\r\n\r\n\tlet imgsrc = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\r\n\tlet canvas = document.createElement(\"canvas\");\r\n\tcanvas.width = svg.width() * options.resolution;\r\n\tcanvas.height = svg.height() * options.resolution;\r\n\tlet context = canvas.getContext(\"2d\");\r\n\t// provide a white background\r\n\tcontext.fillStyle = \"white\";\r\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n\tlet img = document.createElement(\"img\");\r\n\timg.onload = function () {\r\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\t\tconsole.log(deferred_name, options.img_type);\r\n\t\tdeferred.resolve(\r\n\t\t\t{\r\n\t\t\t\t'name': deferred_name,\r\n\t\t\t\t'resolution': options.resolution,\r\n\t\t\t\t'img': canvas.toDataURL(options.img_type, 1),\r\n\t\t\t\t'w': canvas.width,\r\n\t\t\t\t'h': canvas.height\r\n\t\t\t});\r\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\r\n\t};\r\n\timg.src = imgsrc;\r\n\treturn deferred.promise();\r\n}\r\n\r\n/** TODO ::: test the following\r\nexport function svg2imgA(svgJQ, deferred_name, options) {\r\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\r\n\tif(!options) options = defaults;\r\n\t$.each(defaults, function(key, value) {\r\n\t\tif(!(key in options)) {options[key] = value;}\r\n\t});\r\n\r\n\tlet svg = svgJQ.get(0);\r\n\tlet deferred = $.Deferred();\r\n\t\tvar copy = svg.cloneNode(true);\r\n\tcopyStylesInline(copy, svg);\r\n\tvar canvas = document.createElement(\"canvas\");\r\n\tcanvas.width = svgJQ.width()*options.resolution;\r\n\tcanvas.height = svgJQ.height()*options.resolution;\r\n\tvar context = canvas.getContext(\"2d\");\r\n\tvar data = (new XMLSerializer()).serializeToString(copy);\r\n\tvar DOMURL = window.URL || window.webkitURL || window;\r\n\tvar img = new Image();\r\n\tvar svgBlob = new Blob([data], {type: \"image/svg+xml;charset=utf-8\"});\r\n\tvar url = DOMURL.createObjectURL(svgBlob);\r\n\timg.onload = function () {\r\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\t\tconsole.log(deferred_name, options.img_type);\r\n\t\tdeferred.resolve(\r\n\t\t\t{'name': deferred_name,\r\n\t\t\t'resolution': options.resolution,\r\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\r\n\t\t\t'w':canvas.width,\r\n\t\t\t'h':canvas.height})\r\n\t};\r\n\timg.src = url;\r\n\treturn deferred.promise();\r\n}\r\n */\r\n\r\nfunction getMatches(str, myRegexp) {\r\n\tlet matches = [];\r\n\tlet c = 0;\r\n\tmyRegexp.lastIndex = 0;\r\n\tlet match = myRegexp.exec(str);\r\n\twhile (match) {\r\n\t\tc++;\r\n\t\tif (c > 400) {\r\n\t\t\tconsole.error(\"getMatches: counter exceeded 800\");\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t\tmatches.push(match);\r\n\t\tif (myRegexp.lastIndex === match.index) {\r\n\t\t\tmyRegexp.lastIndex++;\r\n\t\t}\r\n\t\tmatch = myRegexp.exec(str);\r\n\t}\r\n\treturn matches;\r\n}\r\n\r\n// find all url's to make unique\r\nfunction unique_urls(svg_html) {\r\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\r\n\tif (matches === -1)\r\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\r\n\r\n\t$.each(matches, function (_index, match) {\r\n\t\tlet quote = (match[1] ? match[1] : \"\");\r\n\t\tlet val = match[2];\r\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\r\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\r\n\r\n\t\tlet newval = val + utils.makeid(2);\r\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\" + newval + \"\\\"\");\r\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\" + newval + \")\");\r\n\t});\r\n\treturn svg_html;\r\n}\r\n\r\n// return a copy pedigree svg\r\nexport function copy_svg(opts) {\r\n\tlet svg_node = get_printable_svg(opts);\r\n\tlet d3obj = d3.select(svg_node.get(0));\r\n\r\n\t// remove unused elements\r\n\td3obj.selectAll(\".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\").remove();\r\n\td3obj.selectAll(\"text\")\r\n\t\t.filter(function () {\r\n\t\t\treturn d3.select(this).text().length === 0\r\n\t\t}).remove();\r\n\treturn $(unique_urls(svg_node.html()));\r\n}\r\n\r\n// get printable svg div, adjust size to tree dimensions and scale to fit\r\nfunction get_printable_svg(opts) {\r\n\tlet local_dataset = pedcache.current(opts); // get current dataset\r\n\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\topts.dataset = local_dataset;\r\n\t}\r\n\r\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\r\n\tlet svg = $('#' + opts.targetDiv).find('svg').clone().appendTo(svg_div);\r\n\r\n\tlet a4 = { w: (595 - 40), h: (842 - 50) };\r\n\r\n\tlet b = get_bounds(opts);\r\n\tlet d = { w: Math.abs(b.xmax - b.xmin), h: Math.abs(b.ymax - b.ymin) };\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.w / a4.w, d.h / a4.h));\r\n\r\n\tlet xi = -(b.xmin - (opts.symbol_size)) * k;\r\n\tlet yi = -(b.ymin - (opts.symbol_size)) * k;\r\n\r\n\tsvg.attr('width', a4.w);\r\n\tsvg.attr('height', d.h * k);\r\n\r\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\" + xi + \", \" + yi + \") scale(\" + k + \")\");\r\n\treturn svg_div;\r\n}\r\n\r\n// download the SVG to a file\r\nexport function svg_download(svg) {\r\n\tlet a = document.createElement('a');\r\n\ta.href = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg.html())));\r\n\ta.download = 'plot.svg';\r\n\ta.target = '_blank';\r\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n}\r\n\r\n// open print window for a given element\r\nexport function print(el, id) {\r\n\tif (el.constructor !== Array)\r\n\t\tel = [el];\r\n\r\n\tlet width = screen.width;\r\n\tlet height = screen.height;\r\n\tlet cssFiles = [\r\n\t\t'/static/css/canrisk.css',\r\n\t\t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\r\n\t];\r\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\r\n\tlet headContent = '';\r\n\tfor (let i = 0; i < cssFiles.length; i++)\r\n\t\theadContent += '<link href=\"' + cssFiles[i] + '\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\r\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\r\n\r\n\tlet html = \"\";\r\n\tfor (let i = 0; i < el.length; i++) {\r\n\t\tif (i === 0 && id)\r\n\t\t\thtml += id;\r\n\t\thtml += $(el[i]).html();\r\n\t\tif (i < el.length - 1)\r\n\t\t\thtml += '<div class=\"page-break\"> </div>';\r\n\t}\r\n\r\n\tprintWindow.document.write(headContent);\r\n\tprintWindow.document.write(html);\r\n\tprintWindow.document.close();\r\n\r\n\tprintWindow.focus();\r\n\tsetTimeout(function () {\r\n\t\tprintWindow.print();\r\n\t\tprintWindow.close();\r\n\t}, 300);\r\n}\r\n\r\n// save content to a file\r\nexport function save_file(opts, content, filename, type) {\r\n\tif (opts.DEBUG)\r\n\t\tconsole.log(content);\r\n\tif (!filename) filename = \"ped.txt\";\r\n\tif (!type) type = \"text/plain\";\r\n\r\n\tlet file = new Blob([content], { type: type });\r\n\tif (window.navigator.msSaveOrOpenBlob) \t// IE10+\r\n\t\twindow.navigator.msSaveOrOpenBlob(file, filename);\r\n\telse { \t\t\t\t\t\t\t\t\t// other browsers\r\n\t\tlet a = document.createElement(\"a\");\r\n\t\tlet url = URL.createObjectURL(file);\r\n\t\ta.href = url;\r\n\t\ta.download = filename;\r\n\t\tdocument.body.appendChild(a);\r\n\t\ta.click();\r\n\t\tsetTimeout(function () {\r\n\t\t\tdocument.body.removeChild(a);\r\n\t\t\twindow.URL.revokeObjectURL(url);\r\n\t\t}, 0);\r\n\t}\r\n}\r\n\r\nfunction save(opts) {\r\n\tlet content = JSON.stringify(pedcache.current(opts));\r\n\tsave_file(opts, content);\r\n}\r\n\r\nfunction canrisk_validation(opts) {\r\n\t$.each(opts.dataset, function (_idx, p) {\r\n\t\tif (!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\r\n\t\t\tif (p[cancers['breast_cancer2']]) {\r\n\t\t\t\tlet msg = 'Male family member (' + p.display_name + ') with contralateral breast cancer found. ' +\r\n\t\t\t\t\t'Please note that as the risk models do not take this into account the second ' +\r\n\t\t\t\t\t'breast cancer is ignored.'\r\n\t\t\t\tconsole.error(msg);\r\n\t\t\t\tdelete p[cancers['breast_cancer2']];\r\n\t\t\t\tutils.messages(\"Warning\", msg);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/** Read and load pedigree data string */\r\nexport function load_data(d, opts) {\r\n\tif (opts.DEBUG) console.log(d);\r\n\tlet risk_factors;\r\n\ttry {\r\n\t\tif (d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if (d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if (d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\r\n\t\t\tlet canrisk_data = readCanRiskFile(d);\r\n\t\t\trisk_factors = canrisk_data[0];\r\n\t\t\topts.dataset = canrisk_data[1];\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tlet ped = JSON.parse(d);\r\n\t\t\t\tlet to_process = true;\r\n\t\t\t\tfor (let i = 0; i < ped.length; i++) {\r\n\t\t\t\t\tif (ped[i].top_level) {\r\n\t\t\t\t\t\tto_process = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\r\n\t\t\t} catch (err) {\r\n\t\t\t\topts.dataset = readLinkage(d);\r\n\t\t\t}\r\n\t\t}\r\n\t\tutils.validate_pedigree(opts);\r\n\t} catch (err1) {\r\n\t\tconsole.error(err1, d);\r\n\t\tutils.messages(\"File Error\", (err1.message ? err1.message : err1));\r\n\t\treturn;\r\n\t}\r\n\tif (opts.DEBUG) console.log(opts.dataset);\r\n\ttry {\r\n\t\tpedcache.setposition(opts);\t\t// clear position\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\tconsole.log(risk_factors);\r\n\t\t// load risk factors - fire riskfactorChange event\r\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\r\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\r\n\r\n\t\ttry {\r\n\t\t\t// update FH section\r\n\t\t\tacc_FamHist_ticked();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tacc_FamHist_Leave();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\t// eslint-disable-line no-undef\r\n\t\t} catch (err3) {\r\n\t\t\t// ignore error\r\n\t\t}\r\n\t} catch (err2) {\r\n\t\tutils.messages(\"File Error\", (err2.message ? err2.message : err2));\r\n\t}\r\n}\r\n\r\nfunction load(e, opts) {\r\n\tlet f = e.target.files[0];\r\n\tif (f) {\r\n\t\tlet reader = new FileReader();\r\n\t\treader.onload = function (e) {\r\n\t\t\tload_data(e.target.result, opts)\r\n\t\t};\r\n\t\treader.onerror = function (event) {\r\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + event.target.error.code);\r\n\t\t};\r\n\t\treader.readAsText(f);\r\n\t} else {\r\n\t\tconsole.error(\"File could not be read!\");\r\n\t}\r\n\t$(\"#load\")[0].value = ''; // reset value\r\n}\r\n\r\n//\r\n// https://www.cog-genomics.org/plink/1.9/formats#ped\r\n// https://www.cog-genomics.org/plink/1.9/formats#fam\r\n//\t1. Family ID ('FID')\r\n//\t2. Within-family ID ('IID'; cannot be '0')\r\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\r\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\r\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\r\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\r\n//  7. Genotypes (column 7 onwards);\r\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\r\nexport function readLinkage(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet famid;\r\n\tfor (let i = 0; i < lines.length; i++) {\r\n\t\tlet attr = $.map(lines[i].trim().split(/\\s+/), function (val, _i) { return val.trim(); });\r\n\t\tif (attr.length < 5)\r\n\t\t\tthrow new Error('unknown format');\r\n\t\tlet sex = (attr[4] === '1' ? 'M' : (attr[4] === '2' ? 'F' : 'U'));\r\n\t\tlet indi = {\r\n\t\t\t'famid': attr[0],\r\n\t\t\t'display_name': attr[1],\r\n\t\t\t'name': attr[1],\r\n\t\t\t'sex': sex\r\n\t\t};\r\n\t\tif (attr[2] !== \"0\") indi.father = attr[2];\r\n\t\tif (attr[3] !== \"0\") indi.mother = attr[3];\r\n\r\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\r\n\t\t\tconsole.error('multiple family IDs found only using famid = ' + famid);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tif (attr[5] === \"2\") indi.affected = 2;\r\n\t\t// add genotype columns\r\n\t\tif (attr.length > 6) {\r\n\t\t\tindi.alleles = \"\";\r\n\t\t\tfor (let j = 6; j < attr.length; j += 2) {\r\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j + 1] + \";\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tped.unshift(indi);\r\n\t\tfamid = attr[0];\r\n\t}\r\n\treturn process_ped(ped);\r\n}\r\n\r\nexport function readCanRiskFile(boadicea_lines) {\r\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\r\n\ttry {\r\n\t\treturn [hdr, process_ped(ped)];\r\n\t} catch (e) {\r\n\t\tconsole.error(e);\r\n\t\treturn [hdr, ped];\r\n\t}\r\n}\r\n\r\n// read boadicea format v4 & v2\r\nexport function readBoadiceaV4(boadicea_lines, version) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\t// assumes two line header\r\n\tfor (let i = 2; i < lines.length; i++) {\r\n\t\tlet attr = $.map(lines[i].trim().split(/\\s+/), function (val, _i) { return val.trim(); });\r\n\t\tif (attr.length > 1) {\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name': attr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif (attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif (attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif (attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif (attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif (attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif (attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function (_cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif (attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif (version === 4) {\r\n\t\t\t\tif (attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\r\n\t\t\t\tfor (let j = 0; j < 5; j++) {\r\n\t\t\t\t\tidx += 2;\r\n\t\t\t\t\tif (attr[idx - 2] !== '0') {\r\n\t\t\t\t\t\tif ((attr[idx - 2] === 'S' || attr[idx - 2] === 'T') && (attr[idx - 1] === 'P' || attr[idx - 1] === 'N'))\r\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = { 'type': attr[idx - 2], 'result': attr[idx - 1] };\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE ' + (i + 1) + \": \" + attr[idx - 2] + \" \" + attr[idx - 1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if (version === 2) {\r\n\t\t\t\t// genetic test BRCA1, BRCA2\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\r\n\t\t\t\tidx += 2; \t// gtest\r\n\t\t\t\tif (attr[idx - 2] !== '0') {\r\n\t\t\t\t\tif ((attr[idx - 2] === 'S' || attr[idx - 2] === 'T')) {\r\n\t\t\t\t\t\tif (attr[idx - 1] === 'N') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = { 'type': attr[idx - 2], 'result': 'N' };\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = { 'type': attr[idx - 2], 'result': 'N' };\r\n\t\t\t\t\t\t} else if (attr[idx - 1] === '1') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = { 'type': attr[idx - 2], 'result': 'P' };\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = { 'type': attr[idx - 2], 'result': 'N' };\r\n\t\t\t\t\t\t} else if (attr[idx - 1] === '2') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = { 'type': attr[idx - 2], 'result': 'N' };\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = { 'type': attr[idx - 2], 'result': 'P' };\r\n\t\t\t\t\t\t} else if (attr[idx - 1] === '3') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = { 'type': attr[idx - 2], 'result': 'P' };\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = { 'type': attr[idx - 2], 'result': 'P' };\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE ' + (i + 1) + \": \" + attr[idx - 2] + \" \" + attr[idx - 1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t}\r\n\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tfor (let j = 0; j < pathology_tests.length; j++) {\r\n\t\t\t\tif (attr[idx] !== '0') {\r\n\t\t\t\t\tif (attr[idx] === 'N' || attr[idx] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE ' + (i + 1) + \": \" + pathology_tests[j] + \" \" + attr[idx]);\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\tped.unshift(indi);\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\treturn process_ped(ped);\r\n\t} catch (e) {\r\n\t\tconsole.error(e);\r\n\t\treturn ped;\r\n\t}\r\n}\r\n\r\nfunction process_ped(ped) {\r\n\t// find the level of individuals in the pedigree\r\n\tfor (let j = 0; j < 2; j++) {\r\n\t\tfor (let i = 0; i < ped.length; i++) {\r\n\t\t\tgetLevel(ped, ped[i].name);\r\n\t\t}\r\n\t}\r\n\r\n\tfix_n_balance_levels(ped);\r\n\r\n\t// find the max level (i.e. top_level)\r\n\tlet max_level = 0;\r\n\tfor (let i = 0; i < ped.length; i++) {\r\n\t\tif (ped[i].level && ped[i].level > max_level)\r\n\t\t\tmax_level = ped[i].level;\r\n\t}\r\n\r\n\t// identify top_level and other nodes without parents\r\n\tfor (let i = 0; i < ped.length; i++) {\r\n\t\tif (utils.getDepth(ped, ped[i].name) === 1) {\r\n\t\t\tif (ped[i].level && ped[i].level === max_level) {\r\n\t\t\t\tped[i].top_level = true;\r\n\t\t\t} else {\r\n\t\t\t\tped[i].noparents = true;\r\n\r\n\t\t\t\t// 1. look for partners parents\r\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\r\n\t\t\t\tif (pidx > -1) {\r\n\t\t\t\t\tif (ped[pidx].mother) {\r\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\r\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 2. or adopt parents from level above\r\n\t\t\t\tif (!ped[i].mother) {\r\n\t\t\t\t\tfor (let j = 0; j < ped.length; j++) {\r\n\t\t\t\t\t\tif (ped[i].level === (ped[j].level - 1)) {\r\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\r\n\t\t\t\t\t\t\tif (pidx > -1 && i !== pidx) {\r\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tdelete ped[i].top_level;\r\n\t\t}\r\n\t}\r\n\treturn ped;\r\n}\r\n\r\n// get the partners for a given node\r\nfunction getPartnerIdx(dataset, anode) {\r\n\tfor (let i = 0; i < dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif (anode.name === bnode.mother)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\r\n\t\telse if (anode.name === bnode.father)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\n// for a given individual assign levels to a parents ancestors\r\nfunction getLevel(dataset, name) {\r\n\tlet idx = utils.getIdxByName(dataset, name);\r\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\r\n\tupdate_parents_level(idx, level, dataset);\r\n}\r\n\r\n// recursively update parents levels\r\nfunction update_parents_level(idx, level, dataset) {\r\n\tlet parents = ['mother', 'father'];\r\n\tlevel++;\r\n\tfor (let i = 0; i < parents.length; i++) {\r\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\r\n\t\tif (pidx >= 0) {\r\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\r\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\r\n\t\t\tif (!dataset[pidx].level || dataset[pidx].level < level) {\r\n\t\t\t\tma.level = level;\r\n\t\t\t\tpa.level = level;\r\n\t\t\t}\r\n\r\n\t\t\tif (ma.level < pa.level) {\r\n\t\t\t\tma.level = pa.level;\r\n\t\t\t} else if (pa.level < ma.level) {\r\n\t\t\t\tpa.level = ma.level;\r\n\t\t\t}\r\n\t\t\tupdate_parents_level(pidx, level, dataset);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// for a pedigree fix the levels of children nodes to be consistent with parent\r\nfunction fix_n_balance_levels(ped) {\r\n\tlet updated = false;\r\n\tlet l = ped.length;\r\n\r\n\tfor (let i = 0; i < l; i++) {\r\n\t\tlet children = utils.getChildren(ped, ped[i]);\r\n\t\tlet prt_lvl = ped[i].level;\r\n\t\tfor (let j = 0; j < children.length; j++) {\r\n\t\t\tif (prt_lvl - children[j].level > 1) {\r\n\t\t\t\tchildren[j].level = prt_lvl - 1;\r\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\r\n\r\n\t\t\t\tfor (let k = 0; k < ptrs.length; k++) {\r\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\r\n\t\t\t\t\tp.level = prt_lvl - 1;\r\n\r\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\r\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\r\n\t\t\t\t\tif (m) m.level = prt_lvl;\r\n\t\t\t\t\tif (f) f.level = prt_lvl;\r\n\t\t\t\t}\r\n\t\t\t\tupdated = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn updated;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n\r\n// set two siblings as twins\r\nexport function setMzTwin(dataset, d1, d2, twin_type) {\r\n\tif(!d1[twin_type]) {\r\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\r\n\t\tif(!d1[twin_type])\r\n\t\t\treturn false;\r\n\t}\r\n\td2[twin_type] = d1[twin_type];\r\n\tif(d1.yob)\r\n\t\td2.yob = d1.yob;\r\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\r\n\t\td2.age = d1.age;\r\n\treturn true;\r\n}\r\n\r\n// get a new unique twins ID, max of 10 twins in a pedigree\r\nexport function getUniqueTwinID(dataset, twin_type) {\r\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tif(dataset[i][twin_type]) {\r\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\r\n\t\t\tif (idx > -1)\r\n\t\t\t\tmz.splice(idx, 1);\r\n\t\t}\r\n\t}\r\n\tif(mz.length > 0)\r\n\t\treturn mz[0];\r\n\treturn undefined;\r\n}\r\n\r\n// sync attributes of twins\r\nexport function syncTwins(dataset, d1) {\r\n\tif(!d1.mztwin && !d1.dztwin)\r\n\t\treturn;\r\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet d2 = dataset[i];\r\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\r\n\t\t\tif(twin_type === \"mztwin\")\r\n\t\t\t  d2.sex = d1.sex;\r\n\t\t\tif(d1.yob)\r\n\t\t\t\td2.yob = d1.yob;\r\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\r\n\t\t\t\td2.age = d1.age;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// check integrity twin settings\r\nexport function checkTwins(dataset) {\r\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tfor(let j=0; j<twin_types.length; j++) {\r\n\t\t\tlet twin_type = twin_types[j];\r\n\t\t\tif(dataset[i][twin_type]) {\r\n\t\t\t\tlet count = 0;\r\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\r\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\r\n\t\t\t\t\t\tcount++;\r\n\t\t\t\t}\r\n\t\t\t\tif(count < 2)\r\n\t\t\t\t\tdelete dataset[i][[twin_type]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n// pedigree widgets\r\nimport * as utils from './utils.js';\r\nimport { current as pedcache_current } from './pedcache.js';\r\nimport { getUniqueTwinID, setMzTwin, checkTwins } from './twins.js';\r\n\r\n\r\nlet dragging;\r\nlet last_mouseover;\r\n//\r\n// Add widgets to nodes and bind events\r\nexport function addWidgets(opts, node) {\r\n\r\n\t// popup gender selection box\r\n\tlet font_size = parseInt($(\"body\").css('font-size'));\r\n\tlet popup_selection = d3.select('.diagram');\r\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.attr(\"width\", font_size * 7.9)\r\n\t\t.attr(\"height\", font_size * 2)\r\n\t\t.style(\"stroke\", \"darkgrey\")\r\n\t\t.attr(\"fill\", \"white\");\r\n\r\n\tlet square = popup_selection.append(\"text\")  // male\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size / 3)\r\n\t\t.attr(\"y\", font_size * 1.5)\r\n\t\t.text(\"\\uf096 \");\r\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\r\n\r\n\tlet circle = popup_selection.append(\"text\")  // female\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size * 1.71)\r\n\t\t.attr(\"y\", font_size * 1.5)\r\n\t\t.text(\"\\uf10c \");\r\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\r\n\r\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size * 0.065)\r\n\t\t.attr(\"y\", -font_size * 0.065)\r\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\r\n\t\t.text(\"\\uf096 \");\r\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\r\n\r\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.6em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\r\n\t\t.attr(\"x\", font_size * 4.62)\r\n\t\t.attr(\"y\", font_size * 1.5)\r\n\t\t.text(\"\\uf106 \");\r\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\r\n\r\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.6em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\r\n\t\t.attr(\"x\", font_size * 6.4)\r\n\t\t.attr(\"y\", font_size * 1.5)\r\n\t\t.text(\"\\uf0d8 \");\r\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\r\n\r\n\tlet add_person = {};\r\n\t// click the person type selection\r\n\td3.selectAll(\".persontype\")\r\n\t\t.on(\"click\", function () {\r\n\t\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\r\n\t\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\r\n\t\t\tlet twin_type;\r\n\t\t\tlet sex;\r\n\t\t\tif (mztwin || dztwin) {\r\n\t\t\t\tsex = add_person.node.datum().data.sex;\r\n\t\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\r\n\t\t\t} else {\r\n\t\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\r\n\t\t\t}\r\n\r\n\t\t\tif (add_person.type === 'addsibling')\r\n\t\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\r\n\t\t\telse if (add_person.type === 'addchild')\r\n\t\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\r\n\t\t\telse\r\n\t\t\t\treturn;\r\n\t\t\topts.dataset = newdataset;\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t\t\tadd_person = {};\r\n\t\t})\r\n\t\t.on(\"mouseover\", function () {\r\n\t\t\tif (add_person.node)\r\n\t\t\t\tadd_person.node.select('rect').style(\"opacity\", 0.2);\r\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 1);\r\n\t\t\t// add tooltips to font awesome widgets\r\n\t\t\tif (add_person.type === 'addsibling') {\r\n\t\t\t\tif (d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t\tsquare_title.text(\"add brother\");\r\n\t\t\t\telse\r\n\t\t\t\t\tcircle_title.text(\"add sister\");\r\n\t\t\t} else if (add_person.type === 'addchild') {\r\n\t\t\t\tif (d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t\tsquare_title.text(\"add son\");\r\n\t\t\t\telse\r\n\t\t\t\t\tcircle_title.text(\"add daughter\");\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t// handle mouse out of popup selection\r\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\r\n\t\t// hide rect and popup selection\r\n\t\tif (add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) === -1)\r\n\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\r\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t});\r\n\r\n\r\n\t// drag line between nodes to create partners\r\n\tdrag_handle(opts);\r\n\r\n\t// rectangle used to highlight on mouse over\r\n\tnode.filter(function (d) {\r\n\t\treturn d.data.hidden && !opts.DEBUG ? false : true;\r\n\t})\r\n\t\t.append(\"rect\")\r\n\t\t.attr(\"class\", 'indi_rect')\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.attr(\"x\", function (_d) { return - 0.75 * opts.symbol_size; })\r\n\t\t.attr(\"y\", function (_d) { return - opts.symbol_size; })\r\n\t\t.attr(\"width\", (1.5 * opts.symbol_size) + 'px')\r\n\t\t.attr(\"height\", (2 * opts.symbol_size) + 'px')\r\n\t\t.style(\"stroke\", \"black\")\r\n\t\t.style(\"stroke-width\", 0.7)\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.attr(\"fill\", \"lightgrey\");\r\n\r\n\t// widgets\r\n\tlet fx = function (_d) { return off - (0.75 * opts.symbol_size); };\r\n\tlet fy = opts.symbol_size - 2;\r\n\tlet off = 0;\r\n\tlet widgets = {\r\n\t\t'addchild': { 'text': '\\uf063', 'title': 'add child', 'fx': fx, 'fy': fy },\r\n\r\n\t\t'addsibling': { 'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy },\r\n\t\t'addpartner': { 'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy },\r\n\t\t'addparents': {\r\n\t\t\t'text': '\\uf062', 'title': 'add parents',\r\n\t\t\t'fx': - 0.75 * opts.symbol_size,\r\n\t\t\t'fy': - opts.symbol_size + 11\r\n\t\t},\r\n\t\t'delete': {\r\n\t\t\t'text': 'X', 'title': 'delete',\r\n\t\t\t'fx': (opts.symbol_size / 2) - 1,\r\n\t\t\t'fy': - opts.symbol_size + 12,\r\n\t\t\t'styles': { \"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\" }\r\n\t\t}\r\n\t};\r\n\r\n\tif (opts.edit) {\r\n\t\twidgets.settings = { 'text': '\\uf013', 'title': 'settings', 'fx': (-font_size / 2) + 2, 'fy': -opts.symbol_size + 11 };\r\n\t}\r\n\r\n\tfor (let key in widgets) {\r\n\t\tlet widget = node.filter(function (d) {\r\n\t\t\treturn (d.data.hidden && !opts.DEBUG ? false : true) &&\r\n\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\r\n\t\t\t\t!(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\r\n\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\r\n\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\r\n\t\t})\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"class\", key)\r\n\t\t\t.style(\"opacity\", 0)\r\n\t\t\t.attr('font-family', 'FontAwesome')\r\n\t\t\t.attr(\"xx\", function (d) { return d.x; })\r\n\t\t\t.attr(\"yy\", function (d) { return d.y; })\r\n\t\t\t.attr(\"x\", widgets[key].fx)\r\n\t\t\t.attr(\"y\", widgets[key].fy)\r\n\t\t\t.attr('font-size', '0.85em')\r\n\t\t\t.text(widgets[key].text);\r\n\r\n\t\tif ('styles' in widgets[key])\r\n\t\t\tfor (let style in widgets[key].styles) {\r\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\r\n\t\t\t}\r\n\r\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\r\n\t\toff += 17;\r\n\t}\r\n\r\n\t// add sibling or child\r\n\td3.selectAll(\".addsibling, .addchild\")\r\n\t\t.on(\"mouseover\", function () {\r\n\t\t\tlet type = d3.select(this).attr('class');\r\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 1);\r\n\t\t\tadd_person = { 'node': d3.select(this.parentNode), 'type': type };\r\n\r\n\t\t\t//let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\r\n\t\t\tlet x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\r\n\t\t\tlet y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\r\n\t\t\td3.selectAll('.popup_selection').attr(\"transform\", \"translate(\" + x + \",\" + (y + 2) + \")\");\r\n\t\t\td3.selectAll('.popup_selection_rotate45')\r\n\t\t\t\t.attr(\"transform\", \"translate(\" + (x + (3 * font_size)) + \",\" + (y + (font_size * 1.2)) + \") rotate(45)\");\r\n\t\t});\r\n\r\n\t// handle widget clicks\r\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\r\n\t\t.on(\"click\", function (e) {\r\n\t\t\te.stopPropagation();\r\n\t\t\tlet opt = d3.select(this).attr('class');\r\n\t\t\tlet d = d3.select(this.parentNode).datum();\r\n\t\t\tif (opts.DEBUG) {\r\n\t\t\t\tconsole.log(opt);\r\n\t\t\t}\r\n\r\n\t\t\tlet newdataset;\r\n\t\t\tif (opt === 'settings') {\r\n\t\t\t\tif (typeof opts.edit === 'function') {\r\n\t\t\t\t\topts.edit(opts, d);\r\n\t\t\t\t} else {\r\n\t\t\t\t\topenEditDialog(opts, d);\r\n\t\t\t\t}\r\n\t\t\t} else if (opt === 'delete') {\r\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\r\n\t\t\t} else if (opt === 'addparents') {\r\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\t\topts.dataset = newdataset;\r\n\t\t\t\taddparents(opts, newdataset, d.data.name);\r\n\t\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t\t} else if (opt === 'addpartner') {\r\n\t\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\t\taddpartner(opts, newdataset, d.data.name);\r\n\t\t\t\topts.dataset = newdataset;\r\n\t\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t\t}\r\n\t\t\t// trigger fhChange event\r\n\t\t\t$(document).trigger('fhChange', [opts]);\r\n\t\t});\r\n\r\n\t// other mouse events\r\n\tlet highlight = [];\r\n\r\n\tnode.filter(function (d) { return !d.data.hidden; })\r\n\t\t.on(\"click\", function (e, d) {\r\n\t\t\tif (e.ctrlKey) {\r\n\t\t\t\tif (highlight.indexOf(d) === -1)\r\n\t\t\t\t\thighlight.push(d);\r\n\t\t\t\telse\r\n\t\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\r\n\t\t\t} else\r\n\t\t\t\thighlight = [d];\r\n\r\n\t\t\tif ('nodeclick' in opts) {\r\n\t\t\t\topts.nodeclick(d.data);\r\n\t\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\r\n\t\t\t\td3.selectAll('.indi_rect').filter(function (d) { return highlight.indexOf(d) !== -1; }).style(\"opacity\", 0.5);\r\n\t\t\t}\r\n\t\t})\r\n\t\t.on(\"mouseover\", function (e, d) {\r\n\t\t\te.stopPropagation();\r\n\t\t\tlast_mouseover = d;\r\n\t\t\tif (dragging) {\r\n\t\t\t\tif (dragging.data.name !== last_mouseover.data.name &&\r\n\t\t\t\t\tdragging.data.sex !== last_mouseover.data.sex) {\r\n\t\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\r\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\r\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\r\n\r\n\t\t\tsetLineDragPosition(opts.symbol_size - 10, 0, opts.symbol_size - 2, 0, d.x + \",\" + (d.y + 2));\r\n\t\t})\r\n\t\t.on(\"mouseout\", function (d) {\r\n\t\t\tif (dragging)\r\n\t\t\t\treturn;\r\n\r\n\t\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\r\n\t\t\tif (highlight.indexOf(d) === -1)\r\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\r\n\t\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\r\n\t\t\t// hide popup if it looks like the mouse is moving north\r\n\t\t\tlet xcoord = d3.pointer(d)[0];\r\n\t\t\tlet ycoord = d3.pointer(d)[1];\r\n\t\t\tif (ycoord < 0.8 * opts.symbol_size)\r\n\t\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t\t\tif (!dragging) {\r\n\t\t\t\t// hide popup if it looks like the mouse is moving north, south or west\r\n\t\t\t\tif (Math.abs(ycoord) > 0.25 * opts.symbol_size ||\r\n\t\t\t\t\tMath.abs(ycoord) < -0.25 * opts.symbol_size ||\r\n\t\t\t\t\txcoord < 0.2 * opts.symbol_size) {\r\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n}\r\n\r\nfunction onDone(opts, dataset) {\r\n\t// assign new dataset and rebuild pedigree\r\n\topts.dataset = dataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\n// drag line between nodes to create partners\r\nfunction drag_handle(opts) {\r\n\tlet line_drag_selection = d3.select('.diagram');\r\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\r\n\t\t.attr(\"stroke-width\", 6)\r\n\t\t.style(\"stroke-dasharray\", (\"2, 1\"))\r\n\t\t.attr(\"stroke\", \"black\")\r\n\t\t.call(d3.drag()\r\n\t\t\t.on(\"start\", dragstart)\r\n\t\t\t.on(\"drag\", drag)\r\n\t\t\t.on(\"end\", dragstop));\r\n\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\r\n\r\n\tsetLineDragPosition(0, 0, 0, 0);\r\n\r\n\tfunction dragstart() {\r\n\t\tdragging = last_mouseover;\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\", \"darkred\");\r\n\t}\r\n\r\n\tfunction dragstop(_d) {\r\n\t\tif (last_mouseover &&\r\n\t\t\tdragging.data.name !== last_mouseover.data.name &&\r\n\t\t\tdragging.data.sex !== last_mouseover.data.sex) {\r\n\t\t\t// make partners\r\n\t\t\tlet child = {\r\n\t\t\t\t\"name\": utils.makeid(4), \"sex\": 'U',\r\n\t\t\t\t\"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\r\n\t\t\t\t\"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)\r\n\t\t\t};\r\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\r\n\t\t\topts.dataset = newdataset;\r\n\r\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name) + 1;\r\n\t\t\topts.dataset.splice(idx, 0, child);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t}\r\n\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\", \"black\");\r\n\t\tdragging = undefined;\r\n\t\treturn;\r\n\t}\r\n\r\n\tfunction drag(e) {\r\n\t\te.sourceEvent.stopPropagation();\r\n\t\tlet dx = e.dx;\r\n\t\tlet dy = e.dy;\r\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2')) + dx;\r\n\t\tlet ynew = parseFloat(d3.select(this).attr('y2')) + dy;\r\n\t\tsetLineDragPosition(opts.symbol_size - 10, 0, xnew, ynew);\r\n\t}\r\n}\r\n/**\r\n * Set the position and start and end of consanguineous widget.\r\n */\r\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\r\n\tif (translate) {\r\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\" + translate + \")\");\r\n\t}\r\n\td3.selectAll('.line_drag_selection')\r\n\t\t.attr(\"x1\", x1)\r\n\t\t.attr(\"y1\", y1)\r\n\t\t.attr(\"x2\", x2)\r\n\t\t.attr(\"y2\", y2);\r\n}\r\nfunction capitaliseFirstLetter(string) {\r\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\r\nfunction openEditDialog(d) {\r\n\t// Initialize the dialog\r\n\t$('#node_properties').dialog({\r\n\t\tautoOpen: false,\r\n\t\ttitle: d.data.display_name,\r\n\t\twidth: ($(window).width() > 400 ? 450 : $(window).width() - 30),\r\n\t\tmodal: true,\r\n\t\tbuttons: {\r\n\t\t\tSave: function () {\r\n\t\t\t\t// Handle Save action here if needed\r\n\t\t\t\t$(this).dialog('close');\r\n\t\t\t},\r\n\t\t\tCancel: function () {\r\n\t\t\t\t$(this).dialog('close');\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\t// Create the table for displaying details\r\n\tlet table = \"<table id='person_details' class='table'>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value='\" +\r\n\t\t(d.data.name || \"\") + \"'></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value='\" +\r\n\t\t(d.data.display_name || \"\") + \"'></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value='\" +\r\n\t\t(d.data.age || \"\") + \"'></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value='\" +\r\n\t\t(d.data.yob || \"\") + \"'></td></tr>\";\r\n\r\n\t// Radio buttons for gender\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\r\n\t\t'<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" ' + (d.data.sex === 'M' ? \"checked\" : \"\") + '> Male</label>' +\r\n\t\t'<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" ' + (d.data.sex === 'F' ? \"checked\" : \"\") + '> Female</label>' +\r\n\t\t'<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\" ' + (d.data.sex === 'U' ? \"checked\" : \"\") + '> Unknown</label>' +\r\n\t\t'</td></tr>';\r\n\t// Radio buttons for status\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\r\n\t\t'<label class=\"radio-inline\"><input type=\"radio\" name=\"status\" value=\"0\" ' + (d.data.status == \"0\" ? \"checked\" : \"\") + '> Alive</label>' +\r\n\t\t'<label class=\"radio-inline\"><input type=\"radio\" name=\"status\" value=\"1\" ' + (d.data.status == \"1\" ? \"checked\" : \"\") + '> Deceased</label>' +\r\n\t\t'</td></tr>';\r\n\t// Pregnant checkbox (if applicable)\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_pregnant\">' +\r\n\t\t'<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"pregnant_checkbox\" ' + (d.data.pregnant ? \"checked\" : \"\") + '> Pregnant</label>' +\r\n\t\t'</td></tr>';\r\n\t// Reproduction section with checkboxes\r\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\r\n\ttable += '<tr><td colspan=\"2\"><strong>Reproduction:</strong></td></tr>';\r\n\tfor (let attr of switches) {\r\n\t\ttable += '<tr><td colspan=\"2\">' +\r\n\t\t\t'<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_' + attr + '\" ' + (d.data[attr] ? \"checked\" : \"\") + '> ' +\r\n\t\t\tattr.replace('_', ' ').replace(/^\\w/, c => c.toUpperCase()) + '</label></td></tr>';\r\n\t}\r\n\t// Age of diagnosis section (if applicable)\r\n\ttable += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\r\n\tfor (let disease in d.data.diseases) {\r\n\t\tlet age = d.data[disease + \"_diagnosis_age\"];\r\n\t\ttable += \"<tr><td style='text-align:right'>\" + disease + \"</td><td><input class='form-control' type='number' name='\" + disease + \"_diagnosis_age' value='\" + (age || \"\") + \"'></td></tr>\";\r\n\t}\r\n\t// Set the dialog content\r\n\t$('#node_properties').html(table);\r\n\t// Open the dialog\r\n\t$('#node_properties').dialog('open');\r\n}\r\n\r\n\r\n// // Helper function to capitalize the first letter\r\n// function capitaliseFirstLetter(string) {\r\n// \treturn string.charAt(0).toUpperCase() + string.slice(1);\r\n// }\r\n\r\n// Optional: Function to toggle pregnant status indication (e.g., add a 'P' inside the box when clicked)\r\nfunction togglePregnantIndicator() {\r\n\tlet isChecked = $('#pregnant_radio').is(':checked');\r\n\tif (isChecked) {\r\n\t\t$('#pregnant_radio').closest('tr').css('background-color', '#ffe6e6');  // Example of changing the background\r\n\t}\r\n}\r\n// add children to a given node\r\nexport function addchild(dataset, node, sex, nchild, twin_type) {\r\n\tconsole.log(\"Added sibling\")\r\n\tif (twin_type && $.inArray(twin_type, [\"mztwin\", \"dztwin\"]) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \" + twin_type);\r\n\r\n\tif (typeof nchild === typeof undefined)\r\n\t\tnchild = 1;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tlet ptr_name, idx;\r\n\tif (children.length === 0) {\r\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M' : 'F', node.sex === 'F');\r\n\t\tpartner.noparents = true;\r\n\t\tptr_name = partner.name;\r\n\t\tidx = utils.getIdxByName(dataset, node.name) + 1;\r\n\t} else {\r\n\t\tlet c = children[0];\r\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\r\n\t\tidx = utils.getIdxByName(dataset, c.name);\r\n\t}\r\n\r\n\tlet twin_id;\r\n\tif (twin_type)\r\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\r\n\tlet newchildren = [];\r\n\tfor (let i = 0; i < nchild; i++) {\r\n\t\tlet child = {\r\n\t\t\t\"name\": utils.makeid(4), \"sex\": sex,\r\n\t\t\t\"mother\": (node.sex === 'F' ? node.name : ptr_name),\r\n\t\t\t\"father\": (node.sex === 'F' ? ptr_name : node.name)\r\n\t\t};\r\n\t\tdataset.splice(idx, 0, child);\r\n\r\n\t\tif (twin_type)\r\n\t\t\tchild[twin_type] = twin_id;\r\n\t\tnewchildren.push(child);\r\n\t}\r\n\treturn newchildren;\r\n}\r\n\r\n//\r\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\r\n\tconsole.log(\"Added sibling\")\r\n\tif (twin_type && $.inArray(twin_type, [\"mztwin\", \"dztwin\"]) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \" + twin_type);\r\n\r\n\tlet newbie = { \"name\": utils.makeid(4), \"sex\": sex };\r\n\tif (node.top_level) {\r\n\t\tnewbie.top_level = true;\r\n\t} else {\r\n\t\tnewbie.mother = node.mother;\r\n\t\tnewbie.father = node.father;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\r\n\tif (twin_type) {\r\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\r\n\t}\r\n\r\n\tif (add_lhs) { // add to LHS\r\n\t\tif (idx > 0) idx--;\r\n\t} else\r\n\t\tidx++;\r\n\tdataset.splice(idx, 0, newbie);\r\n\treturn newbie;\r\n}\r\n\r\n// add parents to the 'node'\r\nexport function addparents(opts, dataset, name) {\r\n\tlet mother, father;\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = utils.flatten(root);\r\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\r\n\tlet node = tree_node.data;\r\n\tlet depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\r\n\r\n\tlet pid = -101;\r\n\tlet ptr_name;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tif (children.length > 0) {\r\n\t\tptr_name = children[0].mother === node.name ? children[0].father : children[0].mother;\r\n\t\tpid = utils.getNodeByName(flat_tree, ptr_name).data.id;\r\n\t}\r\n\r\n\tlet i;\r\n\tif (depth === 1) {\r\n\t\tmother = { \"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true };\r\n\t\tfather = { \"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true };\r\n\t\tdataset.splice(0, 0, mother);\r\n\t\tdataset.splice(0, 0, father);\r\n\r\n\t\tfor (i = 0; i < dataset.length; i++) {\r\n\t\t\tif ((dataset[i].top_level || utils.getDepth(dataset, dataset[i].name) === 2) &&\r\n\t\t\t\tdataset[i].name !== mother.name && dataset[i].name !== father.name) {\r\n\t\t\t\tdelete dataset[i].top_level;\r\n\t\t\t\tdataset[i].noparents = true;\r\n\t\t\t\tdataset[i].mother = mother.name;\r\n\t\t\t\tdataset[i].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet node_mother = utils.getNodeByName(flat_tree, tree_node.data.mother);\r\n\t\tlet node_father = utils.getNodeByName(flat_tree, tree_node.data.father);\r\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\r\n\r\n\t\t// lhs & rhs id's for siblings of this node\r\n\t\tlet rid = 10000;\r\n\t\tlet lid = tree_node.data.id;\r\n\t\tfor (i = 0; i < node_sibs.length; i++) {\r\n\t\t\tlet sid = utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\r\n\t\t\tif (sid < rid && sid > tree_node.data.id)\r\n\t\t\t\trid = sid;\r\n\t\t\tif (sid < lid)\r\n\t\t\t\tlid = sid;\r\n\t\t}\r\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid === lid && rid < 10000));\r\n\t\tif (opts.DEBUG)\r\n\t\t\tconsole.log('lid=' + lid + ' rid=' + rid + ' nid=' + tree_node.data.id + ' ADD_LHS=' + add_lhs);\r\n\t\tlet midx;\r\n\t\tif ((!add_lhs && node_father.data.id > node_mother.data.id) ||\r\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id))\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\r\n\t\telse\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\r\n\r\n\t\tlet parent = dataset[midx];\r\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\r\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\r\n\r\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\r\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\r\n\t\tif (faidx > moidx) {\t\t\t\t   // switch to ensure father on lhs of mother\r\n\t\t\tlet tmpfa = dataset[faidx];\r\n\t\t\tdataset[faidx] = dataset[moidx];\r\n\t\t\tdataset[moidx] = tmpfa;\r\n\t\t}\r\n\r\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\r\n\t\tlet nid = tree_node.data.id;\r\n\t\tfor (i = 0; i < orphans.length; i++) {\r\n\t\t\tlet oid = utils.getNodeByName(flat_tree, orphans[i].name).data.id;\r\n\t\t\tif (opts.DEBUG)\r\n\t\t\t\tconsole.log('ORPHAN=' + i + ' ' + orphans[i].name + ' ' + (nid < oid && oid < rid) + ' nid=' + nid + ' oid=' + oid + ' rid=' + rid);\r\n\t\t\tif ((add_lhs || nid < oid) && oid < rid) {\r\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\r\n\t\t\t\tdataset[oidx].mother = mother.name;\r\n\t\t\t\tdataset[oidx].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (depth === 2) {\r\n\t\tmother.top_level = true;\r\n\t\tfather.top_level = true;\r\n\t} else if (depth > 2) {\r\n\t\tmother.noparents = true;\r\n\t\tfather.noparents = true;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\tdataset[idx].mother = mother.name;\r\n\tdataset[idx].father = father.name;\r\n\tdelete dataset[idx].noparents;\r\n\r\n\tif ('parent_node' in node) {\r\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\r\n\t\tif ('noparents' in ptr_node) {\r\n\t\t\tptr_node.mother = mother.name;\r\n\t\t\tptr_node.father = father.name;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// add partner\r\nexport function addpartner(opts, dataset, name) {\r\n\tconsole.log(\"Added sibling\")\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = utils.flatten(root);\r\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\r\n\r\n\tlet partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\r\n\tpartner.noparents = true;\r\n\r\n\tlet child = { \"name\": utils.makeid(4), \"sex\": \"M\" };\r\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\r\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\r\n\r\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name) + 2;\r\n\tdataset.splice(idx, 0, child);\r\n}\r\n\r\n// get adjacent nodes at the same depth\r\nfunction adjacent_nodes(root, node, excludes) {\r\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\r\n\tlet lhs_node, rhs_node;\r\n\tfor (let i = 0; i < dnodes.length; i++) {\r\n\t\tif (dnodes[i].x < node.x)\r\n\t\t\tlhs_node = dnodes[i];\r\n\t\tif (!rhs_node && dnodes[i].x > node.x)\r\n\t\t\trhs_node = dnodes[i];\r\n\t}\r\n\treturn [lhs_node, rhs_node];\r\n}\r\n\r\n// delete a node and descendants\r\nexport function delete_node_dataset(dataset, node, opts, onDone) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet fnodes = utils.flatten(root);\r\n\tlet deletes = [];\r\n\tlet i, j;\r\n\r\n\t// get d3 data node\r\n\tif (node.id === undefined) {\r\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\r\n\t\tif (d3node !== undefined)\r\n\t\t\tnode = d3node.data;\r\n\t}\r\n\r\n\tif (node.parent_node) {\r\n\t\tfor (i = 0; i < node.parent_node.length; i++) {\r\n\t\t\tlet parent = node.parent_node[i];\r\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\r\n\t\t\tutils.getNodeByName(dataset, parent.father.name)];\r\n\t\t\t// delete parents\r\n\t\t\tfor (j = 0; j < ps.length; j++) {\r\n\t\t\t\tif (ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\r\n\t\t\t\t\tdeletes.push(ps[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet children = parent.children;\r\n\t\t\tlet children_names = $.map(children, function (p, _i) { return p.name; });\r\n\t\t\tfor (j = 0; j < children.length; j++) {\r\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\r\n\t\t\t\tif (child) {\r\n\t\t\t\t\tchild.noparents = true;\r\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\r\n\t\t\t\t\tlet ptr;\r\n\t\t\t\t\tif (ptrs.length > 0)\r\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\r\n\t\t\t\t\tif (ptr && ptr.mother !== child.mother) {\r\n\t\t\t\t\t\tchild.mother = ptr.mother;\r\n\t\t\t\t\t\tchild.father = ptr.father;\r\n\t\t\t\t\t} else if (ptr) {\r\n\t\t\t\t\t\tlet child_node = utils.getNodeByName(fnodes, child.name);\r\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\r\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\r\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tdataset.splice(utils.getIdxByName(dataset, node.name), 1);\r\n\t}\r\n\r\n\t// delete ancestors\r\n\tconsole.log(deletes);\r\n\tfor (i = 0; i < deletes.length; i++) {\r\n\t\tlet del = deletes[i];\r\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\r\n\t\tconsole.log('DEL', del.name, sibs);\r\n\t\tif (sibs.length < 1) {\r\n\t\t\tconsole.log('del sibs', del.name, sibs);\r\n\t\t\tlet data_node = utils.getNodeByName(fnodes, del.name);\r\n\t\t\tlet ancestors = data_node.ancestors();\r\n\t\t\tfor (j = 0; j < ancestors.length; j++) {\r\n\t\t\t\tconsole.log(ancestors[i]);\r\n\t\t\t\tif (ancestors[j].data.mother) {\r\n\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.father.name), 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// check integrity of mztwins settings\r\n\tcheckTwins(dataset);\r\n\r\n\tlet uc;\r\n\ttry {\r\n\t\t// validate new pedigree dataset\r\n\t\tlet newopts = $.extend({}, opts);\r\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\r\n\t\tutils.validate_pedigree(newopts);\r\n\t\t// check if pedigree is split\r\n\t\tuc = utils.unconnected(dataset);\r\n\t} catch (err) {\r\n\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\r\n\t\tthrow err;\r\n\t}\r\n\tif (uc.length > 0) {\r\n\t\t// check & warn only if this is a new split\r\n\t\tif (utils.unconnected(opts.dataset).length === 0) {\r\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\r\n\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\tif (onDone) {\r\n\t\tonDone(opts, dataset);\r\n\t}\r\n\treturn dataset;\r\n}\r\n\r\n","\r\nimport * as utils from './utils.js';\r\nimport * as pbuttons from './pbuttons.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport * as io from './io.js';\r\nimport { addWidgets } from './widgets.js';\r\nimport { init_zoom } from './zoom.js';\r\nimport { addLabels } from './labels.js';\r\nimport { init_dragging } from './dragging.js';\r\n\r\nfunction build(options) {\r\n\tlet opts = $.extend({\r\n\t\ttargetDiv: 'pedigree_edit',\r\n\t\tdataset: [{ \"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true },\r\n\t\t{ \"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true },\r\n\t\t{ \"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true }],\r\n\t\twidth: 500,\r\n\t\theight: 800,\r\n\t\tsymbol_size: 35,\r\n\t\tzoomSrc: ['wheel', 'button'],\r\n\t\tzoomIn: 1.0,\r\n\t\tzoomOut: 1.0,\r\n\t\tdragNode: true,\r\n\t\tshowWidgets: true,\r\n\t\tdiseases: [\r\n\t\t\t{ 'type': 'breast_cancer', 'pattern': 'dots' },\r\n\t\t\t{ 'type': 'ovarian_cancer', 'pattern': 'stripes' },\r\n\t\t\t{ 'type': 'pancreatic_cancer', 'pattern': 'dots' },\r\n\t\t\t{ 'type': 'prostate_cancer', 'pattern': 'crosshatch' }\r\n\t\t],\r\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\r\n\t\t\t['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\r\n\t\t\t['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\r\n\t\t\t['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\r\n\t\tkeep_proband_on_reset: false,\r\n\t\tfont_size: '.75em',\r\n\t\tfont_family: 'Helvetica',\r\n\t\tfont_weight: 700,\r\n\t\tbackground: \"#FAFAFA\",\r\n\t\tnode_background: '#fdfdfd',\r\n\t\tvalidate: true,\r\n\t\tDEBUG: false\r\n\t}, options);\r\n\r\n\t// Adding SVG patterns for dots or other textures\r\n\tlet svgDefs = `\r\n\t<defs>\r\n\t\t<pattern id=\"dots\" patternUnits=\"userSpaceOnUse\" width=\"10\" height=\"10\">\r\n\t\t\t<circle cx=\"2\" cy=\"2\" r=\"2\" fill=\"black\" />\r\n\t\t</pattern>\r\n\t\t<pattern id=\"stripes\" patternUnits=\"userSpaceOnUse\" width=\"4\" height=\"4\">\r\n\t\t\t<rect width=\"2\" height=\"4\" fill=\"black\"></rect>\r\n\t\t</pattern>\r\n\t\t<pattern id=\"crosshatch\" patternUnits=\"userSpaceOnUse\" width=\"10\" height=\"10\">\r\n\t\t\t<path d=\"M0,0 L10,10 M10,0 L0,10\" stroke=\"black\" stroke-width=\"1\" />\r\n\t\t</pattern>\r\n\t</defs>`;\r\n\r\n\t// Append SVG patterns to your target div\r\n\t$(`#${opts.targetDiv}`).append(`<svg width=\"0\" height=\"0\">${svgDefs}</svg>`);\r\n\r\n\t// Example rendering nodes\r\n\tfor (let i = 0; i < opts.dataset.length; i++) {\r\n\t\tlet person = opts.dataset[i];\r\n\r\n\t\t// Create each person's box (for simplicity, using a div here; you may need SVG or canvas)\r\n\t\tlet $personBox = $('<div></div>')\r\n\t\t\t.addClass('person-box')\r\n\t\t\t.css({\r\n\t\t\t\twidth: opts.symbol_size + 'px',\r\n\t\t\t\theight: opts.symbol_size + 'px',\r\n\t\t\t\tbackgroundColor: opts.node_background, // default background\r\n\t\t\t\tborder: '1px solid #000'\r\n\t\t\t});\r\n\r\n\t\t// Add pattern to the box based on the disease type\r\n\t\tfor (let disease of opts.diseases) {\r\n\t\t\tif (person[disease.type]) { // If person has this disease\r\n\t\t\t\t// Apply the pattern as the background\r\n\t\t\t\t$personBox.css('background', `url(#${disease.pattern})`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Append the box to the target div\r\n\t\t$(`#${opts.targetDiv}`).append($personBox);\r\n\t}\r\n\r\n\t// Initialize buttons and IO handling if not already initialized\r\n\tif ($(\"#fullscreen\").length === 0) {\r\n\t\tpbuttons.addButtons(opts, rebuild, build);\r\n\t\tio.addIO(opts);\r\n\t}\r\n}\r\n\r\n\r\nfunction has_gender(sex) {\r\n\treturn sex === \"M\" || sex === \"F\";\r\n}\r\n\r\n//adopted in/out brackets\r\nfunction get_bracket(dx, dy, indent, opts) {\r\n\treturn \"M\" + (dx + indent) + \",\" + dy +\r\n\t\t\"L\" + dx + \" \" + dy +\r\n\t\t\"L\" + dx + \" \" + (dy + (opts.symbol_size * 1.28)) +\r\n\t\t\"L\" + dx + \" \" + (dy + (opts.symbol_size * 1.28)) +\r\n\t\t\"L\" + (dx + indent) + \",\" + (dy + (opts.symbol_size * 1.28))\r\n}\r\n\r\n// check for crossing of partner lines\r\nfunction check_ptr_links(opts, ptrLinkNodes) {\r\n\tfor (let a = 0; a < ptrLinkNodes.length; a++) {\r\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\r\n\t\tif (clash)\r\n\t\t\tconsole.log(\"CLASH :: \" + ptrLinkNodes[a].mother.data.name + \" \" + ptrLinkNodes[a].father.data.name, clash);\r\n\t}\r\n}\r\n\r\nexport function check_ptr_link_clashes(opts, anode) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flattenNodes = utils.flatten(root);\r\n\tlet mother, father;\r\n\tif ('name' in anode) {\r\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\r\n\t\tif (!('mother' in anode.data))\r\n\t\t\treturn null;\r\n\t\tmother = utils.getNodeByName(flattenNodes, anode.data.mother);\r\n\t\tfather = utils.getNodeByName(flattenNodes, anode.data.father);\r\n\t} else {\r\n\t\tmother = anode.mother;\r\n\t\tfather = anode.father;\r\n\t}\r\n\r\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\r\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\r\n\tlet dy = mother.y;\r\n\r\n\t// identify clashes with other nodes at the same depth\r\n\tlet clash = $.map(flattenNodes, function (bnode, _i) {\r\n\t\treturn !bnode.data.hidden &&\r\n\t\t\tbnode.data.name !== mother.data.name && bnode.data.name !== father.data.name &&\r\n\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\r\n\t});\r\n\treturn clash.length > 0 ? clash : null;\r\n}\r\n\r\n// group top_level nodes by their partners\r\nfunction group_top_level(dataset) {\r\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\r\n\t// calculate top_level nodes\r\n\tfor (let i = 0; i < dataset.length; i++) {\r\n\t\tif (utils.getDepth(dataset, dataset[i].name) === 2)\r\n\t\t\tdataset[i].top_level = true;\r\n\t}\r\n\r\n\tlet top_level = [];\r\n\tlet top_level_seen = [];\r\n\tfor (let i = 0; i < dataset.length; i++) {\r\n\t\tlet node = dataset[i];\r\n\t\tif ('top_level' in node && $.inArray(node.name, top_level_seen) === -1) {\r\n\t\t\ttop_level_seen.push(node.name);\r\n\t\t\ttop_level.push(node);\r\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\r\n\t\t\tfor (let j = 0; j < ptrs.length; j++) {\r\n\t\t\t\tif ($.inArray(ptrs[j], top_level_seen) === -1) {\r\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\r\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tlet newdataset = $.map(dataset, function (val, _i) { return 'top_level' in val && val.top_level ? null : val; });\r\n\tfor (let i = top_level.length; i > 0; --i)\r\n\t\tnewdataset.unshift(top_level[i - 1]);\r\n\treturn newdataset;\r\n}\r\n\r\nexport function rebuild(opts) {\r\n\t$(\"#\" + opts.targetDiv).empty();\r\n\tpedcache.init_cache(opts);\r\n\ttry {\r\n\t\tbuild(opts);\r\n\t} catch (e) {\r\n\t\tconsole.error(e);\r\n\t\tthrow e;\r\n\t}\r\n\r\n\ttry {\r\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\r\n\t} catch (e) {\r\n\t\t// templates not declared\r\n\t}\r\n}\r\n\r\n$(document).on('rebuild', function (_e, opts) {\r\n\trebuild(opts);\r\n})\r\n\r\n$(document).on('build', function (_e, opts) {\r\n\tbuild(opts);\r\n})\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree form\r\nimport { syncTwins } from './twins.js';\r\nimport { copy_dataset, getNodeByName } from './utils.js';\r\nimport { current as pedcache_current } from './pedcache.js';\r\n\r\n\r\n// handle family history change events (undo/redo/delete)\r\n$(document).on('fhChange', function (e, opts) {\r\n\ttry {\r\n\t\tlet id = $('#id_name').val();  // get name from hidden field\r\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\r\n\t\tif (node === undefined)\r\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\r\n\t\telse\r\n\t\t\t$('form > fieldset').prop('disabled', false);\r\n\t} catch (err) {\r\n\t\tconsole.warn(err);\r\n\t}\r\n})\r\n\r\n// update status field and age label - 0 = alive, 1 = dead\r\nexport function updateStatus(status) {\r\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\r\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\r\n\t$('#id_age_' + status).removeClass(\"hidden\");\r\n\t$('#id_age_' + (status === \"1\" ? '0' : '1')).addClass(\"hidden\");\r\n}\r\n\r\nexport function nodeclick(node) {\r\n\t$('form > fieldset').prop('disabled', false);\r\n\t// clear values\r\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\r\n\t$('#person_details select').val('').prop('selected', true);\r\n\r\n\tif (node.sex === 'M' || node.sex === 'F')\r\n\t\t$('input[name=sex][value=\"' + node.sex + '\"]').prop('checked', true);\r\n\telse\r\n\t\t$('input[name=sex]').prop('checked', false);\r\n\tupdate_cancer_by_sex(node);\r\n\r\n\tif (!('status' in node))\r\n\t\tnode.status = 0;\r\n\t$('input[name=status][value=\"' + node.status + '\"]').prop('checked', true);\r\n\tupdateStatus(node.status);\r\n\r\n\tif ('proband' in node) {\r\n\t\t$('#id_proband').prop('checked', node.proband);\r\n\t\t$('#id_proband').prop(\"disabled\", true);\r\n\t} else {\r\n\t\t$('#id_proband').prop('checked', false);\r\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\r\n\t}\r\n\r\n\tif ('exclude' in node) {\r\n\t\t$('#id_exclude').prop('checked', node.exclude);\r\n\t} else {\r\n\t\t$('#id_exclude').prop('checked', false);\r\n\t}\r\n\r\n\tif ('yob' in node) {\r\n\t\t$('#id_yob_0').val(node.yob);\r\n\t} else {\r\n\t\t$('#id_yob_0').val('-');\r\n\t}\r\n\r\n\t// clear pathology\r\n\t$('select[name$=\"_bc_pathology\"]').val('-');\r\n\t// clear gene tests\r\n\t$('select[name*=\"_gene_test\"]').val('-');\r\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\r\n\r\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\r\n\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\r\n\r\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true : false));\r\n\tupdate_diagnosis_age_widget();\r\n\r\n\tfor (let key in node) {\r\n\t\tif (key !== 'proband' && key !== 'sex') {\r\n\t\t\tif ($('#id_' + key).length) {\r\n\t\t\t\tif (key.indexOf('_gene_test') !== -1 && node[key] !== null && typeof node[key] === 'object') {\r\n\t\t\t\t\t$('#id_' + key).val(node[key].type);\r\n\t\t\t\t\t$('#id_' + key + '_result').val(node[key].result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_' + key).val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t} else if (key.indexOf('_diagnosis_age') !== -1) {\r\n\t\t\t\tif ($(\"#id_approx\").is(':checked')) {\r\n\t\t\t\t\t$('#id_' + key + '_1').val(round5(node[key])).prop('selected', true);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_' + key + '_0').val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch (err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n}\r\n\r\nfunction update_ashkn(newdataset) {\r\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\tif ($('#orig_ashk').is(':checked')) {\r\n\t\t$.each(newdataset, function (_i, p) {\r\n\t\t\tif (p.proband)\r\n\t\t\t\tp.ashkenazi = 1;\r\n\t\t});\r\n\t} else {\r\n\t\t$.each(newdataset, function (_i, p) {\r\n\t\t\tdelete p.ashkenazi;\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Save Ashkenazi status\r\nexport function save_ashkn(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet newdataset = copy_dataset(dataset);\r\n\tupdate_ashkn(newdataset);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function save(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet name = $('#id_name').val();\r\n\tlet newdataset = copy_dataset(dataset);\r\n\tlet person = getNodeByName(newdataset, name);\r\n\tif (!person) {\r\n\t\tconsole.warn('person not found when saving details');\r\n\t\treturn;\r\n\t}\r\n\t$(\"#\" + opts.targetDiv).empty();\r\n\tlet yob = $('#id_yob_0').val();\r\n\tif (yob && yob !== '') {\r\n\t\tperson.yob = yob;\r\n\t} else {\r\n\t\tdelete person.yob;\r\n\t}\r\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\r\n\tif (status.length > 0) {\r\n\t\tperson.status = status.val();\r\n\t}\r\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\r\n\tfor (let iswitch = 0; iswitch < switches.length; iswitch++) {\r\n\t\tlet attr = switches[iswitch];\r\n\t\tlet s = $('#id_' + attr);\r\n\t\tif (s.length > 0) {\r\n\t\t\tconsole.log(s.is(\":checked\"));\r\n\t\t\tif (s.is(\":checked\"))\r\n\t\t\t\tperson[attr] = true;\r\n\t\t\telse\r\n\t\t\t\tdelete person[attr];\r\n\t\t}\r\n\t}\r\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\r\n\tif (sex.length > 0) {\r\n\t\tperson.sex = sex.val();\r\n\t\tupdate_cancer_by_sex(person);\r\n\t}\r\n\tupdate_ashkn(newdataset);\r\n\tif ($('#id_approx').is(':checked'))\r\n\t\tperson.approx_diagnosis_age = true;\r\n\telse\r\n\t\tdelete person.approx_diagnosis_age;\r\n\r\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function () {\r\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\") > -1 ? this.name.substring(0, this.name.length - 2) : this.name);\r\n\r\n\t\tif ($(this).val()) {\r\n\t\t\tlet val = $(this).val();\r\n\t\t\tif (name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\r\n\t\t\t\tval = round5(val);\r\n\t\t\tperson[name] = val;\r\n\t\t} else {\r\n\t\t\tdelete person[name];\r\n\t\t}\r\n\t});\r\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function () {\r\n\t\tif (this.checked)\r\n\t\t\tperson[$(this).attr('name')] = true;\r\n\t\telse\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t});\r\n\r\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function () {\r\n\t\tif ($(this).val() !== '-') {\r\n\t\t\tperson[$(this).attr('name')] = $(this).val();\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\t$('#person_details select[name$=\"_gene_test\"]').each(function () {\r\n\t\tif ($(this).val() !== '-') {\r\n\t\t\tlet tres = $('select[name=\"' + $(this).attr('name') + '_result\"]');\r\n\t\t\tperson[$(this).attr('name')] = { 'type': $(this).val(), 'result': $(tres).val() };\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\r\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\r\n\tif (hoxb13_result !== undefined && hoxb13_result !== '-') {\r\n\t\tperson[\"hoxb13_gene_test\"] = { 'type': 'T', 'result': hoxb13_result };\r\n\t} else {\r\n\t\tdelete person[\"hoxb13_gene_test\"];\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch (err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n\r\n\tsyncTwins(newdataset, person);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function update_diagnosis_age_widget() {\r\n\tif ($(\"#id_approx\").is(':checked')) {\r\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function (_i) {\r\n\t\t\tif ($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length - 2);\r\n\t\t\t\t$(\"#id_\" + name + \"_1\").val(round5($(this).val())).prop('selected', true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\r\n\t} else {\r\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function (_i) {\r\n\t\t\tif ($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length - 2);\r\n\t\t\t\t$(\"#id_\" + name + \"_0\").val($(this).val());\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\r\n\t}\r\n}\r\n\r\nfunction update_cancer_by_sex(node) {\r\n\t$('#cancer .row').show();\r\n\tif (node.sex === 'M') {\r\n\t\tdelete node.ovarian_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\r\n\t} else if (node.sex === 'F') {\r\n\t\tdelete node.prostate_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\r\n\t}\r\n}\r\n\r\n// round to 5, 15, 25, 35 ....\r\nfunction round5(x1) {\r\n\tlet x2 = (Math.round((x1 - 1) / 10) * 10);\r\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\r\n}","/**\r\n/* Functions used by 3rd party apps\r\n/*\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\r\nimport {rebuild} from './pedigree.js';\r\nimport {delete_node_dataset} from './widgets.js';\r\nimport {addchild} from './widgets.js';\r\nimport {syncTwins} from './twins.js';\r\nimport * as pedcache from './pedcache.js';\r\n\r\n\r\n// Set or remove node attributes.\r\n// If a value is not provided the attribute is removed.\r\n// 'key' can be a list of keys or a single key.\r\nexport function node_attr(opts, name, keys, value){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(newdataset, name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No person defined\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tif(!$.isArray(keys)) {\r\n\t\tkeys = [keys];\r\n\t}\r\n\r\n\tif(value) {\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\r\n\t\t\tif(k in node && keys.length === 1) {\r\n\t\t\t\tif(node[k] === value)\r\n\t\t\t\t\treturn;\r\n\t\t\t\ttry {\r\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\r\n\t\t\t\t\t   return;\r\n\t\t\t\t} catch(e){\r\n\t\t\t\t\t// continue regardless of error\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnode[k] = value;\r\n\t\t}\r\n\t} else {\r\n\t\tlet found = false;\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\r\n\t\t\tif(k in node) {\r\n\t\t\t\tdelete node[k];\r\n\t\t\t\tfound = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!found)\r\n\t\t\treturn;\r\n\t}\r\n\tsyncTwins(newdataset, node);\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n}\r\n\r\n// Set or remove proband attributes.\r\n// If a value is not provided the attribute is removed from the proband.\r\n// 'key' can be a list of keys or a single key.\r\nexport function proband_attr(opts, keys, value){\r\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\r\n\tnode_attr(opts, proband.name, keys, value);\r\n}\r\n\r\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\r\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\r\n\tif(!proband){\r\n\t\tconsole.warn(\"No proband defined\");\r\n\t\treturn;\r\n\t}\r\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\r\n\tnewchild.age = age;\r\n\tnewchild.yob = yob;\r\n\tif(breastfeeding !== undefined)\r\n\t\tnewchild.breastfeeding = breastfeeding;\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n\treturn newchild.name;\r\n}\r\n\r\n// delete node using the name\r\nexport function delete_node_by_name(opts, name){\r\n\tfunction onDone(opts, dataset) {\r\n\t\t// assign new dataset and rebuild pedigree\r\n\t\topts.dataset = dataset;\r\n\t\trebuild(opts);\r\n\t}\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(pedcache.current(opts), name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No node defined\");\r\n\t\treturn;\r\n\t}\r\n\tdelete_node_dataset(newdataset, node, opts, onDone);\r\n}\r\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","nst","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","roots","isIE","ua","navigator","userAgent","isEdge","match","create_err","err","error","Error","validate_pedigree","validate","DEBUG","log","call","this","display_name","uniquenames","famids","p","hidden","mother","father","midx","getIdxByName","fidx","sex","$","inArray","famid","join","uc","unconnected","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","makeid","len","possible","charAt","Math","floor","random","updateParent","parent","nodes","parent_node","mztwin","dztwins","twins","getTwins","twin","getNodeByName","setChildrenId","children","dztwin","each","_i","isProband","attr","combineArrays","arr1","arr2","include_children","connected","get_partners","getAllChildren","_child_idx","child","anode","ptrs","bnode","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","getChildren","person","sibs","getSiblings","twin_type","getAllSiblings","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","ancestors","node","recurse","flatten","root","flat","forEach","overlap","xnew","n","abs","symbol_size","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","flattenNodes","xmid","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","buildTree","partnerLinks","partners","_j","m","f","contains_parent","merge","ptr","gp","gmidx","gfidx","get_grandparents_idx","string","toUpperCase","slice","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","consanguity","_index","pedcache","time","d","Date","getHours","getMinutes","getSeconds","getFullYear","getMonth","getDate","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","links","found","k","_n","remove","append","is_proband","results","RegExp","exec","location","href","age","yob","status","year","sum","zm","btn_zoom","scale","d3","select","targetDiv","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","svg","size","w","clientWidth","h","clientHeight","get_svg_size","max","zoomIn","scaleExtent","zoomOut","ped","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","xi","yi","filter","zoomSrc","type","button","transform","t","zooming","xyk","zoomIdentity","translate","addButtons","options","extend","btns","fa","lis","_e","local_dataset","trigger","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","reset","addPbuttonEvents","keep_proband_on_reset","selected","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","trim","isEmpty","myObj","prototype","hasOwnProperty","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","unshift","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","arguments","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","event","utils","code","readAsText","value","load","content","save_file","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","cd","childNodes","tagName","style","currentStyle","getComputedStyle","st","setProperty","getPropertyValue","resolution","img_type","deferred","svg2img","find","when","apply","done","grep","html","img","open","write","createElement","download","body","appendChild","removeChild","deferred_name","defaults","iscanvg","copy","get","cloneNode","Deferred","svgStr","XMLSerializer","serializeToString","imgsrc","btoa","unescape","encodeURIComponent","canvas","context","getContext","fillStyle","fillRect","drawImage","resolve","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","constructor","Array","screen","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","d3obj","getUniqueTwinID","mz","splice","syncTwins","d1","d2","dragging","last_mouseover","onDone","setLineDragPosition","x1","y1","x2","y2","addchild","nchild","ptr_name","twin_id","partner","addsibling","newchildren","add_lhs","newbie","setMzTwin","addparents","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","addpartner","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","delete_node_dataset","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts","popup_selection","square_title","circle_title","add_person","pedcache_current","classed","datum","highlight","dragstart","dragstop","_d","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","Save","Cancel","table","pregnant","switches","disease","diseases","openEditDialog","ctrlKey","nodeclick","xcoord","pointer","ycoord","build","dragNode","showWidgets","pattern","labels","font_weight","background","node_background","$personBox","backgroundColor","border","pbuttons","io","rebuild","templates","update","clash","updateStatus","update_ashkn","is","update_diagnosis_age_widget","substring","round5","prop","hide","show","update_cancer_by_sex","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","round","approx_diagnosis_age","valid","iswitch","checked","tres","hoxb13_result","node_attr","isArray","breastfeeding","newchild"],"mappings":"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"}